<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .tasks-wrap { display: grid; grid-template-columns: 260px 1fr; gap: 20px; min-height: calc(100vh - 120px); }
    /* Sidebar */
    .t-sidebar { display: flex; flex-direction: column; gap: 2px; }
    .t-filter { display: flex; align-items: center; gap: 10px; padding: 9px 14px; border-radius: 8px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-muted); width: 100%; text-align: left; transition: all .12s; }
    .t-filter:hover { background: var(--surface2); color: var(--text-primary); }
    .t-filter.active { background: var(--primary); color: white; }
    .t-filter .cnt { margin-left: auto; font-size: 11px; background: rgba(0,0,0,.1); border-radius: 10px; padding: 1px 6px; }
    .t-filter.active .cnt { background: rgba(255,255,255,.25); }
    .t-sep { height: 1px; background: var(--border); margin: 8px 4px; }
    .t-section-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; color: var(--text-muted); padding: 6px 14px 2px; }
    /* Task list */
    .t-list { display: flex; flex-direction: column; gap: 8px; }
    .t-card { background: white; border: 1.5px solid var(--border); border-radius: 12px; padding: 14px 16px; cursor: pointer; transition: all .15s; }
    .t-card:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,58,92,.08); }
    .t-card.selected { border-color: var(--primary); background: #f0f6ff; }
    .t-card.completed { opacity: .6; }
    .tc-top { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
    .tc-title { font-size: 14px; font-weight: 700; color: var(--text-primary); flex: 1; line-height: 1.4; }
    .tc-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); }
    .pri-pill { padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .pp-urgent { background: #fee2e2; color: #dc2626; }
    .pp-high { background: #fef3c7; color: #b45309; }
    .pp-normal { background: #dbeafe; color: #1d4ed8; }
    .pp-low { background: #f3f4f6; color: #6b7280; }
    .status-chip { padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .sc-open { background: #fef3c7; color: #b45309; }
    .sc-in_progress { background: #dbeafe; color: #1d4ed8; }
    .sc-completed { background: #dcfce7; color: #166534; }
    .sc-cancelled { background: #f3f4f6; color: #6b7280; }
    /* Detail panel */
    .t-detail { background: white; border: 1.5px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; position: sticky; top: 20px; max-height: calc(100vh - 140px); }
    .td-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); }
    .td-title { font-size: 17px; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; line-height: 1.3; }
    .td-chips { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .td-who { font-size: 12px; color: var(--text-muted); margin-top: 10px; display: flex; gap: 16px; }
    .td-body { padding: 16px 24px; flex: 1; overflow-y: auto; }
    .td-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.7; background: var(--surface2); border-radius: 8px; padding: 12px 14px; margin-bottom: 18px; }
    .comments-head { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-muted); margin-bottom: 14px; }
    .cmt { display: flex; gap: 10px; margin-bottom: 14px; }
    .cmt-av { width: 28px; height: 28px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; flex-shrink: 0; }
    .cmt-bubble { background: var(--surface2); border-radius: 10px; padding: 9px 13px; flex: 1; }
    .cmt-author { font-size: 12px; font-weight: 700; }
    .cmt-time { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
    .cmt-text { font-size: 13px; color: var(--text-secondary); margin-top: 3px; line-height: 1.5; }
    .td-input { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
    .cmt-inp { flex: 1; padding: 9px 13px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 13px; font-family: inherit; resize: none; outline: none; transition: border .15s; }
    .cmt-inp:focus { border-color: var(--primary); }
    .t-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .t-empty .ei { font-size: 36px; margin-bottom: 12px; }
    .status-sel { padding: 5px 10px; border-radius: 8px; border: 1.5px solid var(--border); font-size: 12px; font-weight: 600; outline: none; cursor: pointer; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">Task</div>
        <div class="topbar-subtitle" id="task-count">‚Äî</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-accent" onclick="openNewTask()">+ Nuova Task</button>
      </div>
    </div>

    <div class="page-content">
      <div class="tasks-wrap">

        <!-- Left: filters + list -->
        <div>
          <div class="t-sidebar card" style="padding:10px;margin-bottom:16px">
            <div class="t-section-label">Vista</div>
            <button class="t-filter active" data-f="all" onclick="setFilter('all',this)">üìã Tutte <span class="cnt" id="cnt-all">0</span></button>
            <button class="t-filter" data-f="mine" onclick="setFilter('mine',this)">üë§ Mie <span class="cnt" id="cnt-mine">0</span></button>
            <div class="t-sep"></div>
            <div class="t-section-label">Stato</div>
            <button class="t-filter" data-f="open" onclick="setFilter('open',this)">üü° Aperte <span class="cnt" id="cnt-open">0</span></button>
            <button class="t-filter" data-f="in_progress" onclick="setFilter('in_progress',this)">üîµ In corso <span class="cnt" id="cnt-in_progress">0</span></button>
            <button class="t-filter" data-f="completed" onclick="setFilter('completed',this)">‚úÖ Completate <span class="cnt" id="cnt-completed">0</span></button>
            <div class="t-sep"></div>
            <div class="t-section-label">Categoria</div>
            <button class="t-filter" data-f="vat" onclick="setFilter('vat',this)">‚óá VAT</button>
            <button class="t-filter" data-f="corporate_tax" onclick="setFilter('corporate_tax',this)">‚óà Corporate Tax</button>
            <button class="t-filter" data-f="onboarding" onclick="setFilter('onboarding',this)">‚ú¶ Onboarding</button>
            <button class="t-filter" data-f="estratti" onclick="setFilter('estratti',this)">‚óé Estratti</button>
            <button class="t-filter" data-f="pagamenti" onclick="setFilter('pagamenti',this)">‚óÜ Pagamenti</button>
          </div>
          <div id="t-list"></div>
        </div>

        <!-- Right: detail -->
        <div>
          <div id="t-detail" class="t-detail" style="align-items:center;justify-content:center">
            <div style="text-align:center;padding:40px;color:var(--text-muted)">
              <div style="font-size:32px;margin-bottom:12px">üìã</div>
              <div style="font-size:14px;font-weight:600">Seleziona una task</div>
              <div style="font-size:12px;margin-top:4px">Clicca su una task per vedere i dettagli</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal nuova task -->
<div class="modal-overlay" id="modal-task" style="display:none">
  <div class="modal" style="max-width:540px">
    <div class="modal-header">
      <div class="modal-title">‚úì Nuova Task</div>
      <button class="btn btn-ghost btn-sm" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Titolo *</label>
        <input type="text" class="form-control" id="t-title" placeholder="Descrivi la task...">
      </div>
      <div class="form-group">
        <label class="form-label">Descrizione</label>
        <textarea class="form-control" id="t-desc" rows="2" placeholder="Dettagli..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Assegna a</label>
          <select class="form-control" id="t-assigned"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Cliente</label>
          <select class="form-control" id="t-client">
            <option value="">‚Äî Nessuno ‚Äî</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Priorit√†</label>
          <select class="form-control" id="t-priority">
            <option value="normal">Normale</option>
            <option value="high">Alta</option>
            <option value="urgent">Urgente</option>
            <option value="low">Bassa</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select class="form-control" id="t-category">
            <option value="generale">Generale</option>
            <option value="vat">VAT</option>
            <option value="corporate_tax">Corporate Tax</option>
            <option value="onboarding">Onboarding</option>
            <option value="estratti">Estratti</option>
            <option value="pagamenti">Pagamenti</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Scadenza</label>
          <input type="date" class="form-control" id="t-due">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Annulla</button>
      <button class="btn btn-accent" id="btn-save" onclick="saveTask()">Crea Task</button>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let allTasks = [], currentFilter = 'all', selectedId = null, myId = null, profiles = [];

async function init() {
  await sb.requireAuth();
  myId = sb.getCurrentProfile()?.id;
  // Pre-fill client from URL param
  const params = new URLSearchParams(window.location.search);
  const preClient = params.get('client');
  const preFilter = params.get('filter');
  if (preFilter) currentFilter = preFilter;
  await loadProfiles();
  if (preClient) document.getElementById('t-client').value = preClient;
  await loadTasks();
  if (preFilter) {
    document.querySelectorAll('.t-filter').forEach(b => {
      b.classList.toggle('active', b.dataset.f === preFilter);
    });
  }
}

async function loadProfiles() {
  profiles = await sb.db.select('profiles', {columns:'id,full_name'}) || [];
  const sel = document.getElementById('t-assigned');
  sel.innerHTML = '<option value="">‚Äî Nessuno ‚Äî</option>';
  profiles.forEach(p => sel.insertAdjacentHTML('beforeend', `<option value="${p.id}">${ui.escapeHtml(p.full_name)}</option>`));
  const clients = await sb.db.select('clients', {columns:'id,company_name',filter:'is_active=eq.true',order:'company_name.asc'}) || [];
  const csel = document.getElementById('t-client');
  clients.forEach(c => csel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${ui.escapeHtml(c.company_name)}</option>`));
}

async function loadTasks() {
  document.getElementById('t-list').innerHTML = '<div class="loading-overlay" style="min-height:120px"><div class="spinner"></div></div>';
  try {
    allTasks = await sb.db.select('tasks', {
      columns: 'id,title,description,status,priority,category,due_date,created_at,client_id,created_by,assigned_to,clients(company_name),created_profile:profiles!tasks_created_by_fkey(full_name),assigned_profile:profiles!tasks_assigned_to_fkey(full_name)',
      order: 'created_at.desc'
    }) || [];
    updateCounts();
    renderList();
  } catch(e) {
    document.getElementById('t-list').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function updateCounts() {
  const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
  set('cnt-all', allTasks.length);
  set('cnt-mine', allTasks.filter(t => t.assigned_to === myId).length);
  set('cnt-open', allTasks.filter(t => t.status === 'open').length);
  set('cnt-in_progress', allTasks.filter(t => t.status === 'in_progress').length);
  set('cnt-completed', allTasks.filter(t => t.status === 'completed').length);
  document.getElementById('task-count').textContent = allTasks.length + ' task totali';
}

function filtered() {
  if (currentFilter === 'all') return allTasks;
  if (currentFilter === 'mine') return allTasks.filter(t => t.assigned_to === myId);
  if (['open','in_progress','completed','cancelled'].includes(currentFilter)) return allTasks.filter(t => t.status === currentFilter);
  return allTasks.filter(t => t.category === currentFilter);
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.t-filter').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

const priColor = {urgent:'#dc2626',high:'#d97706',normal:'#1d4ed8',low:'#9ca3af'};

function renderList() {
  const tasks = filtered();
  const el = document.getElementById('t-list');
  if (!tasks.length) {
    el.innerHTML = '<div class="t-empty"><div class="ei">‚úì</div><p style="font-weight:600">Nessuna task qui</p></div>';
    return;
  }
  el.innerHTML = tasks.map(t => `
    <div class="t-card ${t.status==='completed'?'completed':''} ${t.id===selectedId?'selected':''}" onclick="openTask('${t.id}')">
      <div class="tc-top">
        <div style="width:10px;height:10px;border-radius:50%;background:${priColor[t.priority]||'#6b7a95'};flex-shrink:0;margin-top:3px"></div>
        <div class="tc-title">${ui.escapeHtml(t.title)}</div>
        <span class="status-chip sc-${t.status}">${{open:'Aperta',in_progress:'In corso',completed:'Fatta',cancelled:'Annullata'}[t.status]||t.status}</span>
      </div>
      <div class="tc-meta">
        ${t.clients ? `<span>üìÅ ${ui.escapeHtml(t.clients.company_name)}</span>` : ''}
        ${t.assigned_profile ? `<span>üë§ ${ui.escapeHtml(t.assigned_profile.full_name)}</span>` : ''}
        ${t.due_date ? `<span class="${ui.deadlineClass(t.due_date)}">üìÖ ${ui.formatDate(t.due_date)}</span>` : ''}
        <span style="margin-left:auto">${ui.formatDate(t.created_at)}</span>
      </div>
    </div>`).join('');
}

async function openTask(id) {
  selectedId = id;
  renderList();
  const t = allTasks.find(x => x.id === id);
  if (!t) return;
  const det = document.getElementById('t-detail');
  det.style.display = 'flex';
  det.style.flexDirection = 'column';
  det.style.alignItems = '';
  det.style.justifyContent = '';
  det.innerHTML = '<div class="loading-overlay" style="flex:1"><div class="spinner"></div></div>';

  const comments = await sb.db.select('task_comments', {
    columns: 'id,content,created_at,author_id,author:profiles!task_comments_author_id_fkey(full_name)',
    filter: `task_id=eq.${id}`,
    order: 'created_at.asc'
  }) || [];

  det.innerHTML = `
    <div class="td-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div class="td-title">${ui.escapeHtml(t.title)}</div>
        <button class="btn btn-ghost btn-sm" onclick="closeDetail()">‚úï</button>
      </div>
      <div class="td-chips">
        <select class="status-sel" onchange="updateStatus('${id}',this.value)">
          <option value="open" ${t.status==='open'?'selected':''}>üü° Aperta</option>
          <option value="in_progress" ${t.status==='in_progress'?'selected':''}>üîµ In corso</option>
          <option value="completed" ${t.status==='completed'?'selected':''}>‚úÖ Completata</option>
          <option value="cancelled" ${t.status==='cancelled'?'selected':''}>‚≠ï Annullata</option>
        </select>
        <span class="pri-pill pp-${t.priority}">${{urgent:'üî¥ Urgente',high:'üü† Alta',normal:'üîµ Normale',low:'‚ö™ Bassa'}[t.priority]}</span>
        <span class="badge">${t.category}</span>
        ${t.clients ? `<span class="badge">${ui.escapeHtml(t.clients.company_name)}</span>` : ''}
        ${t.due_date ? `<span class="badge ${ui.deadlineClass(t.due_date)}">üìÖ ${ui.formatDate(t.due_date)}</span>` : ''}
      </div>
      <div class="td-who">
        <span>Da: <strong>${ui.escapeHtml(t.created_profile?.full_name||'?')}</strong></span>
        ${t.assigned_profile ? `<span>A: <strong>${ui.escapeHtml(t.assigned_profile.full_name)}</strong></span>` : ''}
      </div>
    </div>
    <div class="td-body">
      ${t.description ? `<div class="td-desc">${ui.escapeHtml(t.description)}</div>` : ''}
      <div class="comments-head">üí¨ Commenti (${comments.length})</div>
      <div id="cmt-list">
        ${comments.length ? comments.map(c => `
          <div class="cmt">
            <div class="cmt-av">${(c.author?.full_name||'?').substring(0,2).toUpperCase()}</div>
            <div class="cmt-bubble">
              <span class="cmt-author">${ui.escapeHtml(c.author?.full_name||'?')}</span>
              <span class="cmt-time">${ui.formatDate(c.created_at)}</span>
              <div class="cmt-text">${ui.escapeHtml(c.content)}</div>
            </div>
          </div>`).join('') : '<p style="font-size:13px;color:var(--text-muted)">Nessun commento.</p>'}
      </div>
    </div>
    <div class="td-input">
      <textarea class="cmt-inp" id="cmt-text" rows="2" placeholder="Scrivi un commento... (Invio per inviare)"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();addComment('${id}')}"></textarea>
      <button class="btn btn-accent" onclick="addComment('${id}')">Invia</button>
    </div>`;
}

async function addComment(taskId) {
  const inp = document.getElementById('cmt-text');
  const content = inp.value.trim();
  if (!content) return;
  inp.value = '';
  try {
    await sb.db.insert('task_comments', {task_id:taskId, author_id:myId, content});
    const task = allTasks.find(t => t.id === taskId);
    if (task?.assigned_to && task.assigned_to !== myId) {
      await sb.db.insert('notifications', {
        user_id: task.assigned_to, type:'task_comment',
        title:'Nuovo commento: '+task.title, body:content.substring(0,80),
        link:'/tasks.html', entity_type:'task', entity_id:taskId
      }).catch(()=>{});
    }
    await openTask(taskId);
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

async function updateStatus(taskId, newStatus) {
  try {
    const updates = {status: newStatus};
    if (newStatus === 'completed') updates.completed_at = new Date().toISOString();
    await sb.db.update('tasks', `id=eq.${taskId}`, updates);
    const task = allTasks.find(t => t.id === taskId);
    if (task) { task.status = newStatus; if(newStatus==='completed') task.completed_at = updates.completed_at; }
    updateCounts(); renderList();
    ui.showToast('Stato aggiornato ‚úì', 'success');
    if (task?.assigned_to && task.assigned_to !== myId) {
      await sb.db.insert('notifications', {
        user_id: task.assigned_to, type:'task_completed',
        title: newStatus==='completed'?'Task completata: '+task.title:'Task aggiornata: '+task.title,
        link:'/tasks.html', entity_type:'task', entity_id:taskId
      }).catch(()=>{});
    }
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

function closeDetail() {
  selectedId = null;
  renderList();
  const det = document.getElementById('t-detail');
  det.style.alignItems = 'center';
  det.style.justifyContent = 'center';
  det.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted)">
    <div style="font-size:32px;margin-bottom:12px">üìã</div>
    <div style="font-size:14px;font-weight:600">Seleziona una task</div>
    <div style="font-size:12px;margin-top:4px">Clicca su una task per vedere i dettagli</div>
  </div>`;
}

function openNewTask() { document.getElementById('modal-task').style.display = 'flex'; }
function closeModal() { document.getElementById('modal-task').style.display = 'none'; }

async function saveTask() {
  const title = document.getElementById('t-title').value.trim();
  if (!title) { ui.showToast('Inserisci un titolo','error'); return; }
  const btn = document.getElementById('btn-save');
  btn.disabled = true; btn.textContent = '...';
  try {
    const data = {
      title,
      description: document.getElementById('t-desc').value.trim()||null,
      assigned_to: document.getElementById('t-assigned').value||null,
      client_id: document.getElementById('t-client').value||null,
      priority: document.getElementById('t-priority').value,
      category: document.getElementById('t-category').value,
      due_date: document.getElementById('t-due').value||null,
      created_by: myId, status: 'open'
    };
    const result = await sb.db.insert('tasks', data);
    if (data.assigned_to && data.assigned_to !== myId) {
      await sb.db.insert('notifications', {
        user_id: data.assigned_to, type:'task_assigned',
        title: 'Nuova task: '+title, body: data.description?.substring(0,80)||'',
        link:'/tasks.html', entity_type:'task', entity_id:result?.[0]?.id
      }).catch(()=>{});
    }
    closeModal();
    await loadTasks();
    ui.showToast('Task creata!','success');
    document.getElementById('t-title').value='';
    document.getElementById('t-desc').value='';
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
  finally { btn.disabled=false; btn.textContent='Crea Task'; }
}

init();
</script>
</body>
</html>
