<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .tasks-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
    .tasks-sidebar { display: flex; flex-direction: column; gap: 8px; }
    .filter-btn { padding: 8px 14px; border-radius: 8px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-muted); text-align: left; display: flex; align-items: center; gap: 8px; transition: all .15s; }
    .filter-btn:hover, .filter-btn.active { background: var(--surface2); color: var(--text-primary); }
    .filter-btn .count { margin-left: auto; background: var(--border); border-radius: 10px; padding: 1px 7px; font-size: 11px; }
    .filter-btn.active .count { background: var(--primary); color: white; }
    .task-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 10px; cursor: pointer; transition: all .15s; }
    .task-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(26,58,92,.08); }
    .task-card.selected { border-color: var(--primary); background: #f0f6ff; }
    .task-header { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
    .task-title { font-size: 14px; font-weight: 700; color: var(--text-primary); flex: 1; }
    .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; font-size: 12px; color: var(--text-muted); }
    .pri { padding: 2px 7px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .pri-urgent { background: #fee2e2; color: #dc2626; }
    .pri-high { background: #fef3c7; color: #d97706; }
    .pri-normal { background: #e0f2fe; color: #0369a1; }
    .pri-low { background: #f0f4f8; color: #6b7a95; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
    .dot-open { background: #f59e0b; }
    .dot-in_progress { background: #3b82f6; }
    .dot-completed { background: #16a34a; }
    .dot-cancelled { background: #9ca3af; }
    /* Task Detail Panel */
    .task-detail { background: white; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; min-height: 500px; }
    .detail-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); }
    .detail-title { font-size: 18px; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; }
    .detail-badges { display: flex; gap: 8px; flex-wrap: wrap; }
    .detail-body { padding: 20px 24px; flex: 1; overflow-y: auto; }
    .detail-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; padding: 14px; background: var(--surface2); border-radius: 8px; }
    .comments-section { margin-top: 4px; }
    .comments-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-muted); margin-bottom: 14px; }
    .comment { display: flex; gap: 10px; margin-bottom: 16px; }
    .comment-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; }
    .comment-bubble { background: var(--surface2); border-radius: 10px; padding: 10px 14px; flex: 1; }
    .comment-author { font-size: 12px; font-weight: 700; color: var(--text-primary); }
    .comment-time { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
    .comment-text { font-size: 13px; color: var(--text-secondary); margin-top: 4px; line-height: 1.5; }
    .comment-input-wrap { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
    .comment-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: inherit; resize: none; outline: none; }
    .comment-input:focus { border-color: var(--primary); }
    .empty-tasks { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-tasks .icon { font-size: 40px; margin-bottom: 12px; }
    .status-select { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; font-weight: 600; cursor: pointer; outline: none; background: white; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-title">Task</div>
      <div class="topbar-actions">
        <button class="btn btn-accent" onclick="openNewTask()">+ Nuova Task</button>
      </div>
    </div>
    <div class="page-content">
      <div class="tasks-layout">
        <!-- Sidebar filters -->
        <div class="tasks-sidebar">
          <div class="card" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);padding:4px 6px;margin-bottom:6px">Filtri</div>
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">üìã Tutte <span class="count" id="cnt-all">0</span></button>
            <button class="filter-btn" data-filter="mine" onclick="setFilter('mine',this)">üë§ Assegnate a me <span class="count" id="cnt-mine">0</span></button>
            <button class="filter-btn" data-filter="open" onclick="setFilter('open',this)">üü° Aperte <span class="count" id="cnt-open">0</span></button>
            <button class="filter-btn" data-filter="in_progress" onclick="setFilter('in_progress',this)">üîµ In corso <span class="count" id="cnt-in_progress">0</span></button>
            <button class="filter-btn" data-filter="completed" onclick="setFilter('completed',this)">‚úÖ Completate <span class="count" id="cnt-completed">0</span></button>
            <div style="border-top:1px solid var(--border);margin:8px 0"></div>
            <button class="filter-btn" data-filter="vat" onclick="setFilter('vat',this)">‚óá VAT</button>
            <button class="filter-btn" data-filter="corporate_tax" onclick="setFilter('corporate_tax',this)">‚óà Corporate Tax</button>
            <button class="filter-btn" data-filter="onboarding" onclick="setFilter('onboarding',this)">‚ú¶ Onboarding</button>
            <button class="filter-btn" data-filter="estratti" onclick="setFilter('estratti',this)">‚óé Estratti</button>
            <button class="filter-btn" data-filter="pagamenti" onclick="setFilter('pagamenti',this)">‚óÜ Pagamenti</button>
          </div>
        </div>

        <!-- Main content -->
        <div>
          <div id="tasks-list"><div class="loading-overlay"><div class="spinner"></div></div></div>
          <div id="task-detail" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="modal-task" style="display:none">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title">Nuova Task</div>
      <button class="btn btn-ghost btn-sm" onclick="closeTaskModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Titolo *</label>
        <input type="text" class="form-control" id="t-title" placeholder="Es. Registrare estratto WIO gennaio">
      </div>
      <div class="form-group">
        <label class="form-label">Descrizione</label>
        <textarea class="form-control" id="t-desc" rows="3" placeholder="Dettagli aggiuntivi..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Assegna a</label>
          <select class="form-control" id="t-assigned">
            <option value="">Seleziona utente</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Cliente</label>
          <select class="form-control" id="t-client">
            <option value="">Nessun cliente</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Priorit√†</label>
          <select class="form-control" id="t-priority">
            <option value="normal">Normale</option>
            <option value="high">Alta</option>
            <option value="urgent">Urgente</option>
            <option value="low">Bassa</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select class="form-control" id="t-category">
            <option value="generale">Generale</option>
            <option value="vat">VAT</option>
            <option value="corporate_tax">Corporate Tax</option>
            <option value="onboarding">Onboarding</option>
            <option value="estratti">Estratti</option>
            <option value="pagamenti">Pagamenti</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Scadenza</label>
          <input type="date" class="form-control" id="t-due">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">Annulla</button>
      <button class="btn btn-accent" onclick="saveTask()">Crea Task</button>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let allTasks = [];
let currentFilter = 'all';
let currentTaskId = null;
let currentUserId = null;
let profiles = [];

async function init() {
  await sb.requireAuth();
  const me = await sb.getCurrentProfile();
  currentUserId = me?.id;
  await loadProfiles();
  await loadTasks();
}

async function loadProfiles() {
  profiles = await sb.db.select('profiles', { columns: 'id,full_name,role' }) || [];
  const sel = document.getElementById('t-assigned');
  profiles.forEach(p => {
    const o = document.createElement('option');
    o.value = p.id; o.textContent = p.full_name;
    sel.appendChild(o);
  });
  // Load clients for dropdown
  const clients = await sb.db.select('clients', { columns: 'id,company_name', order: 'company_name.asc', filter: 'is_active=eq.true' }) || [];
  const csel = document.getElementById('t-client');
  clients.forEach(c => {
    const o = document.createElement('option');
    o.value = c.id; o.textContent = c.company_name;
    csel.appendChild(o);
  });
}

async function loadTasks() {
  try {
    const data = await sb.db.select('tasks', {
      columns: 'id,title,description,status,priority,category,due_date,created_at,completed_at,client_id,created_by,assigned_to,clients(company_name),created_profile:profiles!tasks_created_by_fkey(full_name),assigned_profile:profiles!tasks_assigned_to_fkey(full_name)',
      order: 'created_at.desc'
    });
    allTasks = data || [];
    updateCounts();
    renderList();
  } catch(e) {
    document.getElementById('tasks-list').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function updateCounts() {
  document.getElementById('cnt-all').textContent = allTasks.length;
  document.getElementById('cnt-mine').textContent = allTasks.filter(t => t.assigned_to === currentUserId).length;
  document.getElementById('cnt-open').textContent = allTasks.filter(t => t.status === 'open').length;
  document.getElementById('cnt-in_progress').textContent = allTasks.filter(t => t.status === 'in_progress').length;
  document.getElementById('cnt-completed').textContent = allTasks.filter(t => t.status === 'completed').length;
}

function filteredTasks() {
  if (currentFilter === 'all') return allTasks;
  if (currentFilter === 'mine') return allTasks.filter(t => t.assigned_to === currentUserId);
  if (['open','in_progress','completed','cancelled'].includes(currentFilter)) return allTasks.filter(t => t.status === currentFilter);
  return allTasks.filter(t => t.category === currentFilter);
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

function priLabel(p) {
  const m = {urgent:'Urgente',high:'Alta',normal:'Normale',low:'Bassa'};
  return `<span class="pri pri-${p}">${m[p]||p}</span>`;
}
function catIcon(c) {
  const m = {vat:'‚óá',corporate_tax:'‚óà',onboarding:'‚ú¶',estratti:'‚óé',pagamenti:'‚óÜ',generale:'‚óâ'};
  return m[c]||'‚óâ';
}

function renderList() {
  const tasks = filteredTasks();
  const el = document.getElementById('tasks-list');
  if (!tasks.length) {
    el.innerHTML = `<div class="empty-tasks"><div class="icon">‚úì</div><p>Nessuna task qui</p></div>`;
    return;
  }
  el.innerHTML = tasks.map(t => `
    <div class="task-card ${t.id === currentTaskId ? 'selected' : ''}" onclick="openTask('${t.id}')">
      <div class="task-header">
        <div class="status-dot dot-${t.status}" title="${t.status}"></div>
        <div class="task-title">${ui.escapeHtml(t.title)}</div>
        ${priLabel(t.priority)}
      </div>
      <div class="task-meta">
        <span>${catIcon(t.category)} ${t.category}</span>
        ${t.clients ? `<span>¬∑ ${ui.escapeHtml(t.clients.company_name)}</span>` : ''}
        ${t.assigned_profile ? `<span>¬∑ üë§ ${ui.escapeHtml(t.assigned_profile.full_name)}</span>` : ''}
        ${t.due_date ? `<span>¬∑ üìÖ ${ui.formatDate(t.due_date)}</span>` : ''}
        <span style="margin-left:auto">${ui.formatDate(t.created_at)}</span>
      </div>
    </div>
  `).join('');
}

async function openTask(id) {
  currentTaskId = id;
  renderList(); // update selected state
  const task = allTasks.find(t => t.id === id);
  if (!task) return;

  // Load comments
  const comments = await sb.db.select('task_comments', {
    columns: 'id,content,created_at,author_id,author:profiles!task_comments_author_id_fkey(full_name)',
    filter: `task_id=eq.${id}`,
    order: 'created_at.asc'
  }) || [];

  const det = document.getElementById('task-detail');
  det.style.display = 'block';
  det.innerHTML = `
    <div class="task-detail">
      <div class="detail-header">
        <div style="display:flex;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="detail-title">${ui.escapeHtml(task.title)}</div>
            <div class="detail-badges">
              <select class="status-select" onchange="updateStatus('${id}', this.value)">
                <option value="open" ${task.status==='open'?'selected':''}>üü° Aperta</option>
                <option value="in_progress" ${task.status==='in_progress'?'selected':''}>üîµ In corso</option>
                <option value="completed" ${task.status==='completed'?'selected':''}>‚úÖ Completata</option>
                <option value="cancelled" ${task.status==='cancelled'?'selected':''}>‚ùå Annullata</option>
              </select>
              ${priLabel(task.priority)}
              <span class="badge">${catIcon(task.category)} ${task.category}</span>
              ${task.clients ? `<span class="badge">${ui.escapeHtml(task.clients.company_name)}</span>` : ''}
              ${task.due_date ? `<span class="badge ${ui.deadlineClass(task.due_date)}">üìÖ ${ui.formatDate(task.due_date)}</span>` : ''}
            </div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="closeDetail()">‚úï</button>
        </div>
        <div style="margin-top:12px;font-size:12px;color:var(--text-muted);display:flex;gap:16px">
          <span>Creata da <strong>${ui.escapeHtml(task.created_profile?.full_name||'?')}</strong></span>
          ${task.assigned_profile ? `<span>Assegnata a <strong>${ui.escapeHtml(task.assigned_profile.full_name)}</strong></span>` : ''}
          <span>${ui.formatDate(task.created_at)}</span>
        </div>
      </div>
      <div class="detail-body">
        ${task.description ? `<div class="detail-desc">${ui.escapeHtml(task.description)}</div>` : ''}
        <div class="comments-section">
          <div class="comments-title">üí¨ Commenti (${comments.length})</div>
          <div id="comments-list">
            ${comments.length ? comments.map(c => `
              <div class="comment">
                <div class="comment-avatar">${(c.author?.full_name||'?').substring(0,2).toUpperCase()}</div>
                <div class="comment-bubble">
                  <span class="comment-author">${ui.escapeHtml(c.author?.full_name||'?')}</span>
                  <span class="comment-time">${ui.formatDate(c.created_at)}</span>
                  <div class="comment-text">${ui.escapeHtml(c.content)}</div>
                </div>
              </div>`).join('') : '<p style="font-size:13px;color:var(--text-muted)">Nessun commento ancora.</p>'}
          </div>
        </div>
      </div>
      <div class="comment-input-wrap">
        <textarea class="comment-input" id="comment-text" rows="2" placeholder="Scrivi un commento..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();addComment('${id}')}"></textarea>
        <button class="btn btn-accent" onclick="addComment('${id}')">Invia</button>
      </div>
    </div>
  `;
}

async function addComment(taskId) {
  const input = document.getElementById('comment-text');
  const content = input.value.trim();
  if (!content) return;
  input.value = '';
  try {
    await sb.db.insert('task_comments', { task_id: taskId, author_id: currentUserId, content });
    // Add notification to task owner/assignee
    const task = allTasks.find(t => t.id === taskId);
    if (task && task.assigned_to && task.assigned_to !== currentUserId) {
      await createNotification(task.assigned_to, 'task_comment', 
        `Nuovo commento su: ${task.title}`, content.substring(0,80),
        `/tasks.html`, 'task', taskId);
    }
    await openTask(taskId); // reload comments
  } catch(e) { ui.showToast('Errore: '+e.message, 'error'); }
}

async function updateStatus(taskId, newStatus) {
  try {
    const updates = { status: newStatus };
    if (newStatus === 'completed') updates.completed_at = new Date().toISOString();
    await sb.db.update('tasks', `id=eq.${taskId}`, updates);
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
      task.status = newStatus;
      if (task.assigned_to && task.assigned_to !== currentUserId) {
        await createNotification(task.assigned_to, 'task_completed',
          `Task ${newStatus === 'completed' ? 'completata' : 'aggiornata'}: ${task.title}`, '',
          '/tasks.html', 'task', taskId);
      }
    }
    updateCounts();
    renderList();
    ui.showToast('Stato aggiornato', 'success');
  } catch(e) { ui.showToast('Errore: '+e.message, 'error'); }
}

async function createNotification(userId, type, title, body, link, entityType, entityId) {
  try {
    await sb.db.insert('notifications', { user_id: userId, type, title, body, link, entity_type: entityType, entity_id: entityId });
  } catch(e) { console.error('Notification error:', e); }
}

function closeDetail() {
  currentTaskId = null;
  document.getElementById('task-detail').style.display = 'none';
  renderList();
}

function openNewTask() {
  document.getElementById('modal-task').style.display = 'flex';
}
function closeTaskModal() {
  document.getElementById('modal-task').style.display = 'none';
}

async function saveTask() {
  const title = document.getElementById('t-title').value.trim();
  if (!title) { ui.showToast('Inserisci un titolo', 'error'); return; }
  const btn = document.querySelector('#modal-task .btn-accent');
  btn.textContent = 'Salvo...'; btn.disabled = true;
  try {
    const data = {
      title,
      description: document.getElementById('t-desc').value.trim() || null,
      assigned_to: document.getElementById('t-assigned').value || null,
      client_id: document.getElementById('t-client').value || null,
      priority: document.getElementById('t-priority').value,
      category: document.getElementById('t-category').value,
      due_date: document.getElementById('t-due').value || null,
      created_by: currentUserId,
      status: 'open'
    };
    const result = await sb.db.insert('tasks', data);
    // Notify assigned user
    if (data.assigned_to && data.assigned_to !== currentUserId) {
      await createNotification(data.assigned_to, 'task_assigned',
        `Nuova task assegnata: ${title}`, data.description||'',
        '/tasks.html', 'task', result?.[0]?.id);
    }
    closeTaskModal();
    await loadTasks();
    ui.showToast('Task creata!', 'success');
  } catch(e) {
    ui.showToast('Errore: '+e.message, 'error');
  } finally {
    btn.textContent = 'Crea Task'; btn.disabled = false;
  }
}

init();
</script>
</body>
</html>
