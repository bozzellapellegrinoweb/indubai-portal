<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InDubai â€” Il tuo Portale</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="/js/config.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy: #0f1e35;
      --navy2: #1a3a5c;
      --gold: #c9a84c;
      --gold2: #e8c97a;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #7a8ca0;
      --radius: 16px;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      background: var(--navy);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,.3);
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-mark { font-family: 'Playfair Display', serif; font-size: 22px; color: white; letter-spacing: -.5px; }
    .logo-mark span { color: var(--gold); }
    .logo-divider { width: 1px; height: 20px; background: rgba(255,255,255,.2); }
    .logo-sub { font-size: 12px; color: rgba(255,255,255,.45); font-weight: 500; letter-spacing: 1.5px; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-company { font-size: 13px; color: rgba(255,255,255,.6); font-weight: 500; }
    .btn-logout {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.7);
      padding: 7px 14px; border-radius: 8px;
      font-size: 12px; font-weight: 500; cursor: pointer;
      font-family: inherit; transition: all .2s;
    }
    .btn-logout:hover { background: rgba(255,255,255,.15); color: white; }

    /* â”€â”€ LAYOUT â”€â”€ */
    .layout { display: flex; min-height: calc(100vh - 64px); }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar {
      width: 220px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 28px 0;
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
    }
    .nav-section { padding: 0 20px 8px; font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 20px; font-size: 13px; font-weight: 500;
      color: var(--muted); cursor: pointer; border: none;
      background: none; width: 100%; text-align: left;
      font-family: inherit; transition: all .15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { color: var(--navy2); background: #f0f4f8; }
    .nav-item.active { color: var(--navy2); background: #eff6ff; border-left-color: var(--gold); font-weight: 600; }
    .nav-icon { font-size: 15px; width: 20px; text-align: center; }

    /* â”€â”€ MAIN â”€â”€ */
    .main { flex: 1; padding: 36px 40px; max-width: 900px; }

    /* â”€â”€ HERO â”€â”€ */
    .hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
      border-radius: var(--radius);
      padding: 32px 36px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -40px; right: -40px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(201,168,76,.2) 0%, transparent 70%);
      border-radius: 50%;
    }
    .hero-welcome { font-size: 12px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
    .hero-title { font-family: 'Playfair Display', serif; font-size: 28px; color: white; margin-bottom: 8px; }
    .hero-sub { font-size: 13px; color: rgba(255,255,255,.5); }
    .hero-badges { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .hero-badge {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 100px;
      padding: 5px 14px;
      font-size: 12px;
      color: rgba(255,255,255,.7);
      font-weight: 500;
    }
    .hero-badge.gold { background: rgba(201,168,76,.15); border-color: rgba(201,168,76,.3); color: var(--gold2); }

    /* â”€â”€ CARDS â”€â”€ */
    .section-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: 0 1px 8px rgba(0,0,0,.04);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      padding: 18px 24px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title { font-size: 14px; font-weight: 600; color: var(--navy2); }
    .card-body { padding: 20px 24px; }

    /* Info grid */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .info-field label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; display: block; margin-bottom: 5px; }
    .info-field span { font-size: 14px; font-weight: 500; color: var(--text); }
    .info-field span.empty { color: #cbd5e1; font-style: italic; font-size: 13px; }

    /* Badges */
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 100px; font-size: 11px; font-weight: 700; }
    .badge-green { background: #f0fdf4; color: #059669; border: 1px solid #86efac; }
    .badge-yellow { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
    .badge-red { background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; }

    /* â”€â”€ FILE LIST â”€â”€ */
    .folder-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
    .folder-tab {
      padding: 6px 16px; border-radius: 100px;
      font-size: 12px; font-weight: 600;
      border: 1.5px solid var(--border);
      background: white; color: var(--muted);
      cursor: pointer; font-family: inherit; transition: all .15s;
    }
    .folder-tab:hover { border-color: var(--navy2); color: var(--navy2); }
    .folder-tab.active { background: var(--navy2); color: white; border-color: var(--navy2); }

    .file-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .file-row:last-child { border-bottom: none; }
    .file-icon { font-size: 24px; flex-shrink: 0; }
    .file-info { flex: 1; min-width: 0; }
    .file-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .btn-dl {
      flex-shrink: 0;
      padding: 7px 16px;
      background: var(--navy2); color: white;
      border: none; border-radius: 8px;
      font-size: 12px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      transition: background .15s;
    }
    .btn-dl:hover { background: var(--navy); }

    .empty-state { padding: 40px; text-align: center; color: var(--muted); }
    .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; }

    /* â”€â”€ PREVIEW MODAL â”€â”€ */
    .prev-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
    }
    .prev-modal {
      background: white; border-radius: 16px;
      width: 95vw; max-width: 900px; max-height: 92vh;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.4);
    }
    .prev-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; border-bottom: 1.5px solid var(--border); flex-shrink: 0;
    }
    .prev-title { font-size: 14px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; margin-right: 12px; color: var(--navy2); }
    .prev-body { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; min-height: 300px; background: #f8f8f8; }

    /* â”€â”€ SERVIZI â”€â”€ */
    .srv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap: 16px; margin-bottom: 20px; }
    .srv-card { background: white; border: 1.5px solid var(--border); border-radius: 16px; padding: 22px; position: relative; transition: all .2s; display: flex; flex-direction: column; }
    .srv-card:hover { border-color: var(--navy2); box-shadow: 0 6px 20px rgba(15,30,53,.08); transform: translateY(-2px); }
    .srv-tag { position: absolute; top: 14px; right: 14px; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 100px; background: var(--gold); color: white; text-transform: uppercase; letter-spacing: .5px; }
    .srv-icon { font-size: 32px; margin-bottom: 12px; }
    .srv-title { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: var(--navy2); margin-bottom: 8px; }
    .srv-desc { font-size: 13px; color: var(--muted); line-height: 1.6; flex: 1; margin-bottom: 16px; }
    .srv-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--navy2); color: white; border-radius: 8px; font-size: 12px; font-weight: 600; text-decoration: none; transition: background .15s; align-self: flex-start; }
    .srv-btn:hover { background: var(--navy); }

    /* â”€â”€ DRIVE â”€â”€ */
    .drv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 12px; }
    .drv-card { background:#f8fafc; border:1.5px solid var(--border); border-radius:12px; padding:16px 12px; text-align:center; cursor:pointer; transition:all .15s; }
    .drv-card:hover { border-color:var(--navy2); background:#eff6ff; transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .drv-dir .drv-ico { filter: none; }
    .drv-ico { font-size:32px; margin-bottom:8px; }
    .drv-nm { font-size:12px; font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .drv-sz { font-size:11px; color:var(--muted); margin-top:3px; }
    .drv-list { display:none; }
    .drv-row { display:flex; align-items:center; gap:12px; padding:10px 8px; border-bottom:1px solid #f1f5f9; cursor:pointer; border-radius:8px; transition:background .1s; }
    .drv-row:hover { background:#f0f4f8; }
    .drv-row:last-child { border-bottom:none; }
    .drv-row-name { flex:1; font-size:13px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .drv-row-meta { font-size:11px; color:var(--muted); min-width:60px; text-align:right; }

    /* â”€â”€ PANEL VISIBILITY â”€â”€ */
    .panel { display: none; }
    .panel.active { display: block; }

    /* â”€â”€ SPINNER â”€â”€ */
    .spinner { width: 28px; height: 28px; border: 3px solid #e2e8f0; border-top-color: var(--navy2); border-radius: 50%; animation: spin .7s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ SCADENZA BANNER â”€â”€ */
    .deadline-banner {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 20px; border-radius: 12px;
      margin-bottom: 16px; font-size: 13px; font-weight: 500;
    }
    .deadline-banner.warning { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
    .deadline-banner.danger  { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; }
  </style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-mark">In<span>Dubai</span></div>
    <div class="logo-divider"></div>
    <div class="logo-sub">Area Clienti</div>
  </div>
  <div class="header-right">
    <span class="header-company" id="header-company"></span>
    <button class="btn-logout" onclick="doLogout()">â» Esci</button>
  </div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="nav-section" style="margin-bottom:8px">Menu</div>
    <button class="nav-item active" onclick="showPanel('anagrafica', this)"><span class="nav-icon">ğŸ¢</span> Anagrafica</button>
    <button class="nav-item" onclick="showPanel('documenti', this)"><span class="nav-icon">ğŸ“</span> Documenti</button>
    <button class="nav-item" onclick="showPanel('scadenze', this)"><span class="nav-icon">ğŸ“…</span> Scadenze</button>
    <button class="nav-item" onclick="showPanel('pratiche', this)"><span class="nav-icon">ğŸ“‹</span> Le mie Pratiche</button>
    <div class="nav-section" style="margin-top:16px">InDubai</div>
    <button class="nav-item" onclick="showPanel('servizi', this)"><span class="nav-icon">âœ¦</span> Servizi</button>
    <button class="nav-item" onclick="showPanel('numeri', this)"><span class="nav-icon">ğŸ“</span> Numeri Utili</button>
  </aside>

  <!-- Main content -->
  <main class="main" id="main">
    <div class="spinner"></div>
  </main>
</div>

<script src="/js/supabase.js"></script>
<script>
const SB_URL = window.ENV_SUPABASE_URL;
const SB_KEY = window.ENV_SUPABASE_ANON_KEY;
function H() {
  const tok = sb.getSession()?.access_token || SB_KEY;
  return { apikey: SB_KEY, Authorization: `Bearer ${tok}`, 'Content-Type': 'application/json' };
}
async function GET(path) {
  const r = await fetch(SB_URL + path, { headers: H() });
  return r.json();
}
async function doLogout() {
  try { await fetch(SB_URL + '/auth/v1/logout', { method: 'POST', headers: H() }); } catch {}
  localStorage.removeItem('indubai_session');
  window.location.href = '/client-portal/login.html';
}

let clientData = null;
let allFiles = [];

async function loadVisas(clientId) {
  try {
    const visas = await GET(`/rest/v1/client_visas?client_id=eq.${clientId}&select=holder_name,visa_type,expiry_date&order=expiry_date.asc`);
    return visas || [];
  } catch { return []; }
}

async function init() {
  const sess = sb.getSession();
  if (!sess?.access_token) { window.location.href = '/client-portal/login.html'; return; }

  try {
    // Get client_id
    const links = await GET(`/rest/v1/client_users?user_id=eq.${sess.user.id}&select=client_id`);
    if (!links?.length) throw new Error('Nessun cliente collegato. Contatta il tuo consulente.');
    const clientId = links[0].client_id;

    // Load client
    const clients = await GET(`/rest/v1/clients?id=eq.${clientId}&select=*`);
    clientData = clients?.[0];
    if (!clientData) throw new Error('Dati aziendali non trovati.');

    // Load files
    allFiles = await GET(`/rest/v1/client_files?client_id=eq.${clientId}&select=id,display_name,file_size,mime_type,folder,storage_path,created_at&order=created_at.desc`) || [];

    // Set header
    document.getElementById('header-company').textContent = clientData.company_name;

    // Load visas
    const visas = await loadVisas(clientId);

    // Render all panels
    renderAll();
    try {
      document.getElementById('main').innerHTML = buildMainHTML(visas);
    } catch(renderErr) {
      document.getElementById('main').innerHTML = `<div style="padding:40px;text-align:center;color:#dc2626"><strong>Render error:</strong> \${renderErr.message}</div>`;
    }
    setupNav();
    // Pre-render drive if documenti panel is pre-selected
    // (it will render when user clicks the tab via showPanel)

  } catch(e) {
    document.getElementById('main').innerHTML = `<div style="padding:40px;text-align:center;color:#dc2626"><strong>Errore:</strong> ${e.message}<br><small style="color:#666">${e.stack||''}</small></div>`;
  }
}

function buildMainHTML(visas=[]) {
  return `
    <!-- ANAGRAFICA -->
    <div class="panel active" id="panel-anagrafica">
      ${heroHTML()}
      ${anagraficaHTML()}
    </div>

    <!-- DOCUMENTI -->
    <div class="panel" id="panel-documenti">
      <div class="section-title" style="margin-bottom:20px">I tuoi Documenti</div>
      ${documentiHTML()}
    </div>

    <!-- SCADENZE -->
    <div class="panel" id="panel-scadenze">
      <div class="section-title" style="margin-bottom:20px">Scadenze Importanti</div>
      \${scadenzeHTML(visas)}
    </div>

    <!-- PRATICHE -->
    <div class="panel" id="panel-pratiche">
      <div class="section-title" style="margin-bottom:20px">Le mie Pratiche</div>
      <div id="pratiche-client-content"><div class="spinner"></div></div>
    </div>

    <!-- SERVIZI -->
    <div class="panel" id="panel-servizi">
      \${serviziHTML()}
    </div>

    <!-- NUMERI UTILI -->
    <div class="panel" id="panel-numeri">
      \${numeriHTML()}
    </div>
  \`;
}

function heroHTML() {
  const c = clientData;
  const badges = [];
  if (c.free_zone) badges.push({ text: c.free_zone, gold: true });
  if (c.company_type) badges.push({ text: c.company_type });
  if (c.vat_registered) badges.push({ text: 'âœ“ VAT Registrata', gold: true });

  return `
    <div class="hero">
      <div class="hero-welcome">Bentornato</div>
      <div class="hero-title">${c.company_name}</div>
      <div class="hero-sub">Il tuo spazio personale InDubai â€” anagrafica, documenti e scadenze</div>
      ${badges.length ? `<div class="hero-badges">${badges.map(b => `<span class="hero-badge${b.gold?' gold':''}">${b.text}</span>`).join('')}</div>` : ''}
    </div>`;
}

function anagraficaHTML() {
  const c = clientData;
  const f = (label, val) => `
    <div class="info-field">
      <label>${label}</label>
      <span class="${val ? '' : 'empty'}">${val || 'Non disponibile'}</span>
    </div>`;
  const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'numeric'}) : null;

  // License expiry badge
  let licBadge = '';
  if (c.trade_license_date) {
    const days = Math.round((new Date(c.trade_license_date) - new Date()) / 86400000);
    if (days < 0) licBadge = ' <span class="badge badge-red">Scaduta</span>';
    else if (days <= 60) licBadge = ` <span class="badge badge-yellow">Scade in ${days}gg</span>`;
    else licBadge = ' <span class="badge badge-green">Attiva</span>';
  }

  return `
    <div class="card">
      <div class="card-header"><div class="card-title">ğŸ¢ Dati Aziendali</div></div>
      <div class="card-body">
        <div class="info-grid">
          ${f('Ragione Sociale', c.company_name)}
          ${f('Tipo SocietÃ ', c.company_type)}
          ${f('Free Zone', c.free_zone)}
          ${f('N. Licenza', c.license_number)}
          <div class="info-field"><label>Scadenza Licenza</label><span>${fmtDate(c.trade_license_date) || '<span class="empty">Non disponibile</span>'}${licBadge}</span></div>
          <div class="info-field"><label>Stato VAT</label><span>${c.vat_registered ? '<span class="badge badge-green">âœ“ Registrata</span>' : '<span class="badge badge-yellow">Non registrata</span>'}</span></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">ğŸ‘¤ Contatto Principale</div></div>
      <div class="card-body">
        <div class="info-grid">
          ${f('Referente', c.contact_name)}
          ${f('Email', c.email)}
          ${f('Telefono', c.phone || c.phone_uae)}
          ${f('NazionalitÃ ', c.nationality)}
          ${f('Passaporto (scad.)', fmtDate(c.passport_expiry))}
          ${f('Emirates ID (scad.)', fmtDate(c.eid_expiry))}
        </div>
      </div>
    </div>`;
}

function documentiHTML() {
  return `
    <div class="card" style="overflow:hidden">
      <div style="padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
        <div id="drive-bc" style="flex:1;font-size:13px;font-weight:600;color:var(--navy2)">ğŸ“ I tuoi documenti</div>
        <button class="folder-tab active" id="vbtn-grid" onclick="setDriveView('grid')" title="Griglia" style="padding:5px 10px">âŠ</button>
        <button class="folder-tab" id="vbtn-list" onclick="setDriveView('list')" title="Lista" style="padding:5px 10px">â˜°</button>
      </div>
      <div id="drive-content" style="padding:20px;min-height:160px">
        <div class="empty-state"><div class="icon">ğŸ“‚</div><p>Caricamento...</p></div>
      </div>
    </div>`;
}

// â”€â”€ DRIVE LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cwd = '/';
let driveView = 'grid';

const esc  = s => String(s||'').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
const sz   = b => !b?'': b<1024?b+'B': b<1048576?(b/1024).toFixed(0)+'KB':(b/1048576).toFixed(1)+'MB';
const dt   = s => new Date(s).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'2-digit'});
const mico = (m,n) => {
  if(m?.includes('pdf')) return 'ğŸ“„';
  if(m?.includes('word')) return 'ğŸ“';
  if(m?.includes('excel')||m?.includes('sheet')) return 'ğŸ“Š';
  if(m?.startsWith('image')) return 'ğŸ–¼ï¸';
  const e=(n||'').split('.').pop().toLowerCase();
  return {zip:'ğŸ—œï¸',rar:'ğŸ—œï¸',txt:'ğŸ“ƒ',csv:'ğŸ“Š',ppt:'ğŸ“‘',pptx:'ğŸ“‘'}[e]||'ğŸ“';
};

function renderDrive() {
  if (!allFiles.length) {
    document.getElementById('drive-content').innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‚</div><p>Nessun documento disponibile.<br>Il tuo consulente caricherÃ  i documenti qui.</p></div>`;
    return;
  }
  // Build virtual folder tree from flat file list
  const files = allFiles.filter(f => (f.folder||'/') === cwd && f.display_name !== '.keep');
  const subsSet = new Set();
  allFiles.forEach(f => {
    const folder = f.folder || '/';
    if (!folder.startsWith(cwd) || folder === cwd) return;
    const seg = folder.slice(cwd.length).split('/')[0];
    if (seg) subsSet.add(seg);
  });
  const dirs = [...subsSet].sort();

  renderBC();

  // GRID
  let g = '<div class="drv-grid">';
  dirs.forEach(n => {
    g += `<div class="drv-card drv-dir" data-dir="${esc(n)}">
      <div class="drv-ico">ğŸ“</div>
      <div class="drv-nm">${esc(n)}</div>
      <div class="drv-sz">Cartella</div>
    </div>`;
  });
  files.forEach(f => {
    g += `<div class="drv-card drv-file" data-sp="${esc(f.storage_path)}" data-nm="${esc(f.display_name)}" data-mime="${esc(f.mime_type||'')}">
      <div class="drv-ico">${mico(f.mime_type, f.display_name)}</div>
      <div class="drv-nm">${esc(f.display_name)}</div>
      <div class="drv-sz">${sz(f.file_size)}</div>
    </div>`;
  });
  g += '</div>';

  // LIST
  let l = '<div class="drv-list">';
  dirs.forEach(n => {
    l += `<div class="drv-row drv-dir" data-dir="${esc(n)}">
      <span style="font-size:20px">ğŸ“</span>
      <span class="drv-row-name">${esc(n)}</span>
      <span class="drv-row-meta">Cartella</span>
      <span class="drv-row-meta">â€”</span>
    </div>`;
  });
  files.forEach(f => {
    l += `<div class="drv-row drv-file" data-sp="${esc(f.storage_path)}" data-nm="${esc(f.display_name)}" data-mime="${esc(f.mime_type||'')}">
      <span style="font-size:20px">${mico(f.mime_type, f.display_name)}</span>
      <span class="drv-row-name">${esc(f.display_name)}</span>
      <span class="drv-row-meta">${dt(f.created_at)}</span>
      <span class="drv-row-meta">${sz(f.file_size)}</span>
    </div>`;
  });
  l += '</div>';

  document.getElementById('drive-content').innerHTML = g + l;
  applyDriveView();
  // Event delegation for file clicks
  document.getElementById('drive-content').querySelectorAll('.drv-file').forEach(el => {
    el.addEventListener('click', () => previewFile(el.dataset.sp, el.dataset.nm, el.dataset.mime));
  });
  document.getElementById('drive-content').querySelectorAll('.drv-dir').forEach(el => {
    el.addEventListener('click', () => cdDir(el.dataset.dir));
  });
}

function cdDir(name) {
  cwd = cwd + name + '/';
  renderDrive();
}

function renderBC() {
  const bc = document.getElementById('drive-bc');
  if (!bc) return;
  const parts = cwd.split('/').filter(Boolean);
  let html = `<span style="cursor:pointer;color:var(--gold)" onclick="cwd='/';renderDrive()">ğŸ“ Documenti</span>`;
  let built = '/';
  parts.forEach((p,i) => {
    built += p+'/';
    const target = built;
    const isLast = i === parts.length-1;
    html += ` <span style="color:var(--muted)">â€º</span> `;
    html += isLast
      ? `<span style="color:var(--navy2)">${esc(p)}</span>`
      : `<span style="cursor:pointer;color:var(--gold)" onclick="cwd='${target}';renderDrive()">${esc(p)}</span>`;
  });
  bc.innerHTML = html;
}

function setDriveView(v) {
  driveView = v;
  document.getElementById('vbtn-grid')?.classList.toggle('active', v==='grid');
  document.getElementById('vbtn-list')?.classList.toggle('active', v==='list');
  applyDriveView();
}

function applyDriveView() {
  document.querySelectorAll('.drv-grid').forEach(e => e.style.display = driveView==='grid' ? 'grid' : 'none');
  document.querySelectorAll('.drv-list').forEach(e => e.style.display = driveView==='list' ? 'block' : 'none');
}


function scadenzeHTML(visas=[]) {
  const c = clientData;
  const items = [];
  const today = new Date();
  const addDeadline = (label, dateStr, icon) => {
    if (!dateStr) return;
    const d = new Date(dateStr);
    const days = Math.round((d - today) / 86400000);
    const fmt = d.toLocaleDateString('it-IT', {day:'2-digit',month:'long',year:'numeric'});
    items.push({ label, fmt, days, icon });
  };
  addDeadline('Licenza Aziendale', c.trade_license_date, 'ğŸªª');
  addDeadline('Passaporto', c.passport_expiry, 'ğŸ“˜');
  addDeadline('Emirates ID', c.eid_expiry, 'ğŸ†”');
  // Add individual visas
  (visas||[]).forEach(v => addDeadline(`âœˆï¸ ${v.holder_name} (${v.visa_type||'Residenza'})`, v.expiry_date, 'ğŸ›‚'));

  if (!items.length) return `<div class="card"><div class="card-body"><div class="empty-state"><div class="icon">ğŸ“…</div><p>Nessuna scadenza configurata.<br>Contatta il tuo consulente per aggiornarle.</p></div></div></div>`;

  return items.map(item => {
    const cls = item.days < 0 ? 'danger' : item.days <= 60 ? 'warning' : null;
    const badgeCls = item.days < 0 ? 'badge-red' : item.days <= 60 ? 'badge-yellow' : 'badge-green';
    const badgeText = item.days < 0 ? 'Scaduto' : item.days <= 60 ? `${item.days} giorni` : 'OK';
    return `
      <div class="card" style="margin-bottom:12px">
        <div class="card-body" style="display:flex;align-items:center;gap:16px;padding:16px 24px">
          <span style="font-size:28px">${item.icon}</span>
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${item.label}</div>
            <div style="font-size:13px;color:var(--muted);margin-top:2px">${item.fmt}</div>
          </div>
          <span class="badge ${badgeCls}">${badgeText}</span>
        </div>
      </div>`;
  }).join('');
}

function setupNav() {}

function renderAll() {} // placeholder

// â”€â”€ PRATICHE CLIENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPraticheClient() {
  const el = document.getElementById('pratiche-client-content');
  if (!el) return;
  el.innerHTML = '<div class="spinner"></div>';
  try {
    if (!clientData?.id) throw new Error('Dati cliente non caricati');
    const clientId = clientData.id;

    const r = await fetch(SB_URL + '/rest/v1/client_practices?client_id=eq.' + clientId + '&select=id,title,category,status,description,due_date,completed_at,created_at&order=created_at.desc', { headers: H() });
    if (!r.ok) {
      const err = await r.json();
      throw new Error((err?.message || err?.hint || JSON.stringify(err)));
    }
    const pratiche = await r.json();
    
    const STATUSES = {
      in_attesa:      { label: 'In Attesa',         color: '#64748b', bg: '#f1f5f9', border: '#cbd5e1' },
      in_lavorazione: { label: 'In Lavorazione',    color: '#d97706', bg: '#fffbeb', border: '#fde68a' },
      attesa_docs:    { label: 'Attesa Documenti',  color: '#7c3aed', bg: '#f5f3ff', border: '#ddd6fe' },
      completato:     { label: 'âœ“ Completato',      color: '#059669', bg: '#f0fdf4', border: '#86efac' },
      annullato:      { label: 'Annullato',         color: '#dc2626', bg: '#fef2f2', border: '#fca5a5' },
    };
    const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'long',year:'numeric'}) : null;
    const badge = s => {
      const st = STATUSES[s] || STATUSES.in_attesa;
      return `<span style="display:inline-flex;align-items:center;padding:3px 12px;border-radius:100px;font-size:11px;font-weight:700;background:${st.bg};color:${st.color};border:1px solid ${st.border}">${st.label}</span>`;
    };

    if (!pratiche?.length) {
      el.innerHTML = `<div class="card"><div class="card-body"><div class="empty-state"><div class="icon">ğŸ“‹</div><p>Nessuna pratica in corso.<br>Contatta il tuo consulente per avviare una nuova pratica.</p></div></div></div>`;
      return;
    }

    el.innerHTML = pratiche.map(p => `
      <div class="card" style="margin-bottom:12px">
        <div class="card-body" style="padding:18px 24px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:8px">
            <div style="font-weight:700;font-size:15px;color:var(--navy2)">${p.title}</div>
            ${badge(p.status)}
          </div>
          ${p.category ? `<div style="display:inline-block;font-size:11px;font-weight:600;color:var(--muted);background:#f1f5f9;padding:2px 10px;border-radius:100px;margin-bottom:8px">${p.category}</div>` : ''}
          ${p.description ? `<div style="font-size:13px;color:var(--text);line-height:1.5;margin-bottom:8px">${p.description}</div>` : ''}
          <div style="font-size:12px;color:var(--muted);display:flex;gap:16px;flex-wrap:wrap">
            <span>Aperta: ${fmtDate(p.created_at)}</span>
            ${p.due_date ? `<span style="color:${new Date(p.due_date)<new Date()?'#dc2626':'var(--muted)'}">Scadenza: <strong>${fmtDate(p.due_date)}</strong></span>` : ''}
            ${p.completed_at ? `<span style="color:#059669">Completata: ${fmtDate(p.completed_at)}</span>` : ''}
          </div>
        </div>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<div class="card"><div class="card-body" style="color:#dc2626">Errore: ${e.message}</div></div>`;
  }
}

// â”€â”€ SERVIZI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function serviziHTML() {
  const services = [
    { icon: 'ğŸ¢', title: 'Company Formation', desc: 'Costituzione di societÃ  nelle principali Free Zone e Mainland UAE. FZCO, FZE, LLC e strutture holding.', tag: 'PiÃ¹ richiesto' },
    { icon: 'ğŸ“Š', title: 'VAT & Tax', desc: 'Registrazione VAT, dichiarazioni trimestrali, ottimizzazione fiscale e compliance con le normative UAE.', tag: null },
    { icon: 'ğŸ›', title: 'Corporate Tax', desc: 'Registrazione e gestione della Corporate Tax UAE (9%). Pianificazione e dichiarazioni annuali.', tag: null },
    { icon: 'ğŸŒŸ', title: 'Golden Visa', desc: 'Ottenimento del Golden Visa UAE per imprenditori, investitori e professionisti qualificati. 5 e 10 anni.', tag: 'Premium' },
    { icon: 'ğŸ”¢', title: 'ContabilitÃ ', desc: 'Gestione contabile completa, bilanci, libri contabili e reportistica finanziaria conforme agli standard UAE.', tag: null },
    { icon: 'ğŸ¦', title: 'Banking', desc: 'Apertura conti bancari aziendali e personali, supporto con Wio, Mashreq, ADCB e banche internazionali.', tag: null },
    { icon: 'ğŸ—', title: 'Real Estate', desc: 'Supporto all'investimento immobiliare a Dubai, due diligence, strutturazione acquisti off-plan e completati.', tag: null },
    { icon: 'âœˆï¸', title: 'Visa & Permessi', desc: 'Visti di residenza, visti dipendenti, Emirates ID, rinnovi e gestione completa delle pratiche immigratorie.', tag: null },
    { icon: 'ğŸ”', title: 'Crypto & VARA', desc: 'Supporto per applicazioni VARA, licenze crypto, strutturazione societÃ  per attivitÃ  con asset digitali.', tag: 'Specialistico' },
    { icon: 'ğŸ“', title: 'Contratti & Legal', desc: 'Redazione e revisione contratti commerciali, accordi tra soci, NDA, termini di servizio e documentazione legale.', tag: null },
  ];

  const cards = services.map(s => `
    <div class="srv-card">
      ${s.tag ? `<div class="srv-tag">${s.tag}</div>` : ''}
      <div class="srv-icon">${s.icon}</div>
      <div class="srv-title">${s.title}</div>
      <div class="srv-desc">${s.desc}</div>
      <a href="mailto:info@indubai.it?subject=Richiesta informazioni: ${encodeURIComponent(s.title)}&body=Buongiorno,%0D%0A%0D%0ASono interessato al servizio: ${encodeURIComponent(s.title)}%0D%0A%0D%0APer favore contattatemi per maggiori informazioni.%0D%0A%0D%0AGrazie" class="srv-btn">âœ‰ Richiedi info</a>
    </div>`).join('');

  return `
    <div style="margin-bottom:24px">
      <div class="section-title" style="margin-bottom:6px">I nostri Servizi</div>
      <p style="font-size:13px;color:var(--muted)">Hai bisogno di uno di questi servizi? Contattaci direttamente â€” il tuo consulente ti risponderÃ  entro 24 ore.</p>
    </div>
    <div class="srv-grid">${cards}</div>`;
}

// â”€â”€ NUMERI UTILI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function numeriHTML() {
  const sections = [
    {
      title: 'ğŸš¨ Emergenze',
      color: '#dc2626',
      bg: '#fef2f2',
      border: '#fca5a5',
      items: [
        { icon: 'ğŸ‘®', label: 'Polizia', number: '999' },
        { icon: 'ğŸš‘', label: 'Ambulanza', number: '998' },
        { icon: 'ğŸš’', label: 'Pompieri', number: '997' },
        { icon: 'ğŸ†˜', label: 'Emergenza Generale', number: '112' },
      ]
    },
    {
      title: 'ğŸ› Servizi Pubblici',
      color: '#0369a1',
      bg: '#f0f9ff',
      border: '#bae6fd',
      items: [
        { icon: 'âš¡', label: 'DEWA (ElettricitÃ /Acqua)', number: '04-601-9999' },
        { icon: 'ğŸ“¡', label: 'Etisalat (e&)', number: '101' },
        { icon: 'ğŸ“±', label: 'Du Telecom', number: '155' },
        { icon: 'ğŸš‡', label: 'RTA (Trasporti)', number: '800-90090' },
      ]
    },
    {
      title: 'ğŸ¥ Salute',
      color: '#059669',
      bg: '#f0fdf4',
      border: '#86efac',
      items: [
        { icon: 'ğŸ¥', label: 'DHA (SanitÃ  Dubai)', number: '800-342' },
        { icon: 'ğŸ¨', label: 'American Hospital', number: '04-336-7777' },
        { icon: 'ğŸ’Š', label: 'Mediclinic City', number: '04-435-9999' },
        { icon: 'ğŸ¦·', label: 'Velvet Medical', number: '04-388-9555' },
      ]
    },
    {
      title: 'ğŸš• MobilitÃ ',
      color: '#7c3aed',
      bg: '#f5f3ff',
      border: '#ddd6fe',
      items: [
        { icon: 'ğŸš–', label: 'Dubai Taxi', number: '04-208-0808' },
        { icon: 'ğŸ“±', label: 'Careem / Uber', number: 'App' },
        { icon: 'ğŸ›£', label: 'SALIK (Pedaggi)', number: '800-72545' },
        { icon: 'ğŸš—', label: 'RTA Patente', number: '800-90090' },
      ]
    },
    {
      title: 'ğŸ‡®ğŸ‡¹ Consolato Italiano',
      color: '#d97706',
      bg: '#fffbeb',
      border: '#fde68a',
      items: [
        { icon: 'ğŸ›', label: 'Consolato Dubai', number: '04-331-4167' },
        { icon: 'ğŸ“§', label: 'Email Consolato', number: 'dubai.consolare@esteri.it' },
        { icon: 'ğŸŒ', label: 'Prenotazione Online', number: 'prenota.esteri.it' },
        { icon: 'ğŸ†˜', label: 'Emergenze Italiani', number: '+39-06-3691-7779' },
      ]
    },
    {
      title: 'ğŸ’¼ Business & Legal',
      color: '#0f1e35',
      bg: '#f8fafc',
      border: '#e2e8f0',
      items: [
        { icon: 'ğŸ¢', label: 'DED (Licenze Dubai)', number: '04-445-5555' },
        { icon: 'ğŸ“‹', label: 'MOHRE (Lavoro)', number: '800-60' },
        { icon: 'ğŸ›ƒ', label: 'Dubai Customs', number: '04-239-9999' },
        { icon: 'ğŸ¦', label: 'UAE Central Bank', number: '800-CBUAE' },
      ]
    },
  ];

  const cards = sections.map(s => `
    <div class="card" style="margin-bottom:16px;border-color:${s.border}">
      <div class="card-header" style="background:${s.bg};border-bottom-color:${s.border}">
        <div class="card-title" style="color:${s.color}">${s.title}</div>
      </div>
      <div class="card-body" style="padding:12px 16px">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px">
          ${s.items.map(item => `
            <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fafafa;border-radius:8px;border:1px solid #f1f5f9">
              <span style="font-size:18px">${item.icon}</span>
              <div style="flex:1;min-width:0">
                <div style="font-size:11px;color:var(--muted);font-weight:600">${item.label}</div>
                <a href="${item.number.startsWith('0')||item.number.startsWith('+')||/^\d+$/.test(item.number.replace('-',''))?'tel:'+item.number.replace(/[^+0-9]/g,''):item.number.includes('@')?'mailto:'+item.number:'https://'+item.number}" 
                   style="font-size:13px;font-weight:700;color:${s.color};text-decoration:none"
                   target="${item.number.includes('.')?'_blank':'_self'}">${item.number}</a>
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>`).join('');

  return `
    <div style="margin-bottom:24px">
      <div class="section-title" style="margin-bottom:6px">Numeri Utili Dubai</div>
      <p style="font-size:13px;color:var(--muted)">Contatti essenziali per vivere e lavorare a Dubai. Toccando un numero puoi chiamare direttamente dal telefono.</p>
    </div>
    ${cards}`;
}

window.showPanel = function(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('panel-' + name);
  if (panel) panel.classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'documenti') { cwd = '/'; renderDrive(); }
  if (name === 'pratiche') loadPraticheClient();
};

async function fetchBlob(storagePath) {
  const tok = sb.getSession()?.access_token || SB_KEY;
  const r = await fetch(`${SB_URL}/storage/v1/object/authenticated/client-documents/${storagePath}`, {
    headers: { apikey: SB_KEY, Authorization: `Bearer ${tok}` }
  });
  if (!r.ok) throw new Error('HTTP ' + r.status);
  return r.blob();
}

window.downloadFile = async function(storagePath, name) {
  try {
    const blob = await fetchBlob(storagePath);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  } catch(e) { alert('Errore download: ' + e.message); }
};

window.previewFile = async function(storagePath, name, mime) {
  const modal = document.getElementById('preview-modal');
  const body  = document.getElementById('preview-body');
  const title = document.getElementById('preview-title');
  const dlBtn = document.getElementById('preview-dl-btn');

  title.textContent = name;
  body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:300px"><div class="spinner"></div></div>';
  modal.style.display = 'flex';

  dlBtn.onclick = () => downloadFile(storagePath, name);

  const ext = (name || '').split('.').pop().toLowerCase();
  const isImg = mime?.startsWith('image') || ['jpg','jpeg','png','webp','gif','bmp','svg','tiff','tif'].includes(ext);
  const isPdf = mime?.includes('pdf') || ext === 'pdf';

  if (!isImg && !isPdf) {
    const icons = {doc:'ğŸ“',docx:'ğŸ“',xls:'ğŸ“Š',xlsx:'ğŸ“Š',ppt:'ğŸ“‘',pptx:'ğŸ“‘',zip:'ğŸ—œï¸',rar:'ğŸ—œï¸',txt:'ğŸ“ƒ'};
    const ico = icons[ext] || 'ğŸ“';
    body.innerHTML = `<div style="text-align:center;padding:50px 30px">
      <div style="font-size:56px;margin-bottom:16px">${ico}</div>
      <div style="font-size:15px;font-weight:700;margin-bottom:8px;color:var(--text)">${name}</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Anteprima non disponibile â€” clicca per scaricare</div>
      <button class="btn-dl" onclick="downloadFile('${storagePath.replace(/'/g,"\'")}','${name.replace(/'/g,"\'")}')">â¬‡ Scarica file</button>
    </div>`;
    return;
  }

  try {
    const blob = await fetchBlob(storagePath);
    const url  = URL.createObjectURL(blob);
    if (isImg) {
      body.innerHTML = `<img src="${url}" style="max-width:100%;max-height:78vh;object-fit:contain;display:block;padding:16px" onload="URL.revokeObjectURL(this.src)">`;
    } else {
      body.innerHTML = `<iframe src="${url}" style="width:100%;height:78vh;border:none"></iframe>`;
    }
  } catch(e) {
    body.innerHTML = `<div style="padding:40px;text-align:center;color:#dc2626">Errore: ${e.message}</div>`;
  }
};

window.closePreview = function() {
  document.getElementById('preview-modal').style.display = 'none';
  document.getElementById('preview-body').innerHTML = '';
};

init();
</script>
<!-- Preview Modal -->
<div id="preview-modal" class="prev-overlay" onclick="if(event.target===this)closePreview()">
  <div class="prev-modal">
    <div class="prev-header">
      <div class="prev-title" id="preview-title"></div>
      <div style="display:flex;gap:8px;flex-shrink:0">
        <button class="btn-dl" id="preview-dl-btn" style="padding:7px 14px;font-size:12px">â¬‡ Scarica</button>
        <button onclick="closePreview()" style="background:none;border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;cursor:pointer;font-size:14px">âœ•</button>
      </div>
    </div>
    <div class="prev-body" id="preview-body">
      <div class="spinner"></div>
    </div>
  </div>
</div>

</body>
</html>
