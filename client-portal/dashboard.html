<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InDubai ‚Äî Il tuo Portale</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="/js/config.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy: #0f1e35;
      --navy2: #1a3a5c;
      --gold: #c9a84c;
      --gold2: #e8c97a;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #7a8ca0;
      --radius: 16px;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      background: var(--navy);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,.3);
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-mark { font-family: 'Playfair Display', serif; font-size: 22px; color: white; letter-spacing: -.5px; }
    .logo-mark span { color: var(--gold); }
    .logo-divider { width: 1px; height: 20px; background: rgba(255,255,255,.2); }
    .logo-sub { font-size: 12px; color: rgba(255,255,255,.45); font-weight: 500; letter-spacing: 1.5px; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-company { font-size: 13px; color: rgba(255,255,255,.6); font-weight: 500; }
    .btn-logout {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.7);
      padding: 7px 14px; border-radius: 8px;
      font-size: 12px; font-weight: 500; cursor: pointer;
      font-family: inherit; transition: all .2s;
    }
    .btn-logout:hover { background: rgba(255,255,255,.15); color: white; }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .layout { display: flex; min-height: calc(100vh - 64px); }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 220px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 28px 0;
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
    }
    .nav-section { padding: 0 20px 8px; font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 20px; font-size: 13px; font-weight: 500;
      color: var(--muted); cursor: pointer; border: none;
      background: none; width: 100%; text-align: left;
      font-family: inherit; transition: all .15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { color: var(--navy2); background: #f0f4f8; }
    .nav-item.active { color: var(--navy2); background: #eff6ff; border-left-color: var(--gold); font-weight: 600; }
    .nav-icon { font-size: 15px; width: 20px; text-align: center; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { flex: 1; padding: 36px 40px; max-width: 900px; }

    /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
    .hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
      border-radius: var(--radius);
      padding: 32px 36px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -40px; right: -40px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(201,168,76,.2) 0%, transparent 70%);
      border-radius: 50%;
    }
    .hero-welcome { font-size: 12px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
    .hero-title { font-family: 'Playfair Display', serif; font-size: 28px; color: white; margin-bottom: 8px; }
    .hero-sub { font-size: 13px; color: rgba(255,255,255,.5); }
    .hero-badges { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .hero-badge {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 100px;
      padding: 5px 14px;
      font-size: 12px;
      color: rgba(255,255,255,.7);
      font-weight: 500;
    }
    .hero-badge.gold { background: rgba(201,168,76,.15); border-color: rgba(201,168,76,.3); color: var(--gold2); }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .section-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: 0 1px 8px rgba(0,0,0,.04);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      padding: 18px 24px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title { font-size: 14px; font-weight: 600; color: var(--navy2); }
    .card-body { padding: 20px 24px; }

    /* Info grid */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .info-field label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; display: block; margin-bottom: 5px; }
    .info-field span { font-size: 14px; font-weight: 500; color: var(--text); }
    .info-field span.empty { color: #cbd5e1; font-style: italic; font-size: 13px; }

    /* Badges */
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 100px; font-size: 11px; font-weight: 700; }
    .badge-green { background: #f0fdf4; color: #059669; border: 1px solid #86efac; }
    .badge-yellow { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
    .badge-red { background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; }

    /* ‚îÄ‚îÄ FILE LIST ‚îÄ‚îÄ */
    .folder-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
    .folder-tab {
      padding: 6px 16px; border-radius: 100px;
      font-size: 12px; font-weight: 600;
      border: 1.5px solid var(--border);
      background: white; color: var(--muted);
      cursor: pointer; font-family: inherit; transition: all .15s;
    }
    .folder-tab:hover { border-color: var(--navy2); color: var(--navy2); }
    .folder-tab.active { background: var(--navy2); color: white; border-color: var(--navy2); }

    .file-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .file-row:last-child { border-bottom: none; }
    .file-icon { font-size: 24px; flex-shrink: 0; }
    .file-info { flex: 1; min-width: 0; }
    .file-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .btn-dl {
      flex-shrink: 0;
      padding: 7px 16px;
      background: var(--navy2); color: white;
      border: none; border-radius: 8px;
      font-size: 12px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      transition: background .15s;
    }
    .btn-dl:hover { background: var(--navy); }

    .empty-state { padding: 40px; text-align: center; color: var(--muted); }
    .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; }

    /* ‚îÄ‚îÄ PANEL VISIBILITY ‚îÄ‚îÄ */
    .panel { display: none; }
    .panel.active { display: block; }

    /* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
    .spinner { width: 28px; height: 28px; border: 3px solid #e2e8f0; border-top-color: var(--navy2); border-radius: 50%; animation: spin .7s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ SCADENZA BANNER ‚îÄ‚îÄ */
    .deadline-banner {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 20px; border-radius: 12px;
      margin-bottom: 16px; font-size: 13px; font-weight: 500;
    }
    .deadline-banner.warning { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
    .deadline-banner.danger  { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; }
  </style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-mark">In<span>Dubai</span></div>
    <div class="logo-divider"></div>
    <div class="logo-sub">Area Clienti</div>
  </div>
  <div class="header-right">
    <span class="header-company" id="header-company"></span>
    <button class="btn-logout" onclick="doLogout()">‚èª Esci</button>
  </div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="nav-section" style="margin-bottom:8px">Menu</div>
    <button class="nav-item active" onclick="showPanel('anagrafica', this)"><span class="nav-icon">üè¢</span> Anagrafica</button>
    <button class="nav-item" onclick="showPanel('documenti', this)"><span class="nav-icon">üìÅ</span> Documenti</button>
    <button class="nav-item" onclick="showPanel('scadenze', this)"><span class="nav-icon">üìÖ</span> Scadenze</button>
  </aside>

  <!-- Main content -->
  <main class="main" id="main">
    <div class="spinner"></div>
  </main>
</div>

<script src="/js/supabase.js"></script>
<script>
const SB_URL = window.ENV_SUPABASE_URL;
const SB_KEY = window.ENV_SUPABASE_ANON_KEY;
function H() {
  const tok = sb.getSession()?.access_token || SB_KEY;
  return { apikey: SB_KEY, Authorization: `Bearer ${tok}`, 'Content-Type': 'application/json' };
}
async function GET(path) {
  const r = await fetch(SB_URL + path, { headers: H() });
  return r.json();
}
async function doLogout() {
  try { await fetch(SB_URL + '/auth/v1/logout', { method: 'POST', headers: H() }); } catch {}
  localStorage.removeItem('indubai_session');
  window.location.href = '/client-portal/login.html';
}

let clientData = null;
let allFiles = [];

async function init() {
  const sess = sb.getSession();
  if (!sess?.access_token) { window.location.href = '/client-portal/login.html'; return; }

  try {
    // Get client_id
    const links = await GET(`/rest/v1/client_users?user_id=eq.${sess.user.id}&select=client_id`);
    if (!links?.length) throw new Error('Nessun cliente collegato. Contatta il tuo consulente.');
    const clientId = links[0].client_id;

    // Load client
    const clients = await GET(`/rest/v1/clients?id=eq.${clientId}&select=*`);
    clientData = clients?.[0];
    if (!clientData) throw new Error('Dati aziendali non trovati.');

    // Load files
    allFiles = await GET(`/rest/v1/client_files?client_id=eq.${clientId}&select=id,display_name,file_size,mime_type,folder,storage_path,created_at&order=created_at.desc`) || [];

    // Set header
    document.getElementById('header-company').textContent = clientData.company_name;

    // Render all panels
    renderAll();
    document.getElementById('main').innerHTML = buildMainHTML();
    setupNav();

  } catch(e) {
    document.getElementById('main').innerHTML = `<div style="padding:40px;text-align:center;color:#dc2626">${e.message}</div>`;
  }
}

function buildMainHTML() {
  return `
    <!-- ANAGRAFICA -->
    <div class="panel active" id="panel-anagrafica">
      ${heroHTML()}
      ${anagraficaHTML()}
    </div>

    <!-- DOCUMENTI -->
    <div class="panel" id="panel-documenti">
      <div class="section-title" style="margin-bottom:20px">I tuoi Documenti</div>
      ${documentiHTML()}
    </div>

    <!-- SCADENZE -->
    <div class="panel" id="panel-scadenze">
      <div class="section-title" style="margin-bottom:20px">Scadenze Importanti</div>
      ${scadenzeHTML()}
    </div>
  `;
}

function heroHTML() {
  const c = clientData;
  const badges = [];
  if (c.free_zone) badges.push({ text: c.free_zone, gold: true });
  if (c.company_type) badges.push({ text: c.company_type });
  if (c.vat_registered) badges.push({ text: '‚úì VAT Registrata', gold: true });

  return `
    <div class="hero">
      <div class="hero-welcome">Bentornato</div>
      <div class="hero-title">${c.company_name}</div>
      <div class="hero-sub">Il tuo spazio personale InDubai ‚Äî anagrafica, documenti e scadenze</div>
      ${badges.length ? `<div class="hero-badges">${badges.map(b => `<span class="hero-badge${b.gold?' gold':''}">${b.text}</span>`).join('')}</div>` : ''}
    </div>`;
}

function anagraficaHTML() {
  const c = clientData;
  const f = (label, val) => `
    <div class="info-field">
      <label>${label}</label>
      <span class="${val ? '' : 'empty'}">${val || 'Non disponibile'}</span>
    </div>`;
  const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'numeric'}) : null;

  // License expiry badge
  let licBadge = '';
  if (c.trade_license_date) {
    const days = Math.round((new Date(c.trade_license_date) - new Date()) / 86400000);
    if (days < 0) licBadge = ' <span class="badge badge-red">Scaduta</span>';
    else if (days <= 60) licBadge = ` <span class="badge badge-yellow">Scade in ${days}gg</span>`;
    else licBadge = ' <span class="badge badge-green">Attiva</span>';
  }

  return `
    <div class="card">
      <div class="card-header"><div class="card-title">üè¢ Dati Aziendali</div></div>
      <div class="card-body">
        <div class="info-grid">
          ${f('Ragione Sociale', c.company_name)}
          ${f('Tipo Societ√†', c.company_type)}
          ${f('Free Zone', c.free_zone)}
          ${f('N. Licenza', c.license_number)}
          <div class="info-field"><label>Scadenza Licenza</label><span>${fmtDate(c.trade_license_date) || '<span class="empty">Non disponibile</span>'}${licBadge}</span></div>
          <div class="info-field"><label>Stato VAT</label><span>${c.vat_registered ? '<span class="badge badge-green">‚úì Registrata</span>' : '<span class="badge badge-yellow">Non registrata</span>'}</span></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üë§ Contatto Principale</div></div>
      <div class="card-body">
        <div class="info-grid">
          ${f('Referente', c.contact_name)}
          ${f('Email', c.email)}
          ${f('Telefono', c.phone || c.phone_uae)}
          ${f('Nazionalit√†', c.nationality)}
          ${f('Passaporto (scad.)', fmtDate(c.passport_expiry))}
          ${f('Emirates ID (scad.)', fmtDate(c.eid_expiry))}
        </div>
      </div>
    </div>`;
}

function documentiHTML() {
  if (!allFiles.length) return `
    <div class="card"><div class="card-body">
      <div class="empty-state"><div class="icon">üìÇ</div><p>Nessun documento disponibile.<br>Il tuo consulente caricher√† i documenti qui.</p></div>
    </div></div>`;

  const folders = [...new Set(allFiles.map(f => f.folder || 'Generale'))].sort();
  const icons = { 'Generale':'üìÅ','Contratti':'üìù','Licenze':'ü™™','Visas':'‚úàÔ∏è','Contabilit√†':'üìä','Bancario':'üè¶','Legale':'‚öñÔ∏è','Societario':'üè¢' };
  const mimeIcon = m => m?.includes('pdf') ? 'üìÑ' : m?.includes('image') ? 'üñºÔ∏è' : m?.includes('word') ? 'üìù' : m?.includes('excel') || m?.includes('sheet') ? 'üìä' : m?.includes('zip') ? 'üóúÔ∏è' : 'üìé';
  const fmtSize = b => !b ? '' : b > 1048576 ? (b/1048576).toFixed(1)+' MB' : (b/1024).toFixed(0)+' KB';
  const fmtDate = d => new Date(d).toLocaleDateString('it-IT');

  const tabsHTML = `<div class="folder-tabs">${folders.map((f,i) => 
    `<button class="folder-tab${i===0?' active':''}" onclick="selectFolder('${f}', this)">${icons[f]||'üìÅ'} ${f} <span style="opacity:.6;font-size:11px">${allFiles.filter(x=>(x.folder||'Generale')===f).length}</span></button>`
  ).join('')}</div>`;

  const firstFolder = folders[0];
  const filesHTML = (folder) => allFiles.filter(f => (f.folder||'Generale') === folder).map(f => `
    <div class="file-row">
      <span class="file-icon">${mimeIcon(f.mime_type)}</span>
      <div class="file-info">
        <div class="file-name">${f.display_name}</div>
        <div class="file-meta">${fmtDate(f.created_at)}${f.file_size ? ' ¬∑ ' + fmtSize(f.file_size) : ''}</div>
      </div>
      <button class="btn-dl" onclick="downloadFile('${f.storage_path}','${f.display_name.replace(/'/g,'')}')">‚¨á Scarica</button>
    </div>`).join('');

  return `<div class="card">
    <div class="card-body">
      ${tabsHTML}
      <div id="file-list">${filesHTML(firstFolder)}</div>
    </div>
  </div>`;
}

function scadenzeHTML() {
  const c = clientData;
  const items = [];
  const today = new Date();
  const addDeadline = (label, dateStr, icon) => {
    if (!dateStr) return;
    const d = new Date(dateStr);
    const days = Math.round((d - today) / 86400000);
    const fmt = d.toLocaleDateString('it-IT', {day:'2-digit',month:'long',year:'numeric'});
    items.push({ label, fmt, days, icon });
  };
  addDeadline('Licenza Aziendale', c.trade_license_date, 'ü™™');
  addDeadline('Passaporto', c.passport_expiry, 'üìò');
  addDeadline('Emirates ID', c.eid_expiry, 'üÜî');
  addDeadline('Visto di Residenza', c.visa_expiry, '‚úàÔ∏è');

  if (!items.length) return `<div class="card"><div class="card-body"><div class="empty-state"><div class="icon">üìÖ</div><p>Nessuna scadenza configurata.<br>Contatta il tuo consulente per aggiornarle.</p></div></div></div>`;

  return items.map(item => {
    const cls = item.days < 0 ? 'danger' : item.days <= 60 ? 'warning' : null;
    const badgeCls = item.days < 0 ? 'badge-red' : item.days <= 60 ? 'badge-yellow' : 'badge-green';
    const badgeText = item.days < 0 ? 'Scaduto' : item.days <= 60 ? `${item.days} giorni` : 'OK';
    return `
      <div class="card" style="margin-bottom:12px">
        <div class="card-body" style="display:flex;align-items:center;gap:16px;padding:16px 24px">
          <span style="font-size:28px">${item.icon}</span>
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${item.label}</div>
            <div style="font-size:13px;color:var(--muted);margin-top:2px">${item.fmt}</div>
          </div>
          <span class="badge ${badgeCls}">${badgeText}</span>
        </div>
      </div>`;
  }).join('');
}

function setupNav() {
  // folder tabs
  window.selectFolder = (name, btn) => {
    document.querySelectorAll('.folder-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const mimeIcon = m => m?.includes('pdf') ? 'üìÑ' : m?.includes('image') ? 'üñºÔ∏è' : m?.includes('word') ? 'üìù' : m?.includes('excel') ? 'üìä' : 'üìé';
    const fmtSize = b => !b ? '' : b > 1048576 ? (b/1048576).toFixed(1)+' MB' : (b/1024).toFixed(0)+' KB';
    const fmtDate = d => new Date(d).toLocaleDateString('it-IT');
    const files = allFiles.filter(f => (f.folder||'Generale') === name);
    document.getElementById('file-list').innerHTML = files.length
      ? files.map(f => `<div class="file-row"><span class="file-icon">${mimeIcon(f.mime_type)}</span><div class="file-info"><div class="file-name">${f.display_name}</div><div class="file-meta">${fmtDate(f.created_at)}${f.file_size?' ¬∑ '+fmtSize(f.file_size):''}</div></div><button class="btn-dl" onclick="downloadFile('${f.storage_path}','${f.display_name.replace(/'/g,'')}')">‚¨á Scarica</button></div>`).join('')
      : '<div class="empty-state"><p>Nessun file in questa cartella</p></div>';
  };
}

function renderAll() {} // placeholder

window.showPanel = function(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('panel-' + name);
  if (panel) panel.classList.add('active');
  if (btn) btn.classList.add('active');
};

window.downloadFile = async function(storagePath, name) {
  const tok = sb.getSession()?.access_token || SB_KEY;
  const r = await fetch(`${SB_URL}/storage/v1/object/authenticated/client-docs/${storagePath}`, {
    headers: { apikey: SB_KEY, Authorization: `Bearer ${tok}` }
  });
  if (!r.ok) { alert('Errore download'); return; }
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
};

init();
</script>
</body>
</html>
