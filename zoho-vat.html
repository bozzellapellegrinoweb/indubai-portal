<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor VAT ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .vat-bar-wrap { background:#e2e8f0; border-radius:100px; height:7px; overflow:hidden; flex:1; min-width:80px; }
    .vat-bar { height:100%; border-radius:100px; transition:width .4s ease; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">üìä Monitor VAT ‚Äî Soglia AED 375.000</div>
        <div class="topbar-subtitle">Fatturato ultimi 12 mesi per tutti i clienti collegati a Zoho Books</div>
      </div>
      <div class="toolbar">
        <span id="sync-status" style="font-size:12px;color:var(--text-muted)"></span>
        <button class="btn btn-primary" onclick="syncNow()" id="sync-btn">‚ü≥ Aggiorna ora</button>
      </div>
    </div>

    <div class="page-content">

      <!-- KPI cards -->
      <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr)">
        <div class="kpi-card danger" style="background:linear-gradient(135deg,#7f1d1d,#dc2626);border:none" onclick="setFilter('exceeded')" >
          <div class="kpi-label" style="color:rgba(255,255,255,.65)">üö® Soglia Superata</div>
          <div class="kpi-value" id="cnt-exceeded" style="color:white">‚Äî</div>
          <div class="kpi-sub" style="color:rgba(255,255,255,.6)">VAT obbligatoria oltre AED 375k</div>
        </div>
        <div class="kpi-card" style="background:linear-gradient(135deg,#78350f,#d97706);border:none" onclick="setFilter('warning')">
          <div class="kpi-label" style="color:rgba(255,255,255,.65)">‚ö†Ô∏è In Avvicinamento</div>
          <div class="kpi-value" id="cnt-warning" style="color:white">‚Äî</div>
          <div class="kpi-sub" style="color:rgba(255,255,255,.6)">Oltre AED 300.000</div>
        </div>
        <div class="kpi-card success" onclick="setFilter('all')">
          <div class="kpi-label">‚úì Sotto Soglia</div>
          <div class="kpi-value" id="cnt-ok">‚Äî</div>
          <div class="kpi-sub">Sotto AED 300.000</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="toolbar" style="margin-bottom:16px;justify-content:flex-start;gap:8px">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" class="form-control" id="search-vat" placeholder="Cerca cliente..." style="min-width:220px" oninput="renderTable()">
        </div>
        <button class="btn btn-primary btn-sm" id="f-all"      onclick="setFilter('all')">Tutti</button>
        <button class="btn btn-sm"             id="f-exceeded" onclick="setFilter('exceeded')" style="color:#dc2626;border-color:#dc2626">üö® Soglia superata</button>
        <button class="btn btn-sm"             id="f-warning"  onclick="setFilter('warning')"  style="color:#d97706;border-color:#d97706">‚ö†Ô∏è In avvicinamento</button>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="last-update"></span>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th style="text-align:right;cursor:pointer" onclick="toggleSort()">Ultimi 12m (AED) <span id="sort-icon">‚Üï</span></th>
              <th style="min-width:180px">Soglia</th>
              <th style="text-align:center">Status</th>
              <th style="text-align:center">VAT</th>
              <th style="text-align:center">Aggiornato</th>
            </tr>
          </thead>
          <tbody id="vat-tbody">
            <tr><td colspan="6" style="padding:40px;text-align:center"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let allRows = [], currentFilter = 'all', sortDir = 'desc';

async function load() {
  try {
    const [snapshots, clients] = await Promise.all([
      sb.db.select('zoho_snapshots', { columns: 'client_id,rolling12_aed,vat_status,updated_at,count_invoices' }),
      sb.db.select('clients', { columns: 'id,company_name,vat_registered', filter: 'zoho_org_id=not.is.null&is_active=eq.true', order: 'company_name.asc' })
    ]);

    const snapMap = {};
    (snapshots||[]).forEach(s => snapMap[s.client_id] = s);

    allRows = (clients||[]).map(cl => ({
      id:             cl.id,
      name:           cl.company_name,
      vat_registered: cl.vat_registered,
      rolling12:      snapMap[cl.id]?.rolling12_aed ?? null,
      vat_status:     snapMap[cl.id]?.vat_status || 'unknown',
      updated_at:     snapMap[cl.id]?.updated_at || null,
    }));

    updateCounts();
    renderTable();
    document.getElementById('sync-status').textContent = allRows.filter(r => r.rolling12 !== null).length + ' clienti sincronizzati';
  } catch(e) {
    document.getElementById('vat-tbody').innerHTML = `<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--danger)">Errore: ${e.message}</td></tr>`;
  }
}

function updateCounts() {
  document.getElementById('cnt-exceeded').textContent = allRows.filter(r => r.vat_status === 'exceeded' && !r.vat_registered).length;
  document.getElementById('cnt-warning').textContent  = allRows.filter(r => r.vat_status === 'warning'  && !r.vat_registered).length;
  document.getElementById('cnt-ok').textContent       = allRows.filter(r => r.vat_status === 'ok' || r.vat_registered).length;
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('#f-all,#f-exceeded,#f-warning').forEach(b => {
    b.classList.toggle('btn-primary', b.id === 'f-' + f);
  });
  renderTable();
}

function toggleSort() {
  sortDir = sortDir === 'desc' ? 'asc' : 'desc';
  document.getElementById('sort-icon').textContent = sortDir === 'desc' ? '‚Üì' : '‚Üë';
  renderTable();
}

function renderTable() {
  const q = (document.getElementById('search-vat').value || '').toLowerCase();
  let rows = allRows.filter(r => {
    if (q && !r.name.toLowerCase().includes(q)) return false;
    if (currentFilter !== 'all' && r.vat_status !== currentFilter) return false;
    return true;
  });
  rows.sort((a, b) => {
    const av = a.rolling12 ?? -1, bv = b.rolling12 ?? -1;
    return sortDir === 'desc' ? bv - av : av - bv;
  });

  const fmt = n => n === null ? '‚Äî' : new Intl.NumberFormat('it-IT', {maximumFractionDigits:0}).format(n);
  const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
  const VAT = 375000;
  const tbody = document.getElementById('vat-tbody');

  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:40px;text-align:center;color:var(--text-muted)">Nessun risultato</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const pct   = r.rolling12 !== null ? Math.min(100, Math.round(r.rolling12 / VAT * 100)) : 0;
    const color = r.vat_status==='exceeded' ? 'var(--danger)' : r.vat_status==='warning' ? '#d97706' : r.rolling12===null ? 'var(--text-muted)' : 'var(--success)';
    
    const statusBadge = r.vat_registered
      ? '<span class="badge success">‚úì Registrata</span>'
      : r.vat_status==='exceeded'
      ? '<span class="badge danger">üö® Superata</span>'
      : r.vat_status==='warning'
      ? '<span class="badge warning">‚ö†Ô∏è Vicino</span>'
      : r.rolling12===null
      ? '<span class="badge">Non sincronizzato</span>'
      : '<span class="badge success">‚úì OK</span>';

    const vatBadge = r.vat_registered
      ? '<span class="badge success">‚úì Registrata</span>'
      : r.vat_status === 'ok'
      ? '<span style="color:var(--text-muted)">‚Äî</span>'
      : `<button onclick="event.stopPropagation();markVATDone('${r.id}')" class="btn btn-sm" style="color:#d97706;border-color:#d97706">Registra</button>`;

    return `<tr style="cursor:pointer" onclick="window.location='/client-detail?id=${r.id}'">
      <td style="font-weight:600">${r.name}</td>
      <td style="text-align:right;font-weight:700;color:${color}">AED ${fmt(r.rolling12)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="vat-bar-wrap"><div class="vat-bar" style="width:${pct}%;background:${color}"></div></div>
          <span style="font-size:11px;color:var(--text-muted);min-width:34px">${pct}%</span>
        </div>
      </td>
      <td style="text-align:center">${statusBadge}</td>
      <td style="text-align:center">${vatBadge}</td>
      <td style="text-align:center;font-size:11px;color:var(--text-muted)">${fmtDate(r.updated_at)}</td>
    </tr>`;
  }).join('');
}

async function markVATDone(clientId) {
  if (!confirm('Confermi che la VAT √® stata registrata?')) return;
  try {
    await sb.db.update('clients', `id=eq.${clientId}`, { vat_registered: true });
    const row = allRows.find(r => r.id === clientId);
    if (row) row.vat_registered = true;
    renderTable();
    updateCounts();
  } catch(e) { alert('Errore: ' + e.message); }
}

async function syncNow() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true; btn.textContent = '‚ü≥ Sincronizzazione...';
  document.getElementById('sync-status').textContent = 'Aggiornamento in corso...';
  try {
    const res = await fetch('https://gvdoqcgkzbziqufahhxh.supabase.co/functions/v1/bright-service', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + window.ENV_SUPABASE_ANON_KEY },
      body: JSON.stringify({ action: 'cron_sync' })
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    document.getElementById('sync-status').textContent = `‚úÖ Sincronizzati ${d.synced} clienti`;
    await load();
  } catch(e) {
    document.getElementById('sync-status').textContent = '‚ùå ' + e.message;
  }
  btn.disabled = false; btn.textContent = '‚ü≥ Aggiorna ora';
}

document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
