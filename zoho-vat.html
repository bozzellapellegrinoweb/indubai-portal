<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor VAT ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .vat-bar-wrap { background:#f1f5f9; border-radius:100px; height:8px; overflow:hidden; flex:1; min-width:80px; }
    .vat-bar      { height:100%; border-radius:100px; transition:width .4s ease; }
    .badge-exceeded { background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; }
    .badge-warning  { background:#fef3c7; color:#d97706; border:1px solid #fde68a; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; }
    .badge-ok       { background:#d1fae5; color:#059669; border:1px solid #6ee7b7; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; }
    .filter-pill { background:none; border:1.5px solid var(--border); border-radius:20px; padding:4px 14px; font-size:12px; cursor:pointer; font-weight:600; color:var(--text-muted); }
    .filter-pill.active { background:var(--accent); color:white; border-color:var(--accent); }
    tbody tr:hover { background:#f8fafc; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">üìä Monitor VAT ‚Äî Soglia AED 375.000</div>
        <div class="topbar-subtitle">Fatturato ultimi 12 mesi per tutti i clienti collegati a Zoho Books</div>
      </div>
      <div class="toolbar">
        <span id="sync-status" style="font-size:12px;color:var(--text-muted)"></span>
        <button class="btn btn-accent" onclick="syncNow()" id="sync-btn">‚ü≥ Aggiorna ora</button>
      </div>
    </div>

    <div class="content-body">

      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;max-width:100%">
        <div class="stat-card" style="background:linear-gradient(135deg,#7f1d1d,#dc2626);color:white">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.65);margin-bottom:6px">üö® Soglia Superata</div>
          <div style="font-size:32px;font-weight:800" id="cnt-exceeded">‚Äî</div>
          <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px">VAT obbligatoria oltre AED 375k</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#78350f,#d97706);color:white">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.65);margin-bottom:6px">‚ö†Ô∏è In Avvicinamento</div>
          <div style="font-size:32px;font-weight:800" id="cnt-warning">‚Äî</div>
          <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px">Oltre AED 300.000</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-bottom:6px">‚úì Sotto Soglia</div>
          <div style="font-size:32px;font-weight:800;color:var(--text)" id="cnt-ok">‚Äî</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Sotto AED 300.000</div>
        </div>
      </div>

      <!-- Filters -->
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
        <input type="text" id="search-vat" placeholder="üîç Cerca cliente..." 
          style="border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;font-size:13px;width:220px" 
          oninput="renderTable()">
        <button class="filter-pill active" id="f-all"      onclick="setFilter('all')">Tutti</button>
        <button class="filter-pill"        id="f-exceeded" onclick="setFilter('exceeded')">üö® Soglia superata</button>
        <button class="filter-pill"        id="f-warning"  onclick="setFilter('warning')">‚ö†Ô∏è In avvicinamento</button>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="last-update"></span>
      </div>

      <!-- Table -->
      <div class="table-card">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr>
              <th style="padding:12px 16px;text-align:left">Cliente</th>
              <th style="padding:12px 16px;text-align:right;cursor:pointer" onclick="toggleSort()">
                Ultimi 12m (AED) <span id="sort-icon">‚Üï</span>
              </th>
              <th style="padding:12px 16px;text-align:left;min-width:180px">Soglia</th>
              <th style="padding:12px 16px;text-align:center">Status</th>
              <th style="padding:12px 16px;text-align:center">VAT</th>
              <th style="padding:12px 16px;text-align:center">Aggiornato</th>
            </tr>
          </thead>
          <tbody id="vat-tbody">
            <tr><td colspan="6" style="padding:40px;text-align:center"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let allRows = [], currentFilter = 'all', sortDir = 'desc';

async function load() {
  try {
    const [snapshots, clients] = await Promise.all([
      sb.db.select('zoho_snapshots', { columns: 'client_id,rolling12_aed,vat_status,updated_at,count_invoices' }),
      sb.db.select('clients', { columns: 'id,company_name,vat_registered', filter: 'zoho_org_id=not.is.null&is_active=eq.true', order: 'company_name.asc' })
    ]);

    const snapMap = {};
    snapshots.forEach(s => snapMap[s.client_id] = s);

    allRows = clients.map(cl => ({
      id:             cl.id,
      name:           cl.company_name,
      vat_registered: cl.vat_registered,
      rolling12:      snapMap[cl.id]?.rolling12_aed ?? null,
      vat_status:     snapMap[cl.id]?.vat_status || 'unknown',
      updated_at:     snapMap[cl.id]?.updated_at || null,
    }));

    updateCounts();
    renderTable();
    document.getElementById('sync-status').textContent = allRows.filter(r => r.rolling12 !== null).length + ' clienti sincronizzati';
  } catch(e) {
    document.getElementById('vat-tbody').innerHTML =
      `<tr><td colspan="6" style="padding:20px;text-align:center;color:#dc2626">Errore: ${e.message}</td></tr>`;
  }
}

function updateCounts() {
  document.getElementById('cnt-exceeded').textContent = allRows.filter(r => r.vat_status === 'exceeded').length;
  document.getElementById('cnt-warning').textContent  = allRows.filter(r => r.vat_status === 'warning').length;
  document.getElementById('cnt-ok').textContent       = allRows.filter(r => r.vat_status === 'ok').length;
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
  document.getElementById('f-' + f).classList.add('active');
  renderTable();
}

function toggleSort() {
  sortDir = sortDir === 'desc' ? 'asc' : 'desc';
  document.getElementById('sort-icon').textContent = sortDir === 'desc' ? '‚Üì' : '‚Üë';
  renderTable();
}

function renderTable() {
  const q = (document.getElementById('search-vat').value || '').toLowerCase();
  let rows = allRows.filter(r => {
    if (q && !r.name.toLowerCase().includes(q)) return false;
    if (currentFilter !== 'all' && r.vat_status !== currentFilter) return false;
    return true;
  });
  rows.sort((a, b) => {
    const av = a.rolling12 ?? -1, bv = b.rolling12 ?? -1;
    return sortDir === 'desc' ? bv - av : av - bv;
  });

  const fmt = n => n === null ? '‚Äî' : new Intl.NumberFormat('it-IT', {maximumFractionDigits:0}).format(n);
  const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
  const VAT = 375000;
  const tbody = document.getElementById('vat-tbody');

  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:40px;text-align:center;color:var(--text-muted)">Nessun risultato</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const pct   = r.rolling12 !== null ? Math.min(100, Math.round(r.rolling12 / VAT * 100)) : 0;
    const color = r.vat_status==='exceeded' ? '#dc2626' : r.vat_status==='warning' ? '#d97706' : r.rolling12===null ? '#94a3b8' : '#059669';
    const badge = r.vat_status==='exceeded'
      ? '<span class="badge-exceeded">üö® Superata</span>'
      : r.vat_status==='warning'
      ? '<span class="badge-warning">‚ö†Ô∏è Vicino</span>'
      : r.rolling12===null
      ? '<span style="font-size:11px;color:#94a3b8">Non sincronizzato</span>'
      : '<span class="badge-ok">‚úì OK</span>';
    const vatBadge = r.vat_registered
      ? '<span class="badge-ok">‚úì Registrata</span>'
      : r.vat_status === 'ok'
      ? '<span style="color:#94a3b8;font-size:11px">‚Äî</span>'
      : `<button onclick="event.stopPropagation();markVATDone('${r.id}')" 
           style="font-size:11px;padding:4px 10px;border-radius:6px;border:1.5px solid #d97706;color:#d97706;background:white;cursor:pointer;font-weight:600">
           Registra
         </button>`;

    return `<tr style="border-bottom:1px solid var(--border);cursor:pointer" onclick="window.location='/client-detail?id=${r.id}'">
      <td style="padding:12px 16px;font-weight:600">${r.name}</td>
      <td style="padding:12px 16px;text-align:right;font-weight:700;color:${color};font-size:14px">AED ${fmt(r.rolling12)}</td>
      <td style="padding:12px 16px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="vat-bar-wrap"><div class="vat-bar" style="width:${pct}%;background:${color}"></div></div>
          <span style="font-size:11px;color:var(--text-muted);min-width:36px">${pct}%</span>
        </div>
      </td>
      <td style="padding:12px 16px;text-align:center">${badge}</td>
      <td style="padding:12px 16px;text-align:center">${vatBadge}</td>
      <td style="padding:12px 16px;text-align:center;font-size:11px;color:var(--text-muted)">${fmtDate(r.updated_at)}</td>
    </tr>`;
  }).join('');
}

async function markVATDone(clientId) {
  if (!confirm('Confermi che la VAT √® stata registrata?')) return;
  try {
    await sb.db.update('clients', `id=eq.${clientId}`, { vat_registered: true });
    const row = allRows.find(r => r.id === clientId);
    if (row) row.vat_registered = true;
    renderTable();
  } catch(e) { alert('Errore: ' + e.message); }
}

async function syncNow() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true; btn.textContent = '‚ü≥ Sincronizzazione...';
  document.getElementById('sync-status').textContent = 'Aggiornamento in corso...';
  try {
    const res = await fetch('https://gvdoqcgkzbziqufahhxh.supabase.co/functions/v1/bright-service', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + window.ENV_SUPABASE_ANON_KEY,
      },
      body: JSON.stringify({ action: 'cron_sync' })
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    document.getElementById('sync-status').textContent = `‚úÖ Sincronizzati ${d.synced} clienti${d.errors ? ` (${d.errors} errori)` : ''}`;
    await load();
  } catch(e) {
    document.getElementById('sync-status').textContent = '‚ùå ' + e.message;
  }
  btn.disabled = false; btn.textContent = '‚ü≥ Aggiorna ora';
}

document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
