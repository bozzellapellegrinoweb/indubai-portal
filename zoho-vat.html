<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Monitor VAT ‚Äî InDubai Portal</title>
  <script src="/js/config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .vat-bar-wrap { background:#f1f5f9; border-radius:100px; height:8px; overflow:hidden; flex:1; min-width:80px; }
    .vat-bar      { height:100%; border-radius:100px; transition:width .4s ease; }
    .badge-exceeded { background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; }
    .badge-warning  { background:#fef3c7; color:#d97706; border:1px solid #fde68a; }
    .badge-ok       { background:#d1fae5; color:#059669; border:1px solid #6ee7b7; }
    .sort-btn       { background:none; border:none; cursor:pointer; font-size:11px; color:var(--text-muted); padding:2px 6px; border-radius:4px; }
    .sort-btn.active { background:var(--accent); color:white; }
    .filter-row     { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search-vat     { border:1.5px solid var(--border); border-radius:8px; padding:7px 12px; font-size:13px; width:220px; }
    tbody tr:hover  { background:#f8fafc; }
  </style>
</head>
<body>
<div id="portal-root"></div>

<div class="page-wrap">
  <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:24px">
    <div>
      <h1 style="margin:0;font-size:20px;font-weight:800">üìä Monitor VAT ‚Äî Soglia AED 375.000</h1>
      <p style="margin:4px 0 0;font-size:13px;color:var(--text-muted)">Fatturato ultimi 12 mesi per tutti i clienti collegati a Zoho Books</p>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="sync-status" style="font-size:12px;color:var(--text-muted)"></span>
      <button class="btn btn-accent btn-sm" onclick="syncNow()" id="sync-btn">‚ü≥ Aggiorna ora</button>
    </div>
  </div>

  <!-- Stats row -->
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
    <div class="kpi-card" style="background:linear-gradient(135deg,#7f1d1d,#dc2626);color:white;border:none">
      <div class="kpi-label" style="color:rgba(255,255,255,.7)">üö® Soglia Superata</div>
      <div class="kpi-value" id="cnt-exceeded" style="color:white;font-size:28px">‚Äî</div>
      <div class="kpi-sub" style="color:rgba(255,255,255,.6)">VAT obbligatoria</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#78350f,#d97706);color:white;border:none">
      <div class="kpi-label" style="color:rgba(255,255,255,.7)">‚ö†Ô∏è In Avvicinamento</div>
      <div class="kpi-value" id="cnt-warning" style="color:white;font-size:28px">‚Äî</div>
      <div class="kpi-sub" style="color:rgba(255,255,255,.6)">Oltre AED 300.000</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">‚úì Sotto Soglia</div>
      <div class="kpi-value" id="cnt-ok" style="font-size:28px">‚Äî</div>
      <div class="kpi-sub">Sotto AED 300.000</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-row" style="margin-bottom:16px">
    <input type="text" class="search-vat" id="search-vat" placeholder="üîç Cerca cliente..." oninput="renderTable()">
    <div style="display:flex;gap:6px">
      <button class="sort-btn active" id="f-all"      onclick="setFilter('all')">Tutti</button>
      <button class="sort-btn"        id="f-exceeded" onclick="setFilter('exceeded')" style="color:#dc2626">üö® Soglia superata</button>
      <button class="sort-btn"        id="f-warning"  onclick="setFilter('warning')"  style="color:#d97706">‚ö†Ô∏è In avvicinamento</button>
    </div>
    <div style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="last-update"></div>
  </div>

  <!-- Table -->
  <div class="card" style="padding:0;overflow:hidden">
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="background:#f8fafc;border-bottom:2px solid var(--border)">
          <th style="padding:12px 16px;text-align:left;font-weight:700">Cliente</th>
          <th style="padding:12px 16px;text-align:right;font-weight:700">
            Ultimi 12m (AED)
            <button class="sort-btn" onclick="toggleSort()" id="sort-btn">‚Üï</button>
          </th>
          <th style="padding:12px 16px;text-align:left;font-weight:700;min-width:200px">Soglia</th>
          <th style="padding:12px 16px;text-align:center;font-weight:700">Status</th>
          <th style="padding:12px 16px;text-align:center;font-weight:700">VAT</th>
          <th style="padding:12px 16px;text-align:center;font-weight:700">Aggiornato</th>
        </tr>
      </thead>
      <tbody id="vat-tbody">
        <tr><td colspan="6" style="padding:40px;text-align:center"><div class="spinner"></div></td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let allRows = [], currentFilter = 'all', sortDir = 'desc';

async function load() {
  try {
    const [snapshotsRes, clientsRes] = await Promise.all([
      sb.db.select('zoho_snapshots', '*, clients(id, company_name, vat_registered)'),
      sb.db.select('clients', 'id, company_name, vat_registered', 'zoho_org_id=not.is.null&is_active=eq.true&order=company_name.asc')
    ]);

    const snapMap = {};
    (snapshotsRes.data || []).forEach(s => snapMap[s.client_id] = s);

    allRows = (clientsRes.data || []).map(cl => ({
      id:             cl.id,
      name:           cl.company_name,
      vat_registered: cl.vat_registered,
      rolling12:      snapMap[cl.id]?.rolling12_aed ?? null,
      vat_status:     snapMap[cl.id]?.vat_status || 'unknown',
      updated_at:     snapMap[cl.id]?.updated_at || null,
      count_invoices: snapMap[cl.id]?.count_invoices || 0,
    }));

    updateCounts();
    renderTable();
    document.getElementById('sync-status').textContent = allRows.filter(r => r.rolling12 !== null).length + ' clienti sincronizzati';
  } catch(e) {
    document.getElementById('vat-tbody').innerHTML = `<tr><td colspan="6" style="padding:20px;text-align:center;color:#dc2626">Errore: ${e.message}</td></tr>`;
  }
}

function updateCounts() {
  document.getElementById('cnt-exceeded').textContent = allRows.filter(r => r.vat_status === 'exceeded').length;
  document.getElementById('cnt-warning').textContent  = allRows.filter(r => r.vat_status === 'warning').length;
  document.getElementById('cnt-ok').textContent       = allRows.filter(r => r.vat_status === 'ok').length;
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.sort-btn[id^=f-]').forEach(b => b.classList.remove('active'));
  document.getElementById('f-' + f).classList.add('active');
  renderTable();
}

function toggleSort() {
  sortDir = sortDir === 'desc' ? 'asc' : 'desc';
  document.getElementById('sort-btn').textContent = sortDir === 'desc' ? '‚Üì' : '‚Üë';
  renderTable();
}

function renderTable() {
  const q = document.getElementById('search-vat').value.toLowerCase();
  let rows = allRows.filter(r => {
    if (q && !r.name.toLowerCase().includes(q)) return false;
    if (currentFilter !== 'all' && r.vat_status !== currentFilter) return false;
    return true;
  });
  rows.sort((a, b) => {
    const av = a.rolling12 ?? -1, bv = b.rolling12 ?? -1;
    return sortDir === 'desc' ? bv - av : av - bv;
  });

  const fmt     = n => n === null ? '‚Äî' : new Intl.NumberFormat('it-IT', {maximumFractionDigits:0}).format(n);
  const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
  const VAT = 375000;
  const tbody = document.getElementById('vat-tbody');

  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:40px;text-align:center;color:var(--text-muted)">Nessun risultato</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const pct   = r.rolling12 !== null ? Math.min(100, Math.round(r.rolling12 / VAT * 100)) : 0;
    const color = r.vat_status==='exceeded' ? '#dc2626' : r.vat_status==='warning' ? '#d97706' : r.rolling12===null ? '#94a3b8' : '#059669';
    const badge = r.vat_status==='exceeded'
      ? '<span class="badge badge-exceeded">üö® Superata</span>'
      : r.vat_status==='warning'
      ? '<span class="badge badge-warning">‚ö†Ô∏è Vicino</span>'
      : r.rolling12===null
      ? '<span class="badge" style="background:#f1f5f9;color:#94a3b8;border:1px solid #e2e8f0">Non sincronizzato</span>'
      : '<span class="badge badge-ok">‚úì OK</span>';
    const vatBadge = r.vat_registered
      ? '<span class="badge badge-ok">‚úì Registrata</span>'
      : `<button onclick="event.stopPropagation();markVATDone('${r.id}')" class="btn btn-sm" style="font-size:11px;padding:4px 10px;border:1.5px solid #d97706;color:#d97706;background:white;border-radius:6px;cursor:pointer">Registra</button>`;

    return `<tr style="border-bottom:1px solid var(--border);cursor:pointer" onclick="window.location='/client-detail?id=${r.id}'">
      <td style="padding:12px 16px;font-weight:600">${r.name}</td>
      <td style="padding:12px 16px;text-align:right;font-weight:700;color:${color};font-size:14px">AED ${fmt(r.rolling12)}</td>
      <td style="padding:12px 16px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="vat-bar-wrap"><div class="vat-bar" style="width:${pct}%;background:${color}"></div></div>
          <span style="font-size:11px;color:var(--text-muted);min-width:32px">${pct}%</span>
        </div>
      </td>
      <td style="padding:12px 16px;text-align:center">${badge}</td>
      <td style="padding:12px 16px;text-align:center">${vatBadge}</td>
      <td style="padding:12px 16px;text-align:center;font-size:11px;color:var(--text-muted)">${fmtDate(r.updated_at)}</td>
    </tr>`;
  }).join('');
}

async function markVATDone(clientId) {
  if (!confirm('Confermi che la VAT √® stata registrata?')) return;
  try {
    await sb.db.update('clients', `id=eq.${clientId}`, { vat_registered: true });
    const row = allRows.find(r => r.id === clientId);
    if (row) row.vat_registered = true;
    renderTable();
    updateCounts();
    ui.showToast('‚úÖ VAT segnata come registrata', 'success');
  } catch(e) {
    alert('Errore: ' + e.message);
  }
}

async function syncNow() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true; btn.textContent = '‚ü≥ Sincronizzazione...';
  document.getElementById('sync-status').textContent = 'Aggiornamento in corso, pu√≤ richiedere alcuni minuti...';
  try {
    const res = await fetch('https://gvdoqcgkzbziqufahhxh.supabase.co/functions/v1/bright-service', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2ZG9xY2dremJ6aXF1ZmFoaHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzIwNTEsImV4cCI6MjA4NzYwODA1MX0.I0hB8POnRunvGyr7XXItp8E5H70i0slG-pqxqzCOBOg',
      },
      body: JSON.stringify({ action: 'cron_sync' })
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    document.getElementById('sync-status').textContent = `‚úÖ Sincronizzati ${d.synced} clienti${d.errors ? ` (${d.errors} errori)` : ''}`;
    await load();
  } catch(e) {
    document.getElementById('sync-status').textContent = '‚ùå Errore: ' + e.message;
  }
  btn.disabled = false; btn.textContent = '‚ü≥ Aggiorna ora';
}

// app.js runs synchronously, data load after DOM ready
document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
