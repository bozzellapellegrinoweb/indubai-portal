<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estratti Conto â€” InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .month-header  { text-align:center; font-size:11px; padding:8px 4px !important; }
    .month-cell-td { text-align:center; padding:6px 4px !important; cursor:pointer; }
    .month-cell-td:hover { background:var(--surface2); }
    .client-col { min-width:200px; }
    .bank-col   { min-width:110px; font-size:11px; color:var(--text-muted); }

    /* Filter bar */
    .filter-bar {
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:12px 20px; background:white; border-bottom:1.5px solid var(--border);
    }
    .filter-bar select, .filter-bar input {
      padding:7px 12px; border:1.5px solid var(--border); border-radius:8px;
      font-size:13px; font-family:inherit; outline:none; background:white;
      transition:border-color .15s;
    }
    .filter-bar select:focus, .filter-bar input:focus { border-color:var(--primary); }
    .filter-chip {
      display:inline-flex; align-items:center; gap:5px;
      padding:5px 12px; border-radius:20px; font-size:12px; font-weight:600;
      cursor:pointer; border:1.5px solid var(--border); background:white;
      color:var(--text-muted); transition:all .12s;
    }
    .filter-chip:hover { border-color:var(--primary); color:var(--primary); }
    .filter-chip.on { background:var(--primary); border-color:var(--primary); color:white; }
    .filter-count { margin-left:auto; font-size:12px; color:var(--text-muted); white-space:nowrap; }

    /* Pagination */
    .pagination {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 20px; border-top:1.5px solid var(--border); background:white;
      flex-wrap:wrap; gap:10px;
    }
    .page-info { font-size:13px; color:var(--text-muted); }
    .page-btns { display:flex; gap:6px; }
    .page-btn {
      width:34px; height:34px; border-radius:8px; border:1.5px solid var(--border);
      background:white; cursor:pointer; font-size:13px; font-weight:600;
      display:flex; align-items:center; justify-content:center;
      transition:all .12s; color:var(--text);
    }
    .page-btn:hover { border-color:var(--primary); color:var(--primary); }
    .page-btn.on { background:var(--primary); border-color:var(--primary); color:white; }
    .page-btn:disabled { opacity:.35; cursor:not-allowed; }
  </style>
  <script src="/js/config.js"></script>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">Estratti Conto</div>
        <div class="topbar-subtitle">Griglia ricezione estratti mensili</div>
      </div>
    </div>

    <div class="page-content">
      <div class="card" style="padding:0;overflow:hidden">

        <!-- Filter bar -->
        <div class="filter-bar">
          <select id="filter-year">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
          <div style="position:relative">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:11px;pointer-events:none">ğŸ”</span>
            <input type="text" id="search" placeholder="Cerca cliente..." style="padding-left:30px;min-width:200px">
          </div>
          <!-- Status chips -->
          <div class="filter-chip on" data-status="all">Tutti</div>
          <div class="filter-chip" data-status="ok">âœ“ Completi</div>
          <div class="filter-chip" data-status="received">â—‹ Ricevuti</div>
          <div class="filter-chip" data-status="missing">âœ• Mancanti</div>
          <span class="filter-count" id="filter-count"></span>
          <button class="btn btn-ghost btn-sm" id="btn-reset" style="margin-left:auto">â†º Reset</button>
        </div>

        <!-- Table -->
        <div class="table-wrap" id="table-wrap" style="border-radius:0">
          <div style="padding:40px;text-align:center"><div class="spinner"></div></div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display:none">
          <div class="page-info" id="page-info"></div>
          <div class="page-btns" id="page-btns"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
const PAGE_SIZE = 50;
let allClients = [];
let statements  = {};
let currentYear = 2026;
let statusFilter = 'all';
let currentPage  = 1;

// â”€â”€ load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  document.getElementById('table-wrap').innerHTML = '<div style="padding:40px;text-align:center"><div class="spinner"></div></div>';
  try {
    allClients = await sb.db.select('clients', {
      filter: 'is_active=eq.true&in_bilancio=eq.true',
      order:  'company_name.asc',
      columns:'id,company_name,contact_name,bank_accounts'
    });
    const stmts = await sb.db.select('bank_statements', {
      filter: `year=eq.${currentYear}`,
      columns:'client_id,month,received,registered'
    });
    statements = {};
    (stmts||[]).forEach(s => { statements[`${s.client_id}_${s.month}`] = s; });
    currentPage = 1;
    renderGrid();
  } catch(e) {
    document.getElementById('table-wrap').innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;
  }
}

// â”€â”€ filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFiltered() {
  const q = document.getElementById('search').value.toLowerCase();
  const thisMonth = ui.currentYearMonth().month;

  return allClients.filter(c => {
    // Text search
    if (q && !(c.company_name||'').toLowerCase().includes(q)) return false;

    // Status filter â€” based on current month
    if (statusFilter !== 'all') {
      const key = `${c.id}_${thisMonth}`;
      const s = statements[key];
      if (statusFilter === 'ok'      && !(s?.received && s?.registered)) return false;
      if (statusFilter === 'received'&& !(s?.received && !s?.registered)) return false;
      if (statusFilter === 'missing' && s?.received) return false;
    }
    return true;
  });
}

// â”€â”€ render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid() {
  const filtered  = getFiltered();
  const thisMonth = ui.currentYearMonth().month;
  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = totalPages;

  const page = filtered.slice((currentPage-1)*PAGE_SIZE, currentPage*PAGE_SIZE);

  // Summary count
  document.getElementById('filter-count').textContent =
    `${filtered.length} / ${allClients.length} clienti`;

  // Month headers
  const monthHeaders = ui.MONTHS.map((m,i) => {
    const fut = (i+1) > thisMonth;
    return `<th class="month-header" style="${fut?'opacity:.35':''}">${m}</th>`;
  }).join('');

  // Rows
  const rows = page.map(c => {
    const cells = ui.MONTHS.map((_,i) => {
      const m = i+1;
      if (m > thisMonth) return `<td class="month-cell-td" style="opacity:.2">Â·</td>`;
      const s = statements[`${c.id}_${m}`];
      let cls='month-fail', sym='âœ•';
      if (s?.received && s?.registered) { cls='month-ok';   sym='âœ“'; }
      else if (s?.received)             { cls='month-warn'; sym='â—‹'; }
      const title = s?.received ? (s?.registered?'Ricevuto e registrato':'Ricevuto, non registrato') : 'Non ricevuto';
      return `<td class="month-cell-td" onclick="toggleStatement('${c.id}',${m},this)" title="${title}">
        <span class="month-cell ${cls}">${sym}</span></td>`;
    }).join('');

    return `<tr>
      <td class="client-col">
        <div class="td-company">${ui.escapeHtml(c.company_name)}</div>
        <div class="td-contact">${ui.escapeHtml(c.contact_name)||''}</div>
      </td>
      <td class="bank-col">${(c.bank_accounts||[]).join(', ')||'â€”'}</td>
      ${cells}
    </tr>`;
  }).join('');

  document.getElementById('table-wrap').innerHTML = rows.length ? `
    <table class="month-grid-table">
      <thead>
        <tr>
          <th class="client-col">Cliente</th>
          <th class="bank-col">Conti</th>
          ${monthHeaders}
        </tr>
        <tr>
          <td colspan="2" style="padding:6px 14px;font-size:11px;color:var(--text-muted)">
            Legenda: <span class="month-cell month-ok">âœ“</span> Ric.+Reg.
            <span class="month-cell month-warn">â—‹</span> Ricevuto
            <span class="month-cell month-fail">âœ•</span> Mancante
          </td>
          ${ui.MONTHS.map(()=>'<td></td>').join('')}
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>` :
    `<div class="empty-state" style="padding:40px"><div class="empty-icon">ğŸ”</div><h3>Nessun risultato</h3><p>Prova a cambiare i filtri</p></div>`;

  renderPagination(filtered.length, totalPages);
}

// â”€â”€ pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPagination(total, totalPages) {
  const pg = document.getElementById('pagination');
  if (totalPages <= 1) { pg.style.display='none'; return; }
  pg.style.display = 'flex';
  document.getElementById('page-info').textContent =
    `Pagina ${currentPage} di ${totalPages} Â· ${total} clienti`;

  let btns = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>â€¹</button>`;
  const range = getPageRange(currentPage, totalPages);
  range.forEach(p => {
    if (p === 'â€¦') btns += `<span style="padding:0 4px;line-height:34px;color:var(--text-muted)">â€¦</span>`;
    else btns += `<button class="page-btn${p===currentPage?' on':''}" onclick="goPage(${p})">${p}</button>`;
  });
  btns += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>â€º</button>`;
  document.getElementById('page-btns').innerHTML = btns;
}

function getPageRange(cur, tot) {
  if (tot <= 7) return Array.from({length:tot},(_,i)=>i+1);
  if (cur <= 4) return [1,2,3,4,5,'â€¦',tot];
  if (cur >= tot-3) return [1,'â€¦',tot-4,tot-3,tot-2,tot-1,tot];
  return [1,'â€¦',cur-1,cur,cur+1,'â€¦',tot];
}

function goPage(p) {
  const tot = Math.ceil(getFiltered().length/PAGE_SIZE);
  if (p<1||p>tot) return;
  currentPage = p;
  renderGrid();
  document.querySelector('.card').scrollIntoView({behavior:'smooth',block:'start'});
}

// â”€â”€ toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleStatement(clientId, month, tdEl) {
  const key = `${clientId}_${month}`;
  const cur = statements[key];
  let newState;
  if (!cur?.received)       newState = {received:true,  registered:false};
  else if (!cur?.registered) newState = {received:true,  registered:true};
  else                       newState = {received:false, registered:false};

  try {
    await sb.db.upsertBankStatement(clientId, currentYear, month, newState);
    statements[key] = {...cur, ...newState, client_id:clientId, month};
    let cls='month-fail',sym='âœ•';
    if (newState.received && newState.registered) {cls='month-ok';  sym='âœ“';}
    else if (newState.received)                   {cls='month-warn';sym='â—‹';}
    tdEl.innerHTML = `<span class="month-cell ${cls}">${sym}</span>`;
    await sb.db.log('bank_statement_updated', clientId, {month,year:currentYear,...newState});
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

// â”€â”€ events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('search').addEventListener('input', () => { currentPage=1; renderGrid(); });
document.getElementById('filter-year').addEventListener('change', e => { currentYear=parseInt(e.target.value); loadData(); });

document.querySelectorAll('.filter-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('on'));
    chip.classList.add('on');
    statusFilter = chip.dataset.status;
    currentPage = 1;
    renderGrid();
  });
});

document.getElementById('btn-reset').addEventListener('click', () => {
  document.getElementById('search').value = '';
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('on'));
  document.querySelector('.filter-chip[data-status="all"]').classList.add('on');
  statusFilter = 'all';
  currentPage = 1;
  renderGrid();
});

loadData();
</script>
</body>
</html>
