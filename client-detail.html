<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .client-header { background: var(--primary); color: white; padding: 24px 32px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
    .client-avatar { width: 56px; height: 56px; border-radius: 14px; background: rgba(255,255,255,.2); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 900; flex-shrink: 0; }
    .client-name { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
    .client-meta { font-size: 13px; opacity: .8; display: flex; gap: 16px; flex-wrap: wrap; }
    .tab-bar { display: flex; gap: 4px; margin-bottom: 20px; background: var(--surface2); padding: 4px; border-radius: 10px; }
    .tab { padding: 8px 16px; border-radius: 8px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-muted); transition: all .15s; }
    .tab.active { background: white; color: var(--primary); box-shadow: 0 1px 4px rgba(0,0,0,.1); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .info-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .info-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-muted); margin-bottom: 6px; }
    .info-value { font-size: 14px; font-weight: 700; color: var(--text-primary); }
    .info-value.muted { font-weight: 400; color: var(--text-secondary); }
    .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .check-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: white; }
    .check-item.done { background: #f0fdf4; border-color: #86efac; }
    .check-toggle { width: 20px; height: 20px; border-radius: 6px; border: 2px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; transition: all .15s; }
    .check-toggle.done { background: #16a34a; border-color: #16a34a; color: white; }
    .task-mini { padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .pri-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* Scrollable tabs fix */
    .tab-bar { 
      display: flex; 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 4px;
      padding-bottom: 2px;
      padding: 12px 16px;
      background: white;
      border-bottom: 1.5px solid var(--border);
    }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab { white-space: nowrap; flex-shrink: 0; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <a href="/clients.html" class="btn btn-ghost btn-sm">‚Üê Clienti</a>
        <div class="topbar-title" id="page-title">Cliente</div>
      </div>
    </div>
    <div class="page-content">
      <div id="loading" class="loading-overlay"><div class="spinner"></div></div>
      <div id="content" style="display:none">

        <!-- Header -->
        <div class="client-header">
          <div class="client-avatar" id="avatar">?</div>
          <div style="flex:1">
            <div class="client-name" id="h-name">‚Äî</div>
            <div class="client-meta" id="h-meta"></div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-sm" style="background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.3)" onclick="openEdit()">‚úé Modifica</button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tab-bar">
          <button class="tab active" onclick="switchTab('info',this)">üìã Info</button>
          <button class="tab" onclick="switchTab('onboarding',this)">‚ú¶ Onboarding</button>
          <button class="tab" onclick="switchTab('payments',this)">‚óÜ Pagamenti</button>
          <button class="tab" onclick="switchTab('statements',this)">‚óé Estratti</button>
          <button class="tab" onclick="switchTab('tasks',this)">‚úì Task</button>
          <button class="tab" onclick="switchTab('documents',this)">üìÅ Documenti</button>
          <button class="tab" onclick="switchTab('zoho',this)">üìä Zoho Books</button>
          <button class="tab" onclick="switchTab('accesso',this)">üîë Accesso Cliente</button>
          <button class="tab" onclick="switchTab('visti',this)">‚úàÔ∏è Visti</button>
          <button class="tab" onclick="switchTab('pratiche',this)">üìã Pratiche</button>
        </div>

        <!-- Tab: Info -->
        <div class="tab-panel active" id="tab-info">
          <div class="info-grid" id="info-grid"></div>
        </div>

        <!-- Tab: Onboarding -->
        <div class="tab-panel" id="tab-onboarding">
          <div class="card">
            <div class="card-header"><div class="card-title">‚ú¶ Checklist Onboarding</div></div>
            <div id="onboarding-grid" style="padding:16px 20px"></div>
          </div>
        </div>

        <!-- Tab: Pagamenti -->
        <div class="tab-panel" id="tab-payments">
          <div class="card">
            <div class="card-header">
              <div class="card-title">‚óÜ Pagamenti Abbonamento 2026</div>
            </div>
            <div class="table-wrap">
              <table id="payments-table">
                <thead><tr><th>Mese</th><th>Status</th><th>Importo</th><th>Note</th></tr></thead>
                <tbody id="payments-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab: Estratti -->
        <div class="tab-panel" id="tab-statements">
          <div class="card">
            <div class="card-header">
              <div class="card-title">‚óé Estratti Conto 2026</div>
            </div>
            <div class="table-wrap">
              <table id="statements-table">
                <thead><tr><th>Mese</th><th>Ricevuto</th><th>Registrato</th><th>Note</th></tr></thead>
                <tbody id="statements-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab: Task -->
        <div class="tab-panel" id="tab-tasks">
          <div class="card">
            <div class="card-header">
              <div class="card-title">‚úì Task cliente</div>
              <button class="btn btn-accent btn-sm" onclick="newTaskForClient()">+ Task</button>
            </div>
            <div id="client-tasks" style="padding:4px 0"></div>
          </div>
        </div>

        <!-- Tab: Documenti -->
        <div class="tab-panel" id="tab-documents">
          <div id="doc-panel-content" style="min-height:300px;padding:20px">
            <div style="text-align:center;padding:40px"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Zoho Books Tab -->
        <div class="tab-panel" id="tab-zoho">
          <div id="zoho-panel" style="padding:20px">
            <div style="padding:40px;text-align:center;color:var(--text-muted)">
              <div class="spinner"></div>
              <div style="margin-top:12px;font-size:13px">Caricamento dati Zoho Books...</div>
            </div>
          </div>
        </div>

        <!-- Accesso Cliente Tab -->
        <div class="tab-panel" id="tab-accesso" style="padding:20px">
          <div id="accesso-content"><div class="spinner"></div></div>
        </div>

        <!-- Visti Tab -->
        <div class="tab-panel" id="tab-visti" style="padding:20px">
          <div id="visti-content"><div class="spinner"></div></div>
        </div>

        <!-- Pratiche Tab -->
        <div class="tab-panel" id="tab-pratiche" style="padding:20px">
          <div id="pratiche-content"><div class="spinner"></div></div>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let clientId = null;
let clientData = null;

async function init() {
  await sb.requireAuth();
  const params = new URLSearchParams(window.location.search);
  clientId = params.get('id');
  if (!clientId) { window.location.href = '/clients.html'; return; }
  await loadClient();
}

async function loadClient() {
  try {
    const rows = await sb.db.select('clients', {
      columns: '*,vat_register(*),onboarding_checklist(*)',
      filter: `id=eq.${clientId}`
    });
    if (!rows?.length) { window.location.href = '/clients.html'; return; }
    clientData = rows[0];
    renderClient();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';
  } catch(e) {
    document.getElementById('loading').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function renderClient() {
  const c = clientData;
  const initials = (c.company_name||'?').split(/[\s-]/)[0].substring(0,2).toUpperCase();
  document.getElementById('avatar').textContent = initials;
  document.getElementById('h-name').textContent = c.company_name;
  document.getElementById('page-title').textContent = c.company_name;
  document.title = c.company_name + ' ‚Äî InDubai Portal';

  const meta = [];
  if (c.contact_name) meta.push('üë§ '+c.contact_name);
  if (c.email) meta.push('‚úâ '+c.email);
  if (c.phone_uae) meta.push('üì± '+c.phone_uae);
  if (!c.is_active) meta.push('‚ö† INATTIVO');
  document.getElementById('h-meta').innerHTML = meta.join(' &nbsp;¬∑&nbsp; ');

  // Info grid
  const fields = [
    ['Ragione Sociale', c.company_name],
    ['Referente', c.contact_name||'‚Äî'],
    ['Email', c.email||'‚Äî'],
    ['Telefono UAE', c.phone_uae||'‚Äî'],
    ['Partner Contabilit√†', ui.partnerLabel(c.accounting_partner)],
    ['Partner VAT', ui.partnerLabel(c.vat_partner)],
    ['Costo Abbonamento', c.service_cost ? 'AED '+c.service_cost : '‚Äî'],
    ['Giorno Addebito', c.subscription_day ? c.subscription_day+'¬∞ del mese' : '‚Äî'],
    ['Data Avvio', ui.formatDate(c.start_date)],
    ['General Manager', c.general_manager||'‚Äî'],
    ['Lic. Emissione', ui.formatDate(c.license_issue_date)],
    ['Lic. Scadenza', ui.formatDate(c.trade_license_date)],
    ['Scad. Corporate Tax', ui.formatDate(c.corporate_tax_expiry)],
    ['Conti Bancari', c.bank_accounts?.join(', ')||'‚Äî'],
  ];
  document.getElementById('info-grid').innerHTML = fields.map(([l,v]) =>
    `<div class="info-card"><div class="info-label">${l}</div><div class="info-value ${v==='‚Äî'?'muted':''}">${ui.escapeHtml(String(v))}</div></div>`
  ).join('');
  // FTA credentials (visible only to admin/senior)
  const role = sb.getCurrentProfile()?.role;
  if ((c.fta_username || c.fta_password) && ['admin','senior'].includes(role)) {
    document.getElementById('info-grid').insertAdjacentHTML('beforeend', `
      <div class="info-card" style="grid-column:1/-1;background:#f0f9ff;border-color:#bae6fd">
        <div class="info-label" style="color:#0369a1">üîê Credenziali FTA</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
          <div>
            <div style="font-size:11px;color:#0369a1;font-weight:600;margin-bottom:3px">Username</div>
            <div style="font-size:14px;font-weight:700;font-family:monospace">${ui.escapeHtml(c.fta_username||'‚Äî')}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#0369a1;font-weight:600;margin-bottom:3px">Password</div>
            <div style="display:flex;align-items:center;gap:8px">
              <div id="fta-pwd-display" style="font-size:14px;font-weight:700;font-family:monospace;letter-spacing:2px">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
              <button onclick="toggleFtaPwd('${ui.escapeHtml(c.fta_password||'')}','${ui.escapeHtml(c.fta_username||'')}')" style="font-size:11px;padding:2px 8px;border:1px solid #bae6fd;border-radius:5px;background:white;cursor:pointer;color:#0369a1">Mostra</button>
            </div>
          </div>
        </div>
      </div>`);
  }
  if (c.notes) {
    document.getElementById('info-grid').insertAdjacentHTML('beforeend',
      `<div class="info-card" style="grid-column:1/-1"><div class="info-label">Note</div><div class="info-value muted">${ui.escapeHtml(c.notes)}</div></div>`);
  }
}

function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
  if (name === 'onboarding') loadOnboarding();
  if (name === 'payments') loadPayments();
  if (name === 'statements') loadStatements();
  if (name === 'tasks') loadClientTasks();
  if (name === 'documents') loadDocumentsPanel();
  if (name === 'zoho') loadZohoTab();
  if (name === 'accesso') loadAccessTab();
  if (name === 'visti') loadVistiTab();
  if (name === 'pratiche') loadPraticheTab();
}

async function loadOnboarding() {
  const ob = clientData.onboarding_checklist?.[0];
  const el = document.getElementById('onboarding-grid');
  if (!ob) { el.innerHTML = '<p style="color:var(--text-muted);font-size:13px">Nessun dato onboarding.</p>'; return; }
  const checks = [
    ['whatsapp_group','Gruppo WhatsApp creato'],
    ['call_scheduled','Call schedulata'],
    ['docs_in_drive','Documenti in Drive'],
    ['eid_verified','EID verificato'],
    ['uae_phone_verified','Telefono UAE verificato'],
    ['corporate_tax_check','Corporate Tax verificato'],
    ['fta_profile_created','Profilo FTA creato'],
    ['ct_registration_done','CT registrazione completata'],
    ['payment_link_sent','Link pagamento inviato'],
    ['bank_accounts_noted','Conti bancari registrati'],
  ];
  el.innerHTML = `<div class="check-grid">` + checks.map(([key, label]) =>
    `<div class="check-item ${ob[key]?'done':''}">
      <div class="check-toggle ${ob[key]?'done':''}" onclick="toggleCheck('${key}',${!ob[key]})">${ob[key]?'‚úì':''}</div>
      <span style="font-size:13px;font-weight:${ob[key]?'700':'400'}">${label}</span>
    </div>`).join('') + '</div>';
  if (ob.notes) el.insertAdjacentHTML('beforeend',
    `<div style="margin-top:16px;padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:13px">${ui.escapeHtml(ob.notes)}</div>`);
}

async function toggleCheck(key, value) {
  try {
    await sb.db.update('onboarding_checklist', `client_id=eq.${clientId}`, {[key]: value});
    if (clientData.onboarding_checklist?.[0]) clientData.onboarding_checklist[0][key] = value;
    loadOnboarding();
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

async function loadPayments() {
  try {
    const data = await sb.db.select('subscription_payments', {
      filter: `client_id=eq.${clientId}&year=eq.2026`,
      order: 'month.asc'
    });
    const tbody = document.getElementById('payments-tbody');
    if (!data?.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">Nessun dato</td></tr>'; return; }
    tbody.innerHTML = data.map(p => `<tr>
      <td>${ui.MONTHS_FULL[p.month-1]} ${p.year}</td>
      <td>${ui.statusBadge(p.status)}</td>
      <td>${p.amount ? 'AED '+p.amount : '‚Äî'}</td>
      <td style="color:var(--text-muted)">${p.notes||'‚Äî'}</td>
    </tr>`).join('');
  } catch(e) { document.getElementById('payments-tbody').innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`; }
}

async function loadStatements() {
  try {
    const data = await sb.db.select('bank_statements', {
      filter: `client_id=eq.${clientId}&year=eq.2026`,
      order: 'month.asc'
    });
    const tbody = document.getElementById('statements-tbody');
    if (!data?.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">Nessun dato</td></tr>'; return; }
    tbody.innerHTML = data.map(s => `<tr>
      <td>${ui.MONTHS_FULL[s.month-1]} ${s.year}</td>
      <td>${s.received ? '<span class="badge badge-ok">‚úì S√¨</span>' : '<span class="badge badge-warn">‚úï No</span>'}</td>
      <td>${s.registered ? '<span class="badge badge-ok">‚úì S√¨</span>' : '<span class="badge badge-warn">‚úï No</span>'}</td>
      <td style="color:var(--text-muted)">${s.notes||'‚Äî'}</td>
    </tr>`).join('');
  } catch(e) { document.getElementById('statements-tbody').innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`; }
}

async function loadClientTasks() {
  const el = document.getElementById('client-tasks');
  try {
    const tasks = await sb.db.select('tasks', {
      columns: 'id,title,status,priority,due_date,assigned_to,assigned_profile:profiles!tasks_assigned_to_fkey(full_name)',
      filter: `client_id=eq.${clientId}`,
      order: 'created_at.desc'
    });
    if (!tasks?.length) {
      el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px">Nessuna task per questo cliente.</div>';
      return;
    }
    const priColor = {urgent:'#dc2626',high:'#d97706',normal:'#0369a1',low:'#9ca3af'};
    el.innerHTML = tasks.map(t => `
      <div class="task-mini" style="padding:12px 20px">
        <span class="pri-dot" style="background:${priColor[t.priority]||'#6b7a95'}"></span>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600">${ui.escapeHtml(t.title)}</div>
          ${t.assigned_profile ? `<div style="font-size:11px;color:var(--text-muted)">üë§ ${ui.escapeHtml(t.assigned_profile.full_name)}</div>` : ''}
        </div>
        ${t.due_date ? `<span style="font-size:12px;font-weight:600" class="${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>` : ''}
        <a href="/tasks.html" class="btn btn-ghost btn-sm">Apri</a>
      </div>`).join('');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`; }
}

function newTaskForClient() {
  window.location.href = `/tasks.html?client=${clientId}`;
}

function openEdit() {
  // Populate edit modal with current data
  const c = clientData;
  document.getElementById('e-company').value = c.company_name||'';
  document.getElementById('e-contact').value = c.contact_name||'';
  document.getElementById('e-email').value = c.email||'';
  document.getElementById('e-phone').value = c.phone_uae||'';
  document.getElementById('e-partner').value = c.accounting_partner||'';
  document.getElementById('e-vat-partner').value = c.vat_partner||'';
  document.getElementById('e-cost').value = c.service_cost||'';
  document.getElementById('e-sub-day').value = c.subscription_day||'';
  document.getElementById('e-start').value = c.start_date||'';
  document.getElementById('e-tl-issue').value = c.license_issue_date||'';
  document.getElementById('e-tl-date').value = c.trade_license_date||'';
  document.getElementById('e-ct-expiry').value = c.corporate_tax_expiry||'';
  document.getElementById('e-free-zone').value = c.free_zone||'';
  document.getElementById('e-company-type').value = c.company_type||'';
  document.getElementById('e-license-number').value = c.license_number||'';
  document.getElementById('e-nationality').value = c.nationality||'';
  document.getElementById('e-eid-expiry').value = c.eid_expiry||'';
  document.getElementById('e-bank-notes').value = c.bank_notes||'';
  document.getElementById('e-notes').value = c.notes||'';
  document.getElementById('e-gm').value = c.general_manager||'';
  document.getElementById('e-zoho-org').value = c.zoho_org_id||'';
  document.getElementById('e-fta-user').value = c.fta_username||'';
  document.getElementById('e-fta-pass').value = c.fta_password||'';
  document.getElementById('e-active').checked = c.is_active!==false;
  document.getElementById('e-bilancio').checked = c.in_bilancio!==false;
  document.getElementById('e-vat-reg').checked = c.vat_registered||false;
  document.getElementById('e-ct-reg').checked = c.corporate_tax_registered||false;
  // Banks
  document.querySelectorAll('#e-banks input[type=checkbox]').forEach(cb => {
    cb.checked = (c.bank_accounts||[]).includes(cb.value);
  });
  document.getElementById('modal-edit').style.display = 'flex';
}

async function markVATDone(clientId) {
  if (!confirm('Confermi che la VAT √® stata registrata?')) return;
  try {
    const result = await sb.db.update('clients', `id=eq.${clientId}`, { vat_registered: true });
    clientData.vat_registered = true;
    // Reload zoho tab
    switchTab('zoho', document.querySelector('.tab[onclick*="zoho"]'));
    ui.showToast('‚úÖ VAT segnata come registrata', 'success');
  } catch(e) {
    alert('Errore: ' + e.message);
  }
}

async function markCTDone(clientId) {
  if (!confirm('Segnare la Corporate Tax come completata? Verr√† rimossa la data di emissione licenza dal tracker.')) return;
  try {
    await sb.db.update('clients', `id=eq.${clientId}`, { 
      license_issue_date: null,
      ct_tracker_done: true
    });
    clientData.license_issue_date = null;
    clientData.ct_tracker_done = true;
    ui.showToast('‚úÖ Corporate Tax segnata come completata', 'success');
    loadZohoTab();
  } catch(e) {
    ui.showToast('Errore: ' + e.message, 'error');
  }
}

async function loadZohoTab() {
  const el = document.getElementById('zoho-panel');
  const orgId = clientData?.zoho_org_id;

  if (!orgId) {
    el.innerHTML = `
      <div style="padding:32px;text-align:center">
        <div style="font-size:32px;margin-bottom:12px">üìä</div>
        <h3 style="margin:0 0 8px">Zoho Books non collegato</h3>
        <p style="color:var(--text-muted);font-size:13px;margin:0 0 20px">Aggiungi il Zoho Org ID nel profilo cliente per vedere i dati contabili.</p>
        <button class="btn btn-accent" onclick="document.getElementById('modal-edit').style.display='flex'; document.getElementById('e-zoho-org').focus()">
          ‚úé Aggiungi Org ID
        </button>
      </div>`;
    return;
  }

  el.innerHTML = '<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;font-size:13px;color:var(--text-muted)">Connessione a Zoho Books...</div></div>';

  try {
    const SUPABASE_URL = window.SUPABASE_URL || document.querySelector('script[src*="supabase"]')?.src?.match(/https:\/\/[^/]+/)?.[0] || '';
    const fnUrl = 'https://gvdoqcgkzbziqufahhxh.supabase.co/functions/v1/bright-service';
    const res = await fetch(fnUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2ZG9xY2dremJ6aXF1ZmFoaHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzIwNTEsImV4cCI6MjA4NzYwODA1MX0.I0hB8POnRunvGyr7XXItp8E5H70i0slG-pqxqzCOBOg',
      },
      body: JSON.stringify({ action: 'client_summary', org_id: orgId })
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);

    const fmt    = (n) => {
      if (n === undefined || n === null || isNaN(n)) return '‚Äî';
      return new Intl.NumberFormat('it-IT', {minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
    };
    const cur    = d.orgCurrency || d.currency || 'AED';
    const isMulti = cur !== 'AED';
    // Fallback for old function version
    if (d.rolling12AED === undefined) d.rolling12AED = 0;
    if (d.prevYearAED === undefined) d.prevYearAED = d.prevYearTotal || 0;
    if (d.totalBilledAED === undefined) d.totalBilledAED = d.totalBilled || 0;
    if (d.totalPaidAED === undefined) d.totalPaidAED = d.totalPaid || 0;
    if (d.totalUnpaidAED === undefined) d.totalUnpaidAED = d.totalUnpaid || 0;
    if (d.vatStatus === undefined) d.vatStatus = 'ok';
    if (d.vatThreshold === undefined) d.vatThreshold = 375000;
    if (!d.rolling12Start) d.rolling12Start = new Date(Date.now() - 365*86400000).toISOString().split('T')[0];

    // VAT alert bar config
    const vatPct  = Math.min(100, Math.round(d.rolling12AED / d.vatThreshold * 100));
    const vatRegistered = clientData?.vat_registered;
    const vatColor = vatRegistered ? '#059669' : d.vatStatus === 'exceeded' ? '#dc2626' : d.vatStatus === 'warning' ? '#d97706' : '#059669';
    const vatBg    = vatRegistered ? '#f0fdf4' : d.vatStatus === 'exceeded' ? '#fef2f2' : d.vatStatus === 'warning' ? '#fffbeb' : '#f0fdf4';
    const vatBorder= vatRegistered ? '#86efac' : d.vatStatus === 'exceeded' ? '#fca5a5' : d.vatStatus === 'warning' ? '#fde68a' : '#86efac';
    const vatLabel = vatRegistered ? '‚úì VAT Registrata'
                   : d.vatStatus === 'exceeded' ? 'üö® Soglia VAT SUPERATA ‚Äî registrazione obbligatoria' 
                   : d.vatStatus === 'warning'  ? '‚ö†Ô∏è Attenzione: vicino alla soglia VAT (AED 375.000)' 
                   : '‚úì Sotto soglia VAT';

    // CT tracker (from clientData)
    const licIssue = clientData?.license_issue_date;
    let ctTrackerHtml = '';
    if (licIssue) {
      const issueDate = new Date(licIssue);
      const deadline  = new Date(issueDate);
      deadline.setDate(deadline.getDate() + 80);
      const today2    = new Date();
      const daysLeft  = Math.ceil((deadline - today2) / 86400000);
      const ctPct     = Math.max(0, Math.min(100, Math.round((80 - daysLeft) / 80 * 100)));
      const ctColor   = daysLeft <= 0 ? '#dc2626' : daysLeft <= 15 ? '#d97706' : daysLeft <= 30 ? '#ca8a04' : '#059669';
      const ctBg      = daysLeft <= 0 ? '#fef2f2' : daysLeft <= 15 ? '#fffbeb' : '#f0fdf4';
      const ctLabel   = daysLeft <= 0 ? 'üö® SCADUTO ‚Äî Corporate Tax non registrata!' 
                      : daysLeft <= 15 ? `üî¥ Urgente: ${daysLeft} giorni alla scadenza CT`
                      : daysLeft <= 30 ? `üü° ${daysLeft} giorni alla scadenza CT`
                      : `‚úì ${daysLeft} giorni alla scadenza CT`;
      ctTrackerHtml = `
        <div style="background:${ctBg};border:1.5px solid ${ctColor}40;border-radius:14px;padding:20px 24px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div>
              <div style="font-size:13px;font-weight:700;color:${ctColor}">‚è± Corporate Tax Tracker</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:2px">Emissione licenza: ${ui.formatDate(licIssue)} ‚Üí Scadenza CT: ${ui.formatDate(deadline.toISOString().split('T')[0])}</div>
            </div>
            <div style="font-size:20px;font-weight:800;color:${ctColor}">${daysLeft <= 0 ? 'SCADUTO' : daysLeft + 'gg'}</div>
          </div>
          <div style="background:white;border-radius:100px;height:10px;overflow:hidden;margin-bottom:8px">
            <div style="height:100%;border-radius:100px;background:${ctColor};width:${ctPct}%;transition:width .6s ease"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
            <div style="font-size:12px;font-weight:600;color:${ctColor}">${ctLabel}</div>
            <button onclick="markCTDone('${clientData.id}')" 
              style="font-size:12px;padding:6px 14px;border-radius:8px;border:1.5px solid ${ctColor};background:white;color:${ctColor};font-weight:600;cursor:pointer">
              ‚úì Segna Completata
            </button>
          </div>
        </div>`;
    }

    el.innerHTML = `
      <div style="padding:20px 0">

        <!-- Corporate Tax Tracker -->
        ${ctTrackerHtml}

        <!-- VAT Threshold bar -->
        <div style="background:${vatBg};border:1.5px solid ${vatBorder};border-radius:14px;padding:20px 24px;margin-bottom:24px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div>
              <div style="font-size:13px;font-weight:700;color:${vatColor}">üìä Soglia VAT ‚Äî Ultimi 12 mesi</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:2px">Da ${ui.formatDate(d.rolling12Start)} a oggi ¬∑ sempre in AED</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:20px;font-weight:800;color:${vatColor}">AED ${fmt(d.rolling12AED)}</div>
              <div style="font-size:11px;color:var(--text-muted)">${vatPct}% di AED ${fmt(d.vatThreshold)}</div>
            </div>
          </div>
          <div style="background:white;border-radius:100px;height:12px;overflow:hidden;margin-bottom:8px">
            <div style="height:100%;border-radius:100px;background:${vatColor};width:${vatPct}%;transition:width .6s ease"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
            <div style="font-size:12px;font-weight:600;color:${vatColor}">${vatLabel}</div>
            ${clientData?.vat_registered 
              ? '<span style="font-size:12px;padding:6px 14px;border-radius:8px;background:#f0fdf4;color:#059669;font-weight:700;border:1.5px solid #86efac">‚úì VAT Registrata</span>'
              : d.vatStatus !== 'ok' 
              ? `<button onclick="markVATDone('${clientData?.id}')"
                  style="font-size:12px;padding:6px 14px;border-radius:8px;border:1.5px solid ${vatColor};background:white;color:${vatColor};font-weight:600;cursor:pointer">
                  ‚úì Segna come Registrata
                </button>` 
              : ''}
          </div>
        </div>

        <!-- KPI row -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
          <div style="background:linear-gradient(135deg,#1a3a5c,#2563a8);border-radius:14px;padding:20px 24px;color:white">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.65);margin-bottom:8px">Fatturato Totale ${d.year}</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.5px">${cur} ${fmt(d.totalBilled)}</div>
            ${isMulti ? `<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:2px">‚âà AED ${fmt(d.totalBilledAED)}</div>` : ''}
            <div style="font-size:12px;color:rgba(255,255,255,.55);margin-top:4px">${d.countInvoices} fatture emesse</div>
          </div>
          <div style="background:linear-gradient(135deg,#065f46,#059669);border-radius:14px;padding:20px 24px;color:white">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.65);margin-bottom:8px">Incassato</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.5px">${cur} ${fmt(d.totalPaid)}</div>
            ${isMulti ? `<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:2px">‚âà AED ${fmt(d.totalPaidAED)}</div>` : ''}
            <div style="font-size:12px;color:rgba(255,255,255,.55);margin-top:4px">${Math.round(d.totalBilled ? d.totalPaid/d.totalBilled*100 : 0)}% del fatturato</div>
          </div>
          <div style="background:${d.totalUnpaid>0?'linear-gradient(135deg,#7f1d1d,#dc2626)':'linear-gradient(135deg,#374151,#6b7280)'};border-radius:14px;padding:20px 24px;color:white">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.65);margin-bottom:8px">Da Incassare</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.5px">${cur} ${fmt(d.totalUnpaid)}</div>
            ${isMulti ? `<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:2px">‚âà AED ${fmt(d.totalUnpaidAED)}</div>` : ''}
            <div style="font-size:12px;color:rgba(255,255,255,.55);margin-top:4px">${d.countOverdue} scadute</div>
          </div>
          <div style="background:white;border:1.5px solid var(--border);border-radius:14px;padding:20px 24px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-bottom:8px">Anno prec. (${d.year-1})</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.5px;color:var(--text)">AED ${fmt(d.prevYearAED)}</div>
            <div style="font-size:12px;margin-top:4px;color:${d.totalBilledAED>=d.prevYearAED?'#059669':'#dc2626'}">
              ${d.prevYearAED ? (d.totalBilledAED >= d.prevYearAED ? '‚ñ≤' : '‚ñº') + ' ' + Math.abs(Math.round((d.totalBilledAED-d.prevYearAED)/d.prevYearAED*100)) + '% vs anno prec.' : '‚Äî'}
            </div>
          </div>
        </div>

        <!-- Barra progresso incasso -->
        <div style="background:white;border:1.5px solid var(--border);border-radius:14px;padding:20px 24px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-size:13px;font-weight:700">Stato Incassi ${d.year}</div>
            <div style="font-size:13px;color:var(--text-muted)">${cur} ${fmt(d.totalPaid)} / ${cur} ${fmt(d.totalBilled)}</div>
          </div>
          <div style="background:#f1f5f9;border-radius:100px;height:10px;overflow:hidden">
            <div style="height:100%;border-radius:100px;background:linear-gradient(90deg,#059669,#34d399);width:${Math.round(d.totalBilled ? d.totalPaid/d.totalBilled*100 : 0)}%;transition:width .6s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px">
            <span style="color:#059669;font-weight:600">‚úì Incassato ${Math.round(d.totalBilled ? d.totalPaid/d.totalBilled*100 : 0)}%</span>
            <span style="color:${d.totalUnpaid>0?'#dc2626':'var(--text-muted)'};font-weight:600">‚è≥ Da incassare ${Math.round(d.totalBilled ? d.totalUnpaid/d.totalBilled*100 : 0)}%</span>
          </div>
        </div>

        <!-- Ultima fattura -->
        ${d.lastInvoice ? `
        <div style="background:white;border:1.5px solid var(--border);border-radius:14px;padding:20px 24px;margin-bottom:20px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-bottom:12px">Ultima Fattura</div>
          <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
            <div style="font-size:16px;font-weight:800;color:var(--text)">${d.lastInvoice.number}</div>
            <div style="font-size:13px;color:var(--text-muted)">${ui.formatDate(d.lastInvoice.date)}</div>
            <div style="font-size:15px;font-weight:700;color:var(--text)">${d.lastInvoice.currency||cur} ${fmt(d.lastInvoice.total)}</div>
            <div>${ui.monthBadge(d.lastInvoice.status === 'paid' ? 'ok' : d.lastInvoice.status === 'overdue' ? 'failed' : 'pending')}</div>
          </div>
        </div>` : ''}

        <!-- Azioni -->
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn btn-ghost btn-sm" onclick="loadZohoTab()">‚Ü∫ Aggiorna</button>
          <a href="https://books.zoho.com/app#/invoices" target="_blank" class="btn btn-accent btn-sm">Apri Zoho Books ‚Üó</a>
        </div>
      </div>`;
  } catch(e) {
    el.innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;
  }
}

async function loadAccessTab() {
  const el = document.getElementById('accesso-content');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    // Check if client already has an account
    const links = await sb.db.select('client_users', { filter: 'client_id=eq.' + clientId, columns: 'id,user_id,created_at' });
    const existing = links?.[0];

    if (existing) {
      el.innerHTML = `
        <div style="max-width:520px">
          <div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:12px;padding:20px;margin-bottom:16px">
            <div style="font-weight:700;color:#059669;font-size:15px;margin-bottom:10px">‚úì Accesso attivo</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 16px;font-size:13px;color:#374151">
              <span style="color:#6b7280;font-weight:600">Email:</span>
              <span style="font-weight:700">${clientData?.email || '‚Äî'}</span>
              <span style="color:#6b7280;font-weight:600">Attivo dal:</span>
              <span>${ui.formatDate(existing.created_at)}</span>
            </div>
          </div>

          <div style="background:#f8fafc;border:1.5px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
            <div style="font-size:12px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Reset Password</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="new-pwd-display" class="form-control" value="${generatePassword()}" style="font-family:monospace;font-size:14px;font-weight:700;letter-spacing:1px;flex:1">
              <button class="btn btn-ghost btn-sm" onclick="document.getElementById('new-pwd-display').value=generatePassword()" title="Genera nuova">‚Ü∫</button>
            </div>
            <button class="btn btn-accent" style="margin-top:10px;width:100%" onclick="resetClientPasswordWithValue()">üîë Applica nuova password</button>
          </div>

          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" onclick="navigator.clipboard.writeText('Email: ${clientData?.email || ''}\nLink: /client-portal/login.html').then(()=>ui.showToast('Copiato!','success'))">üìã Copia credenziali</button>
            <button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="revokeClientAccess('${existing.user_id}')">üóë Revoca accesso</button>
          </div>
        </div>`;
    } else {
      el.innerHTML = `
        <div style="max-width:480px">
          <div style="margin-bottom:20px">
            <p style="font-size:14px;color:#6b7a95;margin-bottom:16px">Crea un accesso per questo cliente al portale. Ricever√† le credenziali che potr√† usare su <strong>/client-portal/login.html</strong></p>
          </div>
          <div class="form-group">
            <label class="form-label">Email accesso</label>
            <input type="email" id="acc-email" class="form-control" placeholder="email@cliente.com" value="${clientData?.email || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Password temporanea</label>
            <div style="display:flex;gap:8px">
              <input type="text" id="acc-pwd" class="form-control" value="${generatePassword()}">
              <button class="btn btn-ghost btn-sm" onclick="document.getElementById('acc-pwd').value=generatePassword()">‚Ü∫</button>
            </div>
            <div style="font-size:11px;color:#94a3b8;margin-top:4px">Il cliente potr√† cambiarla dopo il primo accesso</div>
          </div>
          <button class="btn btn-accent" onclick="createClientAccess()" id="btn-create-access">üîë Crea accesso</button>
        </div>`;
    }
  } catch(e) {
    el.innerHTML = '<div class="alert alert-danger">' + e.message + '</div>';
  }
}

function generatePassword() {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#';
  return Array.from({length: 10}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

async function createClientAccess() {
  const email = document.getElementById('acc-email').value.trim();
  const pwd   = document.getElementById('acc-pwd').value.trim();
  if (!email || !pwd) { ui.showToast('Inserisci email e password', 'error'); return; }

  const btn = document.getElementById('btn-create-access');
  btn.disabled = true; btn.textContent = 'Creazione...';

  try {
    const r = await fetch('/api/create-client-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pwd, client_id: clientId, company_name: clientData?.company_name })
    });
    const data = await r.json();
    if (!r.ok || data.error) throw new Error(data.error || 'Errore creazione');
    // Show credentials in the panel permanently
    document.getElementById('accesso-content').innerHTML = `
      <div style='max-width:480px'>
        <div style='background:#f0fdf4;border:1.5px solid #86efac;border-radius:12px;padding:20px;margin-bottom:16px'>
          <div style='font-weight:700;color:#059669;font-size:15px;margin-bottom:12px'>‚úì Accesso creato con successo</div>
          <div style='font-size:13px;color:#374151;margin-bottom:8px'>Comunica queste credenziali al cliente:</div>
          <div style='background:white;border-radius:8px;padding:14px;font-family:monospace;font-size:14px;border:1px solid #86efac'>
            <div style='margin-bottom:6px'><span style='color:#6b7a95'>Email:</span> <strong>${email}</strong></div>
            <div><span style='color:#6b7a95'>Password:</span> <strong>${pwd}</strong></div>
          </div>
          <div style='font-size:12px;color:#6b7a95;margin-top:10px'>üîó Link accesso: <strong>/client-portal/login.html</strong></div>
        </div>
        <div style='display:flex;gap:12px'>
          <button class='btn btn-ghost' onclick="navigator.clipboard.writeText('Email: ${email}\nPassword: ${pwd}\nLink: /client-portal/login.html').then(()=>ui.showToast('Copiato!','success'))">üìã Copia credenziali</button>
          <button class='btn btn-ghost' onclick='resetClientPassword()'>üîë Reset Password</button>
          <button class='btn' style='background:#fee2e2;color:#dc2626;border:1px solid #fca5a5' onclick='loadAccessTab()'>‚Ü∫ Aggiorna</button>
        </div>
      </div>`;
  } catch(e) {
    ui.showToast('Errore: ' + e.message, 'error');
    btn.disabled = false; btn.textContent = 'üîë Crea accesso';
  }
}

async function revokeClientAccess(userId) {
  if (!confirm('Revocare l accesso di questo cliente? L utente verr√† eliminato.')) return;
  try {
    const r = await fetch('/api/delete-client-user', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: userId })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Errore eliminazione');
    ui.showToast('Accesso revocato', 'success');
    await loadAccessTab();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}

async function resetClientPassword() {
  // Legacy ‚Äî kept for compatibility
  await resetClientPasswordWithValue();
}

async function resetClientPasswordWithValue() {
  const newPwd = document.getElementById('new-pwd-display')?.value || generatePassword();
  const links = await sb.db.select('client_users', { filter: 'client_id=eq.' + clientId, columns: 'user_id' });
  const userId = links?.[0]?.user_id;
  if (!userId) { ui.showToast('Utente non trovato', 'error'); return; }
  const token = sb.getSession()?.access_token;
  const r = await fetch('/api/update-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ userId, password: newPwd })
  });
  const data = await r.json();
  if (!r.ok || data.error) { ui.showToast('Errore: ' + (data.error || r.status), 'error'); return; }
  // Show confirmation with the password visible
  ui.showToast('‚úÖ Password aggiornata!', 'success');
  // Copy to clipboard automatically
  navigator.clipboard.writeText('Email: ' + (clientData?.email||'') + '\nPassword: ' + newPwd + '\nLink: /client-portal/login.html')
    .then(() => ui.showToast('üìã Credenziali copiate negli appunti', 'success', 4000))
    .catch(() => {});
}


async function loadVistiTab() {
  const el = document.getElementById('visti-content');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const visas = await sb.db.select('client_visas', {
      filter: 'client_id=eq.' + clientId,
      columns: 'id,holder_name,visa_type,expiry_date,notes',
      order: 'expiry_date.asc'
    }) || [];

    const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'numeric'}) : '‚Äî';
    const daysLeft = d => d ? Math.round((new Date(d) - new Date()) / 86400000) : null;
    const badgeVisa = d => {
      const days = daysLeft(d);
      if (days === null) return '';
      if (days < 0) return '<span class="badge danger">Scaduto</span>';
      if (days <= 60) return `<span class="badge warning">${days}gg</span>`;
      return '<span class="badge success">OK</span>';
    };

    const rows = visas.map(v => `
      <tr>
        <td style="font-weight:600">${v.holder_name}</td>
        <td>${v.visa_type||'Residenza'}</td>
        <td>${fmtDate(v.expiry_date)} ${badgeVisa(v.expiry_date)}</td>
        <td style="color:var(--text-muted);font-size:12px">${v.notes||'‚Äî'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="editVisa('${v.id}','${v.holder_name.replace(/'/g,"\'")}','${v.visa_type||'Residenza'}','${v.expiry_date||''}','${(v.notes||'').replace(/'/g,"\'")}')">‚úé</button>
          <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="deleteVisa('${v.id}')">üóë</button>
        </td>
      </tr>`).join('');

    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-size:14px;font-weight:600;color:var(--text)">Visti attivi sulla licenza</div>
        <button class="btn btn-accent btn-sm" onclick="showAddVisa()">+ Aggiungi Visto</button>
      </div>

      <div id="visa-form" style="display:none;background:#f8fafc;border:1.5px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group" style="margin:0">
            <label class="form-label">Nome Titolare *</label>
            <input type="text" class="form-control" id="v-name" placeholder="es. Mario Rossi">
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Tipo Visto</label>
            <select class="form-control" id="v-type">
              <option value="Residenza">Residenza</option>
              <option value="Investor">Investor</option>
              <option value="Employment">Employment</option>
              <option value="Dependant">Dependant</option>
              <option value="Visit">Visit</option>
            </select>
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Scadenza</label>
            <input type="date" class="form-control" id="v-expiry">
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Note</label>
            <input type="text" class="form-control" id="v-notes" placeholder="facoltativo">
          </div>
        </div>
        <input type="hidden" id="v-id">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-accent btn-sm" onclick="saveVisa()">üíæ Salva</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('visa-form').style.display='none'">Annulla</button>
        </div>
      </div>

      ${visas.length ? `
      <div class="table-wrap">
        <table>
          <thead><tr><th>Titolare</th><th>Tipo</th><th>Scadenza</th><th>Note</th><th></th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>` : '<div style="padding:30px;text-align:center;color:var(--text-muted)">Nessun visto registrato. Clicca "+ Aggiungi Visto" per iniziare.</div>'}
    `;
  } catch(e) {
    el.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function showAddVisa() {
  document.getElementById('v-id').value = '';
  document.getElementById('v-name').value = '';
  document.getElementById('v-type').value = 'Residenza';
  document.getElementById('v-expiry').value = '';
  document.getElementById('v-notes').value = '';
  document.getElementById('visa-form').style.display = 'block';
  document.getElementById('v-name').focus();
}

function editVisa(id, name, type, expiry, notes) {
  document.getElementById('v-id').value = id;
  document.getElementById('v-name').value = name;
  document.getElementById('v-type').value = type;
  document.getElementById('v-expiry').value = expiry;
  document.getElementById('v-notes').value = notes;
  document.getElementById('visa-form').style.display = 'block';
  document.getElementById('v-name').focus();
}

async function saveVisa() {
  const name = document.getElementById('v-name').value.trim();
  if (!name) { ui.showToast('Nome titolare obbligatorio', 'error'); return; }
  const id = document.getElementById('v-id').value;
  const data = {
    holder_name: name,
    visa_type: document.getElementById('v-type').value,
    expiry_date: document.getElementById('v-expiry').value || null,
    notes: document.getElementById('v-notes').value.trim() || null,
    client_id: clientId
  };
  try {
    if (id) {
      await sb.db.update('client_visas', 'id=eq.' + id, data);
    } else {
      await sb.db.insert('client_visas', data);
    }
    ui.showToast('Visto salvato', 'success');
    await loadVistiTab();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}

async function deleteVisa(id) {
  if (!confirm('Eliminare questo visto?')) return;
  try {
    await sb.db.delete('client_visas', 'id=eq.' + id);
    ui.showToast('Visto eliminato', 'success');
    await loadVistiTab();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRATICHE TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRACTICE_STATUSES = {
  in_attesa:     { label: 'In Attesa',        color: '#64748b', bg: '#f1f5f9', border: '#cbd5e1' },
  in_lavorazione:{ label: 'In Lavorazione',   color: '#d97706', bg: '#fffbeb', border: '#fde68a' },
  attesa_docs:   { label: 'Attesa Documenti', color: '#7c3aed', bg: '#f5f3ff', border: '#ddd6fe' },
  completato:    { label: '‚úì Completato',     color: '#059669', bg: '#f0fdf4', border: '#86efac' },
  annullato:     { label: 'Annullato',        color: '#dc2626', bg: '#fef2f2', border: '#fca5a5' },
};
const PRACTICE_CATEGORIES = ['Company Formation','VAT','Corporate Tax','Golden Visa','Contabilit√†','Banking','Real Estate','Visa/Permesso','Licenza','Altro'];

async function loadPraticheTab() {
  const el = document.getElementById('pratiche-content');
  el.innerHTML = '<div class="spinner"></div>';
  const role = sb.getCurrentProfile()?.role;
  const canEdit = ['admin','mini_admin'].includes(role);

  try {
    const pratiche = await sb.db.select('client_practices', {
      filter: 'client_id=eq.' + clientId,
      columns: 'id,title,category,status,description,notes,due_date,completed_at,created_at',
      order: 'created_at.desc'
    }) || [];

    const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'}) : '‚Äî';
    const badge = s => {
      const st = PRACTICE_STATUSES[s] || PRACTICE_STATUSES.in_attesa;
      return `<span style="display:inline-flex;align-items:center;padding:3px 10px;border-radius:100px;font-size:11px;font-weight:700;background:${st.bg};color:${st.color};border:1px solid ${st.border}">${st.label}</span>`;
    };

    const cards = pratiche.map(p => `
      <div style="background:white;border:1.5px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:10px;display:flex;align-items:flex-start;gap:16px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap">
            <div style="font-weight:700;font-size:14px">${ui.escapeHtml(p.title)}</div>
            ${badge(p.status)}
            <span style="font-size:11px;color:var(--text-muted);background:#f1f5f9;padding:2px 8px;border-radius:100px">${p.category||'Altro'}</span>
          </div>
          ${p.description ? `<div style="font-size:13px;color:var(--text-muted);margin-bottom:6px">${ui.escapeHtml(p.description)}</div>` : ''}
          ${p.notes ? `<div style="font-size:12px;color:#7c3aed;background:#f5f3ff;border-radius:6px;padding:5px 10px;margin-top:6px">üìù ${ui.escapeHtml(p.notes)}</div>` : ''}
          <div style="font-size:11px;color:var(--text-muted);margin-top:8px">
            Creata: ${fmtDate(p.created_at)}
            ${p.due_date ? ` ¬∑ Scadenza: <strong>${fmtDate(p.due_date)}</strong>` : ''}
            ${p.completed_at ? ` ¬∑ Completata: ${fmtDate(p.completed_at)}` : ''}
          </div>
        </div>
        ${canEdit ? `<div style="display:flex;gap:6px;flex-shrink:0">
          <button class="btn btn-ghost btn-sm" onclick="editPratica('${p.id}')">‚úé</button>
          <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="deletePratica('${p.id}')">üóë</button>
        </div>` : ''}
      </div>`).join('');

    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-size:14px;font-weight:600">Pratiche del cliente</div>
        ${canEdit ? '<button class="btn btn-accent btn-sm" onclick="showPraticaForm()">+ Nuova Pratica</button>' : ''}
      </div>

      <div id="pratica-form" style="display:none;background:#f8fafc;border:1.5px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group" style="margin:0;grid-column:1/-1">
            <label class="form-label">Titolo Pratica *</label>
            <input type="text" class="form-control" id="p-title" placeholder="es. Rinnovo Trade License 2026">
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Categoria</label>
            <select class="form-control" id="p-category">
              ${PRACTICE_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Stato</label>
            <select class="form-control" id="p-status">
              ${Object.entries(PRACTICE_STATUSES).map(([k,v]) => `<option value="${k}">${v.label}</option>`).join('')}
            </select>
          </div>
          <div class="form-group" style="margin:0;grid-column:1/-1">
            <label class="form-label">Descrizione (visibile al cliente)</label>
            <textarea class="form-control" id="p-description" rows="2" placeholder="Breve descrizione della pratica..."></textarea>
          </div>
          <div class="form-group" style="margin:0;grid-column:1/-1">
            <label class="form-label">Note interne (non visibili al cliente)</label>
            <textarea class="form-control" id="p-notes" rows="2" placeholder="Note solo per lo staff..."></textarea>
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Scadenza</label>
            <input type="date" class="form-control" id="p-due-date">
          </div>
        </div>
        <input type="hidden" id="p-id">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-accent btn-sm" onclick="savePratica()">üíæ Salva</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('pratica-form').style.display='none'">Annulla</button>
        </div>
      </div>

      ${pratiche.length ? cards : '<div style="padding:30px;text-align:center;color:var(--text-muted)">Nessuna pratica registrata.</div>'}
    `;
  } catch(e) { el.innerHTML = `<div class="alert alert-danger">${e.message}</div>`; }
}

function showPraticaForm(p=null) {
  document.getElementById('p-id').value = p?.id || '';
  document.getElementById('p-title').value = p?.title || '';
  document.getElementById('p-category').value = p?.category || 'Altro';
  document.getElementById('p-status').value = p?.status || 'in_attesa';
  document.getElementById('p-description').value = p?.description || '';
  document.getElementById('p-notes').value = p?.notes || '';
  document.getElementById('p-due-date').value = p?.due_date || '';
  document.getElementById('pratica-form').style.display = 'block';
  document.getElementById('p-title').focus();
}

let praticheCache = [];
async function editPratica(id) {
  const pratiche = await sb.db.select('client_practices', {
    filter: 'id=eq.' + id,
    columns: 'id,title,category,status,description,notes,due_date'
  });
  if (pratiche?.[0]) showPraticaForm(pratiche[0]);
}

async function savePratica() {
  const title = document.getElementById('p-title').value.trim();
  if (!title) { ui.showToast('Titolo obbligatorio', 'error'); return; }
  const id = document.getElementById('p-id').value;
  const status = document.getElementById('p-status').value;
  const data = {
    title,
    category: document.getElementById('p-category').value,
    status,
    description: document.getElementById('p-description').value.trim() || null,
    notes: document.getElementById('p-notes').value.trim() || null,
    due_date: document.getElementById('p-due-date').value || null,
    client_id: clientId,
    updated_at: new Date().toISOString(),
    completed_at: status === 'completato' ? new Date().toISOString() : null,
  };
  try {
    if (id) await sb.db.update('client_practices', 'id=eq.' + id, data);
    else await sb.db.insert('client_practices', data);
    ui.showToast('Pratica salvata', 'success');
    document.getElementById('pratica-form').style.display = 'none';
    await loadPraticheTab();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}

async function deletePratica(id) {
  if (!confirm('Eliminare questa pratica?')) return;
  try {
    await sb.db.delete('client_practices', 'id=eq.' + id);
    ui.showToast('Pratica eliminata', 'success');
    await loadPraticheTab();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}


init();
</script>

<!-- Edit Modal -->
<div class="modal-overlay" id="modal-edit" style="display:none">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <div class="modal-title">‚úé Modifica Cliente</div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-edit').style.display='none'">‚úï</button>
    </div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Ragione Sociale *</label>
          <input type="text" class="form-control" id="e-company">
        </div>
        <div class="form-group">
          <label class="form-label">Referente</label>
          <input type="text" class="form-control" id="e-contact">
        </div>
        <div class="form-group">
          <label class="form-label">General Manager</label>
          <input type="text" class="form-control" id="e-gm" placeholder="Nome GM...">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="e-email">
        </div>
        <div class="form-group">
          <label class="form-label">Telefono UAE</label>
          <input type="text" class="form-control" id="e-phone">
        </div>
        <div class="form-group">
          <label class="form-label">Partner Contabilit√†</label>
          <select class="form-control" id="e-partner">
            <option value="">‚Äî</option>
            <option value="noi">Noi</option>
            <option value="vat_consultant">VAT Consultant</option>
            <option value="affinitas">Affinitas</option>
            <option value="in_sospeso">In Sospeso</option>
            <option value="altro">Altro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Partner VAT</label>
          <select class="form-control" id="e-vat-partner">
            <option value="">‚Äî</option>
            <option value="noi">Noi</option>
            <option value="vat_consultant">VAT Consultant</option>
            <option value="affinitas">Affinitas</option>
            <option value="in_sospeso">In Sospeso</option>
            <option value="altro">Altro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Costo Abbonamento (AED)</label>
          <input type="number" class="form-control" id="e-cost" step="100">
        </div>
        <div class="form-group">
          <label class="form-label">Giorno Addebito</label>
          <input type="number" class="form-control" id="e-sub-day" min="1" max="31">
        </div>
        <div class="form-group">
          <label class="form-label">Data Avvio</label>
          <input type="date" class="form-control" id="e-start">
        </div>
        <div class="form-group">
          <label class="form-label">Trade License ‚Äî Emissione</label>
          <input type="date" class="form-control" id="e-tl-issue">
        </div>
        <div class="form-group">
          <label class="form-label">Trade License ‚Äî Scadenza</label>
          <input type="date" class="form-control" id="e-tl-date">
        </div>
        <div class="form-group">
          <label class="form-label">Scad. Corporate Tax</label>
          <input type="date" class="form-control" id="e-ct-expiry">
        </div>
        <div class="form-group">
          <label class="form-label">Free Zone</label>
          <input type="text" class="form-control" id="e-free-zone" placeholder="es. IFZA, DMCC...">
        </div>
        <div class="form-group">
          <label class="form-label">Tipo Societ√†</label>
          <input type="text" class="form-control" id="e-company-type" placeholder="es. FZCO, FZE, LLC...">
        </div>
        <div class="form-group">
          <label class="form-label">N. Licenza</label>
          <input type="text" class="form-control" id="e-license-number">
        </div>
        <div class="form-group">
          <label class="form-label">Nazionalit√† Titolare</label>
          <input type="text" class="form-control" id="e-nationality" placeholder="es. Italiano">
        </div>
        <div class="form-group">
          <label class="form-label">Emirates ID ‚Äî Scadenza</label>
          <input type="date" class="form-control" id="e-eid-expiry">
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Conti Bancari</label>
          <div id="e-banks" style="display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--surface2);border-radius:8px">
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="wio"> Wio</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="stripe"> Stripe</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="paypal"> PayPal</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="mashreq"> Mashreq</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="payoneer"> Payoneer</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="hubpay"> Hubpay</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="credium"> Credium</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="ziina"> Ziina</label>
            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer"><input type="checkbox" value="mamo"> Mamo</label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Note Bancarie</label>
          <input type="text" class="form-control" id="e-bank-notes">
        </div>
        <div class="form-group">
          <label class="form-label">üîó Zoho Books Org ID</label>
          <input type="text" class="form-control" id="e-zoho-org" placeholder="es. 123456789">
        </div>
        <div class="form-group" style="grid-column:1/-1;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px">
          <div style="font-size:11px;font-weight:700;color:#0369a1;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üîê Credenziali FTA (solo admin/senior)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="form-group" style="margin:0">
              <label class="form-label">FTA Username</label>
              <input type="text" class="form-control" id="e-fta-user" placeholder="Username FTA...">
            </div>
            <div class="form-group" style="margin:0">
              <label class="form-label">FTA Password</label>
              <input type="text" class="form-control" id="e-fta-pass" placeholder="Password FTA...">
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Note</label>
          <textarea class="form-control" id="e-notes" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;font-weight:600">
            <input type="checkbox" id="e-active"> Cliente Attivo
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;font-weight:600;margin-top:8px">
            <input type="checkbox" id="e-bilancio"> In Bilancio
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;font-weight:600;margin-top:8px">
            <input type="checkbox" id="e-vat-reg"> VAT Registrato
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;font-weight:600;margin-top:8px">
            <input type="checkbox" id="e-ct-reg"> Corporate Tax Registrato
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between">
      <button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="deleteClient()">üóë Elimina Cliente</button>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="document.getElementById('modal-edit').style.display='none'">Annulla</button>
        <button class="btn btn-accent" id="btn-save-edit" onclick="saveEdit()">Salva Modifiche</button>
      </div>
    </div>
  </div>

</div>

<script>
function toggleFtaPwd(pwd, user) {
  const el = document.getElementById('fta-pwd-display');
  const btn = el.nextElementSibling;
  if (btn.textContent === 'Mostra') {
    el.textContent = pwd || '‚Äî';
    el.style.letterSpacing = '0';
    btn.textContent = 'Nascondi';
  } else {
    el.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    el.style.letterSpacing = '2px';
    btn.textContent = 'Mostra';
  }
}

async function saveEdit() {
  const company = document.getElementById('e-company').value.trim();
  if (!company) { ui.showToast('Nome azienda obbligatorio','error'); return; }
  const btn = document.getElementById('btn-save-edit');
  btn.disabled = true; btn.textContent = 'Salvo...';
  const banks = [...document.querySelectorAll('#e-banks input:checked')].map(el => el.value);
  try {
    await sb.db.update('clients', `id=eq.${clientId}`, {
      company_name: company,
      contact_name: document.getElementById('e-contact').value.trim()||null,
      email: document.getElementById('e-email').value.trim()||null,
      phone_uae: document.getElementById('e-phone').value.trim()||null,
      accounting_partner: document.getElementById('e-partner').value||null,
      vat_partner: document.getElementById('e-vat-partner').value||null,
      service_cost: parseFloat(document.getElementById('e-cost').value)||null,
      subscription_day: parseInt(document.getElementById('e-sub-day').value)||null,
      start_date: document.getElementById('e-start').value||null,
      license_issue_date: document.getElementById('e-tl-issue').value||null,
      trade_license_date: document.getElementById('e-tl-date').value||null,
      corporate_tax_expiry: document.getElementById('e-ct-expiry').value||null,
      free_zone: document.getElementById('e-free-zone').value.trim()||null,
      company_type: document.getElementById('e-company-type').value.trim()||null,
      license_number: document.getElementById('e-license-number').value.trim()||null,
      nationality: document.getElementById('e-nationality').value.trim()||null,
      eid_expiry: document.getElementById('e-eid-expiry').value||null,
      bank_accounts: banks.length ? banks : null,
      bank_notes: document.getElementById('e-bank-notes').value.trim()||null,
      notes: document.getElementById('e-notes').value.trim()||null,
      is_active: document.getElementById('e-active').checked,
      in_bilancio: document.getElementById('e-bilancio').checked,
      vat_registered: document.getElementById('e-vat-reg').checked,
      corporate_tax_registered: document.getElementById('e-ct-reg').checked,
      general_manager: document.getElementById('e-gm').value.trim()||null,
      zoho_org_id: document.getElementById('e-zoho-org').value.trim()||null,
      fta_username: document.getElementById('e-fta-user').value.trim()||null,
      fta_password: document.getElementById('e-fta-pass').value.trim()||null,
    });
    document.getElementById('modal-edit').style.display = 'none';
    ui.showToast('Cliente aggiornato ‚úì','success');
    await loadClient();
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
  finally { btn.disabled=false; btn.textContent='Salva Modifiche'; }
}

async function deleteClient() {
  if (!confirm('Eliminare questo cliente? L\'operazione √® irreversibile.')) return;
  try {
    await sb.db.delete('clients', `id=eq.${clientId}`);
    ui.showToast('Cliente eliminato','success');
    setTimeout(() => window.location.href='/clients.html', 800);
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

async function loadDocumentsPanel() {
  const panel = document.getElementById('doc-panel-content');
  if (!panel) return;
  panel.innerHTML = '<div style="text-align:center;padding:30px"><div class="spinner"></div></div>';

  const SB = window.ENV_SUPABASE_URL;
  const AK = window.ENV_SUPABASE_ANON_KEY;
  const tok = sb.getSession()?.access_token || AK;

  try {
    const r = await fetch(
      `${SB}/rest/v1/client_files?client_id=eq.${clientId}&select=id,display_name,file_size,mime_type,folder,created_at&order=created_at.desc&limit=50`,
      { headers: { apikey: AK, Authorization: `Bearer ${tok}` } }
    );
    const files = await r.json();
    if (!r.ok) throw new Error(files?.message || 'HTTP ' + r.status);
    const visible = Array.isArray(files) ? files.filter(f => f.display_name !== '.keep') : [];

    const folders = new Set();
    visible.forEach(f => {
      const p = f.folder.replace(/^\//, '').split('/').filter(Boolean);
      if (p.length) folders.add(p[0]);
    });
    const rootFiles = visible.filter(f => f.folder === '/');

    const eico = (m, n) => {
      const e = (n||'').split('.').pop().toLowerCase();
      const mp = {pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',jpg:'üñº',jpeg:'üñº',png:'üñº',zip:'üóú',txt:'üìÉ'};
      return m?.includes('pdf') ? 'üìÑ' : m?.startsWith('image') ? 'üñº' : mp[e] || 'üìé';
    };
    const esz = b => !b ? '' : b < 1048576 ? (b/1024).toFixed(0)+' KB' : (b/1048576).toFixed(1)+' MB';

    let html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
    html += `<div style="font-size:13px;color:var(--text-muted)">${visible.length} file${folders.size ? ' ¬∑ ' + folders.size + ' cartelle' : ''}</div>`;
    html += `<a href="/documents.html?client=${clientId}" class="btn btn-accent btn-sm" style="text-decoration:none">üìÅ Apri Drive ‚Üí</a></div>`;

    if (!visible.length) {
      html += `<div style="text-align:center;padding:40px;color:var(--text-muted)">
        <div style="font-size:36px;margin-bottom:12px">üìÇ</div>
        <div style="font-weight:600;margin-bottom:12px">Nessun documento</div>
        <a href="/documents.html?client=${clientId}" class="btn btn-accent" style="text-decoration:none;display:inline-block">‚¨Ü Carica documenti</a>
      </div>`;
    } else {
      if (folders.size) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px">';
        folders.forEach(name => {
          const cnt = visible.filter(f => f.folder.startsWith('/'+name+'/')).length;
          html += `<div style="background:white;border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer" onclick="window.location.href='/documents.html?client=${clientId}'">
            <span style="font-size:20px">üìÅ</span>
            <div><div style="font-size:13px;font-weight:600">${ui.escapeHtml(name)}</div>
            <div style="font-size:11px;color:var(--text-muted)">${cnt} file</div></div>
          </div>`;
        });
        html += '</div>';
      }
      rootFiles.slice(0, 6).forEach(f => {
        html += `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:white;border:1.5px solid var(--border);border-radius:9px;margin-bottom:6px">
          <span style="font-size:18px">${eico(f.mime_type, f.display_name)}</span>
          <div style="flex:1;min-width:0">
            <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ui.escapeHtml(f.display_name)}</div>
            <div style="font-size:11px;color:var(--text-muted)">${esz(f.file_size)}</div>
          </div>
        </div>`;
      });
      if (rootFiles.length > 6) html += `<div style="font-size:12px;color:var(--text-muted);padding:6px 0">+ altri ${rootFiles.length-6} file...</div>`;
    }
    panel.innerHTML = html;
  } catch(e) {
    panel.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="color:var(--danger);margin-bottom:12px;font-size:13px">Errore: ${e.message}</div>
      <a href="/documents.html?client=${clientId}" class="btn btn-accent" style="text-decoration:none">üìÅ Apri Drive</a>
    </div>`;
  }
}
</script>
</body>
</html>
