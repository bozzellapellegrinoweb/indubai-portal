<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drive â€” InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .drive-layout { display:flex; height:calc(100vh - 57px); overflow:hidden; background:#f0f4f8; }
    .drive-sidebar { width:260px; background:white; border-right:1.5px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
    .drive-sidebar-head { padding:14px 14px 10px; border-bottom:1px solid var(--border); }
    .drive-sidebar-label { font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:8px; }
    .csearch { width:100%; padding:8px 10px 8px 30px; border:1.5px solid var(--border); border-radius:8px; font-size:13px; font-family:inherit; outline:none; background:var(--bg); }
    .csearch:focus { border-color:var(--primary); background:white; }
    .csearch-wrap { position:relative; }
    .csearch-wrap::before { content:'ğŸ”'; position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:11px; }
    .client-list-scroll { flex:1; overflow-y:auto; padding:6px 8px; }
    .crow { display:flex; align-items:center; gap:9px; padding:8px 10px; border-radius:9px; cursor:pointer; transition:background .12s; margin-bottom:1px; }
    .crow:hover { background:var(--bg); }
    .crow.active { background:#e8f0fe; }
    .crow.active .crow-name { color:var(--primary); font-weight:700; }
    .cav { width:28px; height:28px; border-radius:7px; background:var(--primary); color:white; font-size:10px; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .crow-name { font-size:13px; font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--text); }
    .drive-main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }
    .drive-toolbar { background:white; border-bottom:1.5px solid var(--border); padding:10px 18px; display:flex; align-items:center; gap:10px; flex-shrink:0; }
    .bc { display:flex; align-items:center; gap:2px; flex:1; min-width:0; overflow:hidden; }
    .bc-item { font-size:13px; font-weight:600; color:var(--text-muted); cursor:pointer; padding:4px 7px; border-radius:6px; white-space:nowrap; transition:all .12s; }
    .bc-item:hover { background:var(--bg); color:var(--text); }
    .bc-item.cur { color:var(--text); cursor:default; }
    .bc-item.cur:hover { background:none; }
    .bc-sep { color:#ccc; font-size:14px; }
    .vbtn { width:30px; height:30px; border:1.5px solid var(--border); border-radius:7px; background:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all .12s; }
    .vbtn:hover, .vbtn.on { background:var(--primary); border-color:var(--primary); color:white; }
    .upbar { padding:8px 18px; background:linear-gradient(135deg,#1a3a5c,#2563a8); display:none; align-items:center; gap:10px; flex-shrink:0; }
    .upbar.on { display:flex; }
    .upbar-name { font-size:13px; font-weight:600; color:white; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .upbar-track { flex:2; height:4px; background:rgba(255,255,255,.3); border-radius:2px; overflow:hidden; }
    .upbar-fill { height:100%; background:var(--accent); border-radius:2px; transition:width .1s; }
    .upbar-pct { font-size:12px; color:rgba(255,255,255,.8); flex-shrink:0; min-width:32px; text-align:right; }
    .drive-content { flex:1; overflow-y:auto; padding:18px; }
    .dz { border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; cursor:pointer; transition:all .18s; margin-bottom:16px; background:white; }
    .dz:hover, .dz.over { border-color:var(--primary); background:#f0f7ff; }
    .dz-icon { font-size:22px; margin-bottom:4px; }
    .dz-txt { font-size:13px; color:var(--text-muted); }
    .dz-txt strong { color:var(--primary); }
    .igrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; }
    .icard { background:white; border:1.5px solid var(--border); border-radius:12px; padding:16px 12px 12px; cursor:pointer; transition:all .15s; position:relative; text-align:center; user-select:none; }
    .icard:hover { border-color:var(--primary); box-shadow:0 4px 16px rgba(26,58,92,.1); transform:translateY(-2px); }
    .icard.folder:hover { background:#fffbf0; border-color:var(--accent); }
    .icard-icon { font-size:36px; margin-bottom:8px; line-height:1; }
    .icard-name { font-size:12px; font-weight:600; word-break:break-word; line-height:1.4; color:var(--text); overflow:hidden; max-height:3em; }
    .icard-meta { font-size:10px; color:var(--text-muted); margin-top:4px; }
    .icard-acts { position:absolute; top:6px; right:6px; display:none; gap:3px; }
    .icard:hover .icard-acts { display:flex; }
    .abtn { width:26px; height:26px; border-radius:7px; background:white; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.1); transition:all .12s; }
    .abtn:hover { background:var(--primary); color:white; border-color:var(--primary); }
    .abtn.del:hover { background:var(--danger); border-color:var(--danger); }
    .ilist { display:none; }
    .lrow { display:flex; align-items:center; gap:12px; padding:11px 14px; background:white; border:1.5px solid var(--border); border-radius:10px; margin-bottom:6px; cursor:pointer; transition:all .12s; }
    .lrow:hover { border-color:var(--primary); background:#f8faff; }
    .lrow-icon { font-size:20px; flex-shrink:0; }
    .lrow-name { flex:1; font-size:13px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; min-width:0; }
    .lrow-size { font-size:11px; color:var(--text-muted); flex-shrink:0; min-width:55px; text-align:right; }
    .lrow-date { font-size:11px; color:var(--text-muted); flex-shrink:0; min-width:80px; text-align:right; }
    .lrow-acts { display:flex; gap:4px; flex-shrink:0; }
    .empty-s { text-align:center; padding:50px 20px; color:var(--text-muted); }
    .no-client { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); padding:40px; text-align:center; }
    .dmodal-ov { position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
    .dmodal { background:white; border-radius:16px; padding:24px; width:100%; max-width:400px; box-shadow:0 20px 60px rgba(0,0,0,.2); }
    .dmodal h3 { font-size:16px; font-weight:700; margin-bottom:16px; }
    .dmodal input { width:100%; padding:10px 14px; border:1.5px solid var(--border); border-radius:9px; font-size:14px; font-family:inherit; outline:none; }
    .dmodal input:focus { border-color:var(--primary); }
    .dmodal-foot { display:flex; gap:8px; justify-content:flex-end; margin-top:18px; }
    @media(max-width:768px){
      .drive-layout { flex-direction:column; height:auto; overflow:visible; }
      .drive-sidebar { width:100%; height:auto; border-right:none; border-bottom:1.5px solid var(--border); }
      .client-list-scroll { max-height:180px; }
      .drive-main { height:auto; overflow:visible; }
      .drive-content { overflow:visible; }
      .igrid { grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px; }
      .icard { padding:12px 8px 10px; }
      .icard-icon { font-size:28px; }
      .lrow-date { display:none; }
      .dmodal-ov { align-items:flex-end; padding:0; }
      .dmodal { border-radius:16px 16px 0 0; max-width:100%; margin:0; }
    }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content" style="display:flex;flex-direction:column;height:100vh;overflow:hidden">
    <div class="topbar" style="flex-shrink:0">
      <div class="topbar-title">ğŸ“ Drive Documenti</div>
      <div style="display:flex;gap:6px;margin-left:auto">
        <button class="vbtn on" id="btn-grid" onclick="setView('grid')" title="Griglia">âŠ</button>
        <button class="vbtn" id="btn-list" onclick="setView('list')" title="Lista">â˜°</button>
      </div>
    </div>
    <div class="drive-layout">
      <div class="drive-sidebar">
        <div class="drive-sidebar-head">
          <div class="drive-sidebar-label">Clienti</div>
          <div class="csearch-wrap">
            <input class="csearch" type="text" id="csearch" placeholder="Cerca cliente..." oninput="filterC(this.value)">
          </div>
        </div>
        <div class="client-list-scroll" id="client-list">
          <div style="padding:20px;text-align:center"><div class="spinner"></div></div>
        </div>
      </div>
      <div class="drive-main" id="drive-main">
        <div class="no-client" id="no-client">
          <div style="font-size:60px;margin-bottom:16px;opacity:.35">ğŸ“</div>
          <div style="font-size:16px;font-weight:700;margin-bottom:8px;color:var(--text)">Drive Documenti InDubai</div>
          <div style="font-size:13px;max-width:280px">Seleziona un cliente dalla lista per gestire i suoi documenti</div>
        </div>
        <div id="file-area" style="display:none;flex-direction:column;flex:1;overflow:hidden">
          <div class="drive-toolbar">
            <div class="bc" id="bc"></div>
            <div style="display:flex;gap:8px;flex-shrink:0">
              <button class="btn btn-ghost btn-sm" onclick="showFolderModal()">ğŸ“ Cartella</button>
              <label class="btn btn-accent btn-sm" style="cursor:pointer;margin:0">
                â¬† Carica
                <input type="file" id="file-input" multiple style="display:none" onchange="onFilePick(this.files)">
              </label>
            </div>
          </div>
          <div class="upbar" id="upbar">
            <span>â¬†</span>
            <div class="upbar-name" id="upname">Caricamento...</div>
            <div class="upbar-track"><div class="upbar-fill" id="upfill" style="width:0%"></div></div>
            <div class="upbar-pct" id="uppct">0%</div>
          </div>
          <div class="drive-content" id="dcontent"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal-rename" style="display:none" class="dmodal-ov" onclick="if(event.target===this)this.style.display='none'">
  <div class="dmodal">
    <h3>âœ Rinomina</h3>
    <input type="text" id="rename-in" onkeydown="if(event.key==='Enter')doRename()">
    <div class="dmodal-foot">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-rename').style.display='none'">Annulla</button>
      <button class="btn btn-accent" onclick="doRename()">Salva</button>
    </div>
  </div>
</div>

<div id="modal-folder" style="display:none" class="dmodal-ov" onclick="if(event.target===this)this.style.display='none'">
  <div class="dmodal">
    <h3>ğŸ“ Nuova Cartella</h3>
    <input type="text" id="folder-in" placeholder="Nome cartella..." onkeydown="if(event.key==='Enter')doNewFolder()">
    <div class="dmodal-foot">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-folder').style.display='none'">Annulla</button>
      <button class="btn btn-accent" onclick="doNewFolder()">Crea</button>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
const SB  = window.ENV_SUPABASE_URL;
const AK  = window.ENV_SUPABASE_ANON_KEY;
const BKT = 'client-documents';

let clients = [], active = null, path = '/', renCtx = null;
let view = localStorage.getItem('dview') || 'grid';

function tok() { return sb.getSession()?.access_token || AK; }
function hdr(extra) { return { apikey:AK, Authorization:`Bearer ${tok()}`, ...extra }; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtSz(b){ if(!b)return ''; if(b<1024)return b+'B'; if(b<1048576)return (b/1024).toFixed(0)+'KB'; return (b/1048576).toFixed(1)+'MB'; }
function fmtDt(d){ return new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'2-digit'}); }
function ico(m,n){
  const e=(n||'').split('.').pop().toLowerCase();
  const mp={pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',xls:'ğŸ“Š',xlsx:'ğŸ“Š',jpg:'ğŸ–¼',jpeg:'ğŸ–¼',png:'ğŸ–¼',webp:'ğŸ–¼',gif:'ğŸ–¼',zip:'ğŸ—œ',rar:'ğŸ—œ',txt:'ğŸ“ƒ',csv:'ğŸ“Š',ppt:'ğŸ“‘',pptx:'ğŸ“‘'};
  if(m?.startsWith('image'))return 'ğŸ–¼'; if(m?.includes('pdf'))return 'ğŸ“„'; if(m?.includes('word'))return 'ğŸ“';
  if(m?.includes('excel')||m?.includes('spreadsheet'))return 'ğŸ“Š'; return mp[e]||'ğŸ“';
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async()=>{
  const s = sb.getSession();
  if(!s?.access_token){ window.location.href='/login.html'; return; }

  const r = await fetch(`${SB}/rest/v1/clients?is_active=eq.true&select=id,company_name&order=company_name.asc`,
    { headers: hdr() });
  if(!r.ok){ document.getElementById('client-list').innerHTML='<div style="padding:16px;color:var(--danger);font-size:13px">Errore: '+r.status+'</div>'; return; }
  clients = await r.json();
  renderList(clients);
  setView(view);

  const cid = new URLSearchParams(location.search).get('client');
  if(cid){ const c=clients.find(x=>x.id===cid); if(c) pick(c); }
})();

// â”€â”€ CLIENT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(list){
  const el=document.getElementById('client-list');
  if(!list.length){ el.innerHTML='<div style="padding:16px;font-size:13px;color:var(--text-muted);text-align:center">Nessun cliente</div>'; return; }
  el.innerHTML=list.map(c=>`
    <div class="crow ${active?.id===c.id?'active':''}" onclick='pick(${JSON.stringify(c)})'>
      <div class="cav">${c.company_name.slice(0,2).toUpperCase()}</div>
      <div class="crow-name">${esc(c.company_name)}</div>
    </div>`).join('');
}
function filterC(q){ renderList(q ? clients.filter(c=>c.company_name.toLowerCase().includes(q.toLowerCase())) : clients); }

// â”€â”€ PICK CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pick(c){
  if(typeof c==='string') c=clients.find(x=>x.id===c);
  if(!c) return;
  active=c; path='/';
  renderList(clients.filter(x=>{ const q=document.getElementById('csearch').value; return !q||x.company_name.toLowerCase().includes(q.toLowerCase()); }));
  document.getElementById('no-client').style.display='none';
  const fa=document.getElementById('file-area'); fa.style.display='flex';
  loadDir();
}

// â”€â”€ LOAD DIRECTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDir(){
  const dc=document.getElementById('dcontent');
  dc.innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div></div>';
  updateBC();
  try{
    const r=await fetch(`${SB}/rest/v1/client_files?client_id=eq.${active.id}&select=id,display_name,file_size,mime_type,folder,storage_path,created_at&order=display_name.asc`,
      {headers:hdr()});
    const all=await r.json();
    if(!Array.isArray(all)) throw new Error(all?.message||'Errore DB');
    const files=all.filter(f=>f.folder===path && f.display_name!=='.keep');
    const subs=new Set();
    all.forEach(f=>{
      if(!f.folder.startsWith(path)||f.folder===path) return;
      const seg=f.folder.slice(path.length).split('/')[0];
      if(seg) subs.add(seg);
    });
    render(files,[...subs].sort());
  }catch(e){ dc.innerHTML=`<div class="alert alert-danger" style="margin:16px">${e.message}</div>`; }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(files,folders){
  const dc=document.getElementById('dcontent');
  const dz=`<div class="dz" id="dz" onclick="document.getElementById('file-input').click()">
    <div class="dz-icon">â˜ï¸</div>
    <div class="dz-txt">Trascina file qui o <strong>clicca per caricare</strong></div>
    <div class="dz-txt" style="font-size:11px;margin-top:3px">PDF, Word, Excel, Immagini, ZIP â€” max 50MB</div>
  </div>`;

  if(!files.length&&!folders.length){
    dc.innerHTML=dz+`<div class="empty-s"><div style="font-size:48px;margin-bottom:14px;opacity:.5">ğŸ“‚</div><div style="font-size:14px;font-weight:700;margin-bottom:6px">Cartella vuota</div><div>Carica i primi documenti</div></div>`;
    bindDZ(); return;
  }

  // Grid
  let g='<div class="igrid">';
  folders.forEach(n=>{
    g+=`<div class="icard folder" ondblclick="openSub('${esc(n)}')">
      <div class="icard-acts">
        <div class="abtn" onclick="event.stopPropagation();renFolder('${esc(n)}')" title="Rinomina">âœ</div>
        <div class="abtn del" onclick="event.stopPropagation();delFolder('${esc(n)}')" title="Elimina">ğŸ—‘</div>
      </div>
      <div class="icard-icon">ğŸ“</div>
      <div class="icard-name">${esc(n)}</div>
      <div class="icard-meta">Cartella</div>
    </div>`;
  });
  files.forEach(f=>{
    g+=`<div class="icard" ondblclick="dl('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')">
      <div class="icard-acts">
        <div class="abtn" onclick="event.stopPropagation();dl('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')" title="Scarica">â¬‡</div>
        <div class="abtn" onclick="event.stopPropagation();renFile('${esc(f.id)}','${esc(f.display_name)}')" title="Rinomina">âœ</div>
        <div class="abtn del" onclick="event.stopPropagation();delFile('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')" title="Elimina">ğŸ—‘</div>
      </div>
      <div class="icard-icon">${ico(f.mime_type,f.display_name)}</div>
      <div class="icard-name">${esc(f.display_name)}</div>
      <div class="icard-meta">${fmtSz(f.file_size)}</div>
    </div>`;
  });
  g+='</div>';

  // List
  let l='<div class="ilist">';
  folders.forEach(n=>{
    l+=`<div class="lrow" ondblclick="openSub('${esc(n)}')">
      <span class="lrow-icon">ğŸ“</span>
      <span class="lrow-name">${esc(n)}</span>
      <span class="lrow-size">â€”</span>
      <span class="lrow-date">Cartella</span>
      <div class="lrow-acts">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();renFolder('${esc(n)}')">âœ</button>
        <button class="btn btn-sm" style="background:#fee2e2;color:var(--danger);border:1px solid #fca5a5" onclick="event.stopPropagation();delFolder('${esc(n)}')">ğŸ—‘</button>
      </div>
    </div>`;
  });
  files.forEach(f=>{
    l+=`<div class="lrow" ondblclick="dl('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')">
      <span class="lrow-icon">${ico(f.mime_type,f.display_name)}</span>
      <span class="lrow-name">${esc(f.display_name)}</span>
      <span class="lrow-size">${fmtSz(f.file_size)}</span>
      <span class="lrow-date">${fmtDt(f.created_at)}</span>
      <div class="lrow-acts">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();dl('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')">â¬‡</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();renFile('${esc(f.id)}','${esc(f.display_name)}')">âœ</button>
        <button class="btn btn-sm" style="background:#fee2e2;color:var(--danger);border:1px solid #fca5a5" onclick="event.stopPropagation();delFile('${esc(f.id)}','${esc(f.storage_path)}','${esc(f.display_name)}')">ğŸ—‘</button>
      </div>
    </div>`;
  });
  l+='</div>';

  dc.innerHTML=dz+g+l;
  applyView(); bindDZ();
}

// â”€â”€ VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(m){
  view=m; localStorage.setItem('dview',m);
  document.getElementById('btn-grid').classList.toggle('on',m==='grid');
  document.getElementById('btn-list').classList.toggle('on',m==='list');
  applyView();
}
function applyView(){
  document.querySelectorAll('.igrid').forEach(e=>e.style.display=view==='grid'?'grid':'none');
  document.querySelectorAll('.ilist').forEach(e=>e.style.display=view==='list'?'block':'none');
}

// â”€â”€ BREADCRUMB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBC(){
  const bc=document.getElementById('bc');
  const parts=path.split('/').filter(Boolean);
  let h=`<span class="bc-item ${!parts.length?'cur':''}" onclick="goto('/')">ğŸ“ ${esc(active?.company_name||'')}</span>`;
  let built='/';
  parts.forEach((p,i)=>{
    built+=p+'/'; const fp=built; const last=i===parts.length-1;
    h+=`<span class="bc-sep">â€º</span><span class="bc-item ${last?'cur':''}" onclick="goto('${fp}')">${esc(p)}</span>`;
  });
  bc.innerHTML=h;
}
function goto(p){ path=p; loadDir(); }
function openSub(n){ path=path+n+'/'; loadDir(); }

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindDZ(){
  const dz=document.getElementById('dz'); if(!dz) return;
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');if(e.dataTransfer.files.length)onFilePick(e.dataTransfer.files);});
}

// â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function onFilePick(files){
  if(!active) return;
  for(const f of Array.from(files)){
    if(f.size>52428800){ui.showToast(`${f.name} troppo grande (max 50MB)`,'error');continue;}
    await uploadOne(f);
  }
  document.getElementById('file-input').value='';
  loadDir();
}

async function uploadOne(file){
  const bar=document.getElementById('upbar');
  const fill=document.getElementById('upfill');
  const pct=document.getElementById('uppct');
  bar.classList.add('on');
  document.getElementById('upname').textContent=file.name;
  const safe=file.name.replace(/[^a-zA-Z0-9._\-()\s]/g,'_');
  const sp=`${active.id}${path}${Date.now()}_${safe}`;
  await new Promise(res=>{
    const xhr=new XMLHttpRequest();
    xhr.upload.onprogress=e=>{
      if(e.lengthComputable){const p=Math.round(e.loaded/e.total*100);fill.style.width=p+'%';pct.textContent=p+'%';}
    };
    xhr.onload=async()=>{
      if(xhr.status===200||xhr.status===201){
        await fetch(`${SB}/rest/v1/client_files`,{method:'POST',
          headers:hdr({'Content-Type':'application/json',Prefer:'return=minimal'}),
          body:JSON.stringify({client_id:active.id,storage_path:sp,display_name:file.name,original_name:file.name,
            file_size:file.size,mime_type:file.type||null,folder:path,uploaded_by:sb.getCurrentUser()?.id||null})});
        ui.showToast(`${file.name} caricato âœ“`,'success');
      } else { ui.showToast(`Errore upload: ${xhr.status}`,'error'); }
      bar.classList.remove('on'); fill.style.width='0%'; res();
    };
    xhr.onerror=()=>{ui.showToast('Errore di rete','error');bar.classList.remove('on');res();};
    xhr.open('POST',`${SB}/storage/v1/object/${BKT}/${sp}`);
    xhr.setRequestHeader('Authorization',`Bearer ${tok()}`);
    xhr.setRequestHeader('apikey',AK);
    xhr.setRequestHeader('x-upsert','false');
    xhr.send(file);
  });
}

// â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dl(id,sp,name){
  try{
    const r=await fetch(`${SB}/storage/v1/object/authenticated/${BKT}/${sp}`,{headers:hdr()});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const blob=await r.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }catch(e){ui.showToast('Errore download: '+e.message,'error');}
}

// â”€â”€ DELETE FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function delFile(id,sp,name){
  if(!confirm(`Eliminare "${name}"?`)) return;
  try{
    await fetch(`${SB}/storage/v1/object/${BKT}/${sp}`,{method:'DELETE',headers:hdr()});
    await fetch(`${SB}/rest/v1/client_files?id=eq.${id}`,{method:'DELETE',headers:hdr({Prefer:'return=minimal'})});
    ui.showToast('File eliminato','success'); loadDir();
  }catch(e){ui.showToast('Errore: '+e.message,'error');}
}

// â”€â”€ RENAME FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renFile(id,cur){ renCtx={t:'file',id}; document.getElementById('rename-in').value=cur; document.getElementById('modal-rename').style.display='flex'; setTimeout(()=>document.getElementById('rename-in').select(),50); }
function renFolder(n){ renCtx={t:'folder',n}; document.getElementById('rename-in').value=n; document.getElementById('modal-rename').style.display='flex'; setTimeout(()=>document.getElementById('rename-in').select(),50); }

async function doRename(){
  const nv=document.getElementById('rename-in').value.trim(); if(!nv) return;
  try{
    if(renCtx.t==='file'){
      await fetch(`${SB}/rest/v1/client_files?id=eq.${renCtx.id}`,{method:'PATCH',
        headers:hdr({'Content-Type':'application/json',Prefer:'return=minimal'}),
        body:JSON.stringify({display_name:nv,updated_at:new Date().toISOString()})});
    } else {
      const op=path+renCtx.n+'/'; const np=path+nv+'/';
      const r=await fetch(`${SB}/rest/v1/client_files?client_id=eq.${active.id}`,{headers:hdr()});
      const all=await r.json();
      for(const f of all){
        if(!f.folder.startsWith(op)) continue;
        await fetch(`${SB}/rest/v1/client_files?id=eq.${f.id}`,{method:'PATCH',
          headers:hdr({'Content-Type':'application/json',Prefer:'return=minimal'}),
          body:JSON.stringify({folder:f.folder.replace(op,np)})});
      }
    }
    ui.showToast('Rinominato âœ“','success');
    document.getElementById('modal-rename').style.display='none';
    loadDir();
  }catch(e){ui.showToast('Errore: '+e.message,'error');}
}

// â”€â”€ FOLDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFolderModal(){ document.getElementById('folder-in').value=''; document.getElementById('modal-folder').style.display='flex'; setTimeout(()=>document.getElementById('folder-in').focus(),50); }

async function doNewFolder(){
  const n=document.getElementById('folder-in').value.trim(); if(!n) return;
  if(n.includes('/')){ ui.showToast('Nome non puÃ² contenere /','error'); return; }
  try{
    const fp=path+n+'/'; const sp=`${active.id}${fp}.keep`;
    await fetch(`${SB}/storage/v1/object/${BKT}/${sp}`,{method:'POST',headers:{Authorization:`Bearer ${tok()}`,apikey:AK,'Content-Type':'text/plain'},body:''});
    await fetch(`${SB}/rest/v1/client_files`,{method:'POST',headers:hdr({'Content-Type':'application/json',Prefer:'return=minimal'}),
      body:JSON.stringify({client_id:active.id,storage_path:sp,display_name:'.keep',original_name:'.keep',file_size:0,mime_type:'text/plain',folder:fp,uploaded_by:sb.getCurrentUser()?.id||null})});
    document.getElementById('modal-folder').style.display='none';
    ui.showToast(`Cartella "${n}" creata âœ“`,'success'); loadDir();
  }catch(e){ui.showToast('Errore: '+e.message,'error');}
}

async function delFolder(n){
  if(!confirm(`Eliminare la cartella "${n}" e tutto il contenuto?`)) return;
  try{
    const prefix=path+n+'/';
    const r=await fetch(`${SB}/rest/v1/client_files?client_id=eq.${active.id}`,{headers:hdr()});
    const all=await r.json();
    for(const f of all){
      if(!f.folder.startsWith(prefix)) continue;
      await fetch(`${SB}/storage/v1/object/${BKT}/${f.storage_path}`,{method:'DELETE',headers:hdr()});
      await fetch(`${SB}/rest/v1/client_files?id=eq.${f.id}`,{method:'DELETE',headers:hdr({Prefer:'return=minimal'})});
    }
    ui.showToast('Cartella eliminata','success'); loadDir();
  }catch(e){ui.showToast('Errore: '+e.message,'error');}
}
</script>
</body>
</html>
