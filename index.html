<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€” InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    /* â”€â”€ KPI strip â”€â”€ */
    .kpi-strip {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: white;
      border: 1.5px solid var(--border);
      border-radius: 14px;
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
      transition: box-shadow .15s, transform .15s;
    }
    .kpi-card:hover { box-shadow: 0 6px 24px rgba(26,58,92,.1); transform: translateY(-2px); }
    .kpi-card.accent { background: linear-gradient(135deg,#1a3a5c,#2563a8); border-color: transparent; }
    .kpi-card.warn   { background: linear-gradient(135deg,#92400e,#d97706); border-color: transparent; }
    .kpi-card.danger { background: linear-gradient(135deg,#7f1d1d,#dc2626); border-color: transparent; }
    .kpi-card.info   { background: linear-gradient(135deg,#164e63,#0891b2); border-color: transparent; }
    .kpi-label  { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); margin-bottom: 6px; }
    .kpi-value  { font-size: 30px; font-weight: 900; color: var(--text); line-height: 1; margin-bottom: 4px; }
    .kpi-sub    { font-size: 11px; color: var(--text-muted); }
    .kpi-icon   { position: absolute; right: 14px; top: 14px; font-size: 22px; opacity: .18; }
    .kpi-card.accent .kpi-label,
    .kpi-card.warn .kpi-label,
    .kpi-card.danger .kpi-label,
    .kpi-card.info .kpi-label  { color: rgba(255,255,255,.65); }
    .kpi-card.accent .kpi-value,
    .kpi-card.warn .kpi-value,
    .kpi-card.danger .kpi-value,
    .kpi-card.info .kpi-value  { color: white; }
    .kpi-card.accent .kpi-sub,
    .kpi-card.warn .kpi-sub,
    .kpi-card.danger .kpi-sub,
    .kpi-card.info .kpi-sub    { color: rgba(255,255,255,.55); }
    .kpi-card.accent .kpi-icon,
    .kpi-card.warn .kpi-icon,
    .kpi-card.danger .kpi-icon,
    .kpi-card.info .kpi-icon   { color: rgba(255,255,255,.2); opacity: 1; }

    /* â”€â”€ Section tabs â”€â”€ */
    .dash-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .dtab {
      padding: 7px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: white;
      color: var(--text-muted);
      transition: all .15s;
    }
    .dtab:hover { border-color: var(--primary); color: var(--primary); }
    .dtab.on { background: var(--primary); border-color: var(--primary); color: white; }

    /* â”€â”€ Dashboard panels â”€â”€ */
    .dpanel { display: none; }
    .dpanel.on { display: block; }

    /* â”€â”€ Card header with link â”€â”€ */
    .card-header-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--border);
    }
    .card-title-group { display: flex; flex-direction: column; gap: 2px; }
    .card-title-main  { font-size: 14px; font-weight: 700; color: var(--text); }
    .card-title-sub   { font-size: 11px; color: var(--text-muted); }
    .go-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      background: #e8f0fe;
      color: var(--primary);
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }
    .go-btn:hover { background: var(--primary); color: white; }

    /* â”€â”€ Grid layouts â”€â”€ */
    .d2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .d3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .d12col { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }
    .d21col { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }

    /* â”€â”€ Charts â”€â”€ */
    .chart-wrap {
      padding: 16px 20px 20px;
      position: relative;
    }
    .chart-wrap canvas { max-height: 220px; }
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .leg-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text);
    }
    .leg-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

    /* â”€â”€ List rows â”€â”€ */
    .dlist-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      transition: background .1s;
      cursor: pointer;
      text-decoration: none;
    }
    .dlist-row:last-child { border-bottom: none; }
    .dlist-row:hover { background: #f5f9ff; }
    .dlist-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dlist-main { flex: 1; min-width: 0; }
    .dlist-title { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dlist-sub   { font-size: 11px; color: var(--text-muted); }
    .dlist-right { font-size: 11px; font-weight: 700; flex-shrink: 0; }

    /* â”€â”€ Stat bars â”€â”€ */
    .stat-bar { margin: 6px 0; }
    .stat-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .stat-bar-track { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .stat-bar-fill  { height: 100%; border-radius: 3px; transition: width .6s ease; }

    /* â”€â”€ Overview numbers â”€â”€ */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin: 0 20px 20px;
    }
    .ov-cell {
      background: white;
      padding: 16px;
      text-align: center;
    }
    .ov-val { font-size: 24px; font-weight: 900; color: var(--text); }
    .ov-lbl { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    @media (max-width: 900px) {
      .d2col, .d3col, .d12col, .d21col { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .kpi-strip { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .overview-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">Dashboard</div>
        <div class="topbar-subtitle" id="date-label"></div>
      </div>
      <a href="/clients.html?action=new" class="btn btn-accent btn-sm">+ Nuovo Cliente</a>
    </div>

    <div class="page-content">

      <!-- KPI strip -->
      <div class="kpi-strip" id="kpi-grid">
        <div class="kpi-card"><div class="spinner"></div></div>
      </div>

      <!-- Section tabs -->
      <div class="dash-tabs">
        <div class="dtab on" onclick="switchTab('overview')">â—ˆ Panoramica</div>
        <div class="dtab" onclick="switchTab('tasks')">âœ“ Task</div>
        <div class="dtab" onclick="switchTab('payments')">ğŸ’³ Pagamenti</div>
        <div class="dtab" onclick="switchTab('deadlines')">â° Scadenze</div>
        <div class="dtab" onclick="switchTab('clients')">ğŸ‘¥ Clienti</div>
      </div>

      <!-- â•â•â• PANORAMICA â•â•â• -->
      <div class="dpanel on" id="panel-overview">
        <div class="d2col">
          <!-- Donut clienti per tipo -->
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ‘¥ Clienti per Tipo</div>
                <div class="card-title-sub">Distribuzione attivi</div>
              </div>
              <a href="/clients.html" class="go-btn">Vai ai Clienti â†’</a>
            </div>
            <div class="chart-wrap">
              <canvas id="chart-clients-type"></canvas>
              <div class="chart-legend" id="legend-clients-type"></div>
            </div>
          </div>

          <!-- Donut pagamenti mese -->
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ’³ Abbonamenti Mese</div>
                <div class="card-title-sub" id="pay-month-label">Mese corrente</div>
              </div>
              <a href="/payments.html" class="go-btn">Vai ai Pagamenti â†’</a>
            </div>
            <div class="chart-wrap">
              <canvas id="chart-payments"></canvas>
              <div class="chart-legend" id="legend-payments"></div>
            </div>
          </div>
        </div>

        <!-- Scadenze + stati onboarding -->
        <div class="d2col">
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ“‹ Estratti Conto</div>
                <div class="card-title-sub">Copertura mese corrente</div>
              </div>
              <a href="/statements.html" class="go-btn">Vai agli Estratti â†’</a>
            </div>
            <div id="overview-statements" style="padding:16px 20px">
              <div class="spinner"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">âœ¦ Onboarding</div>
                <div class="card-title-sub">Stato completamento</div>
              </div>
              <a href="/onboarding.html" class="go-btn">Vai all'Onboarding â†’</a>
            </div>
            <div id="overview-onboarding" style="padding:16px 20px">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• TASK â•â•â• -->
      <div class="dpanel" id="panel-tasks">
        <div class="d2col">
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">âœ“ Le mie Task</div>
                <div class="card-title-sub">Aperte e in corso</div>
              </div>
              <a href="/tasks.html?filter=mine" class="go-btn">Vedi tutte â†’</a>
            </div>
            <div id="my-tasks"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>

          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ”¥ Task Urgenti</div>
                <div class="card-title-sub">Tutte le prioritÃ  urgenti aperte</div>
              </div>
              <a href="/tasks.html?filter=urgent" class="go-btn">Vedi tutte â†’</a>
            </div>
            <div id="urgent-tasks"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
        </div>

        <!-- Task chart -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header-link">
            <div class="card-title-group">
              <div class="card-title-main">ğŸ“Š Distribuzione Task</div>
              <div class="card-title-sub">Per prioritÃ  e stato</div>
            </div>
            <a href="/tasks.html" class="go-btn">Gestisci Task â†’</a>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
            <div class="chart-wrap" style="border-right:1px solid var(--border)">
              <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px">Per prioritÃ </div>
              <canvas id="chart-tasks-priority"></canvas>
            </div>
            <div class="chart-wrap">
              <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px">Per stato</div>
              <canvas id="chart-tasks-status"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• PAGAMENTI â•â•â• -->
      <div class="dpanel" id="panel-payments">
        <div class="d2col">
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">âš¡ Da Verificare</div>
                <div class="card-title-sub">Problemi mese corrente</div>
              </div>
              <a href="/payments.html" class="go-btn">Vai ai Pagamenti â†’</a>
            </div>
            <div id="payment-issues"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>

          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ“Š Status Pagamenti</div>
                <div class="card-title-sub">Distribuzione mese corrente</div>
              </div>
              <a href="/payments.html" class="go-btn">Gestisci â†’</a>
            </div>
            <div class="chart-wrap">
              <canvas id="chart-pay-status"></canvas>
              <div class="chart-legend" id="legend-pay-status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• SCADENZE â•â•â• -->
      <div class="dpanel" id="panel-deadlines">
        <div class="d2col">
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">â° Alert Prossimi 14gg</div>
                <div class="card-title-sub">VAT, Trade License, Corp Tax</div>
              </div>
            </div>
            <div id="upcoming-alerts"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>

          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ“… VAT Return â€” 30 giorni</div>
                <div class="card-title-sub">Scadenze prossime</div>
              </div>
              <a href="/vat.html" class="go-btn">Vai al VAT â†’</a>
            </div>
            <div id="vat-deadlines"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>

      <!-- â•â•â• CLIENTI â•â•â• -->
      <div class="dpanel" id="panel-clients">
        <div class="d2col">
          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">âš  Estratti Mancanti</div>
                <div class="card-title-sub">Mese corrente</div>
              </div>
              <a href="/statements.html" class="go-btn">Vai agli Estratti â†’</a>
            </div>
            <div id="missing-statements"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>

          <div class="card">
            <div class="card-header-link">
              <div class="card-title-group">
                <div class="card-title-main">ğŸ‘¥ Clienti per Zona</div>
                <div class="card-title-sub">Free zone vs Mainland</div>
              </div>
              <a href="/clients.html" class="go-btn">Vai ai Clienti â†’</a>
            </div>
            <div class="chart-wrap">
              <canvas id="chart-clients-zone"></canvas>
              <div class="chart-legend" id="legend-clients-zone"></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /page-content -->
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
const { year, month } = ui.currentYearMonth();
document.getElementById('date-label').textContent = `${ui.MONTHS_FULL[month - 1]} ${year}`;
document.getElementById('pay-month-label').textContent = `${ui.MONTHS[month-1]} ${year}`;

const role = sb.getCurrentProfile()?.role || 'junior';
const isAdmin = role === 'admin';

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tabLoaded = {};
function switchTab(name) {
  document.querySelectorAll('.dtab').forEach((t,i) => t.classList.toggle('on', t.textContent.toLowerCase().includes(name) || (name==='overview' && i===0)));
  document.querySelectorAll('.dpanel').forEach(p => p.classList.remove('on'));
  document.getElementById('panel-'+name).classList.add('on');
  if (!tabLoaded[name]) { tabLoaded[name] = true; loadTab(name); }
}

function loadTab(name) {
  if (name === 'overview')   { loadClientTypeChart(); loadPaymentsChart(); loadStatementsOverview(); loadOnboardingOverview(); }
  if (name === 'tasks')      { loadMyTasks(); loadUrgentTasks(); loadTaskCharts(); }
  if (name === 'payments')   { loadPaymentIssues(); loadPayStatusChart(); }
  if (name === 'deadlines')  { loadUpcomingAlerts(); loadVatDeadlines(); }
  if (name === 'clients')    { loadMissingStatements(); loadClientsZoneChart(); }
}

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadKPIs() {
  try {
    const kpis = await sb.db.getDashboardKPIs();
    let html = `
      <div class="kpi-card">
        <div class="kpi-label">Clienti Attivi</div>
        <div class="kpi-value">${kpis.total_active_clients ?? 'â€”'}</div>
        <div class="kpi-sub">${kpis.clients_in_bilancio ?? 0} in bilancio</div>
        <div class="kpi-icon">ğŸ‘¥</div>
      </div>
      <div class="kpi-card danger">
        <div class="kpi-label">Estratti Mancanti</div>
        <div class="kpi-value">${kpis.bank_statements_missing ?? 'â€”'}</div>
        <div class="kpi-sub">Mese corrente</div>
        <div class="kpi-icon">ğŸ“„</div>
      </div>
      <div class="kpi-card warn">
        <div class="kpi-label">Abbonamenti âš </div>
        <div class="kpi-value">${kpis.subscriptions_issue ?? 'â€”'}</div>
        <div class="kpi-sub">Da verificare</div>
        <div class="kpi-icon">ğŸ’³</div>
      </div>
      <div class="kpi-card info">
        <div class="kpi-label">VAT in Scadenza</div>
        <div class="kpi-value">${kpis.vat_deadlines_next_30_days ?? 'â€”'}</div>
        <div class="kpi-sub">Prossimi 30 giorni</div>
        <div class="kpi-icon">ğŸ“‹</div>
      </div>`;
    if (isAdmin) {
      html += `
      <div class="kpi-card accent">
        <div class="kpi-label">Incassato Mese</div>
        <div class="kpi-value" id="kpi-revenue">â€”</div>
        <div class="kpi-sub" id="kpi-revenue-sub">Caricamento...</div>
        <div class="kpi-icon">ğŸ’°</div>
      </div>`;
    }
    document.getElementById('kpi-grid').innerHTML = html;
    if (isAdmin) loadRevenue();
  } catch(e) {
    document.getElementById('kpi-grid').innerHTML = `<div class="alert alert-danger">Errore KPIs: ${e.message}</div>`;
  }
}

// â”€â”€ CHARTS helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PALETTE = ['#1a3a5c','#2563a8','#c9a84c','#0891b2','#7c3aed','#059669','#dc2626','#d97706','#6b7280'];

function donut(id, labels, data, colors) {
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  return new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors || PALETTE, borderWidth: 2, borderColor: 'white', hoverOffset: 6 }] },
    options: {
      cutout: '62%',
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${c.label}: ${c.parsed}` } } },
      animation: { animateRotate: true, duration: 600 }
    }
  });
}

function makeLegend(id, labels, values, colors) {
  const el = document.getElementById(id);
  if (!el) return;
  const total = values.reduce((a,b)=>a+b,0);
  el.innerHTML = labels.map((l,i) => `
    <div class="leg-item">
      <div class="leg-dot" style="background:${(colors||PALETTE)[i]}"></div>
      <span style="font-weight:600">${values[i]}</span>
      <span style="color:var(--text-muted)">${l}</span>
      <span style="color:var(--text-muted);font-size:10px">${total?Math.round(values[i]/total*100)+'%':''}</span>
    </div>`).join('');
}

function bar(id, labels, data, colors) {
  const ctx = document.getElementById(id);
  if (!ctx) return;
  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ data, backgroundColor: colors || PALETTE, borderRadius: 6, borderSkipped: false }] },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { font: { size: 11 } } },
        y: { grid: { color: '#f0f0f0' }, ticks: { font: { size: 11 }, stepSize: 1 }, beginAtZero: true }
      },
      animation: { duration: 500 }
    }
  });
}

// â”€â”€ CLIENT TYPE chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadClientTypeChart() {
  try {
    const clients = await sb.db.select('clients', { columns: 'company_type', filter: 'is_active=eq.true' });
    const counts = {};
    (clients||[]).forEach(c => { const t = c.company_type||'N/D'; counts[t] = (counts[t]||0)+1; });
    const labels = Object.keys(counts), vals = Object.values(counts);
    donut('chart-clients-type', labels, vals);
    makeLegend('legend-clients-type', labels, vals);
  } catch(e) { console.error(e); }
}

// â”€â”€ PAYMENTS chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPaymentsChart() {
  try {
    const rows = await sb.db.select('subscription_payments', {
      columns: 'status', filter: `year=eq.${year}&month=eq.${month}`
    });
    const map = { ok: 0, failed: 0, pending: 0, no_tentativo: 0 };
    (rows||[]).forEach(r => { if (map[r.status] !== undefined) map[r.status]++; else map['pending']++; });
    const labels = ['OK', 'Fallito', 'Pending', 'Non tentato'];
    const vals   = [map.ok, map.failed, map.pending, map.no_tentativo];
    const colors = ['#059669','#dc2626','#d97706','#6b7280'];
    donut('chart-payments', labels, vals, colors);
    makeLegend('legend-payments', labels, vals, colors);
  } catch(e) { console.error(e); }
}

// â”€â”€ PAY STATUS chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPayStatusChart() {
  try {
    const rows = await sb.db.select('subscription_payments', {
      columns: 'status', filter: `year=eq.${year}&month=eq.${month}`
    });
    const map = { ok:0, failed:0, pending:0, no_tentativo:0 };
    (rows||[]).forEach(r => { if(map[r.status]!==undefined) map[r.status]++; });
    const labels = ['OK','Fallito','Pending','Non tentato'];
    const vals   = [map.ok, map.failed, map.pending, map.no_tentativo];
    const colors = ['#059669','#dc2626','#d97706','#6b7280'];
    donut('chart-pay-status', labels, vals, colors);
    makeLegend('legend-pay-status', labels, vals, colors);
  } catch(e) {}
}

// â”€â”€ CLIENTS ZONE chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadClientsZoneChart() {
  try {
    const clients = await sb.db.select('clients', { columns: 'business_location', filter: 'is_active=eq.true' });
    const counts = {};
    (clients||[]).forEach(c => { const z = c.business_location||'N/D'; counts[z] = (counts[z]||0)+1; });
    const labels = Object.keys(counts), vals = Object.values(counts);
    donut('chart-clients-zone', labels, vals);
    makeLegend('legend-clients-zone', labels, vals);
  } catch(e) {}
}

// â”€â”€ STATEMENTS overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatementsOverview() {
  const el = document.getElementById('overview-statements');
  try {
    const missing = await sb.db.select('clients_missing_bank_statements');
    const total   = await sb.db.select('clients', { columns: 'id', filter: 'is_active=eq.true' });
    const tot = total?.length || 0;
    const mis = missing?.length || 0;
    const ok  = tot - mis;
    const pct = tot ? Math.round(ok/tot*100) : 0;
    el.innerHTML = `
      <div class="overview-grid" style="margin:0 0 16px">
        <div class="ov-cell"><div class="ov-val" style="color:#059669">${ok}</div><div class="ov-lbl">Completi</div></div>
        <div class="ov-cell"><div class="ov-val" style="color:#dc2626">${mis}</div><div class="ov-lbl">Mancanti</div></div>
        <div class="ov-cell"><div class="ov-val">${pct}%</div><div class="ov-lbl">Copertura</div></div>
      </div>
      <div class="stat-bar">
        <div class="stat-bar-label"><span>Copertura mese</span><span>${pct}%</span></div>
        <div class="stat-bar-track"><div class="stat-bar-fill" style="width:${pct}%;background:${pct>80?'#059669':pct>50?'#d97706':'#dc2626'}"></div></div>
      </div>
      ${mis > 0 ? `<div style="margin-top:14px;font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:6px">Ultimi mancanti:</div>
      ${(missing||[]).slice(0,3).map(r=>`<div style="font-size:13px;padding:5px 0;color:var(--text);border-bottom:1px solid var(--border)">${ui.escapeHtml(r.company_name)}</div>`).join('')}` : ''}`;
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:8px">${e.message}</div>`; }
}

// â”€â”€ ONBOARDING overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOnboardingOverview() {
  const el = document.getElementById('overview-onboarding');
  try {
    const rows = await sb.db.select('onboarding_checklist', { columns: 'completed_steps,total_steps,clients(company_name,is_active)' });
    const active = (rows||[]).filter(r => r.clients?.is_active);
    const done  = active.filter(r => r.completed_steps >= r.total_steps).length;
    const inprog = active.filter(r => r.completed_steps > 0 && r.completed_steps < r.total_steps).length;
    const notst = active.filter(r => !r.completed_steps).length;
    const pct = active.length ? Math.round(done/active.length*100) : 0;
    el.innerHTML = `
      <div class="overview-grid" style="margin:0 0 16px">
        <div class="ov-cell"><div class="ov-val" style="color:#059669">${done}</div><div class="ov-lbl">Completati</div></div>
        <div class="ov-cell"><div class="ov-val" style="color:#d97706">${inprog}</div><div class="ov-lbl">In corso</div></div>
        <div class="ov-cell"><div class="ov-val" style="color:#6b7280">${notst}</div><div class="ov-lbl">Non avviati</div></div>
      </div>
      <div class="stat-bar">
        <div class="stat-bar-label"><span>Completamento</span><span>${pct}%</span></div>
        <div class="stat-bar-track">
          <div class="stat-bar-fill" style="width:${pct}%;background:${pct>80?'#059669':pct>40?'#d97706':'#0891b2'}"></div>
        </div>
      </div>`;
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:8px">${e.message}</div>`; }
}

// â”€â”€ MY TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyTasks() {
  const el = document.getElementById('my-tasks');
  try {
    const profile = sb.getCurrentProfile();
    if (!profile?.id) { el.innerHTML = ''; return; }
    const tasks = await sb.db.select('tasks', {
      columns: 'id,title,priority,due_date,status,clients(company_name)',
      filter: `assigned_to=eq.${profile.id}&status=in.(open,in_progress)`,
      order: 'due_date.asc.nullslast', limit: 6
    });
    if (!tasks?.length) { el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna task assegnata ğŸ‰</div>'; return; }
    const pc = { urgent:'#dc2626', high:'#d97706', normal:'#0369a1', low:'#6b7280' };
    el.innerHTML = tasks.map(t => `
      <a href="/tasks.html" class="dlist-row">
        <div class="dlist-dot" style="background:${pc[t.priority]||'#6b7280'}"></div>
        <div class="dlist-main">
          <div class="dlist-title">${ui.escapeHtml(t.title)}</div>
          ${t.clients ? `<div class="dlist-sub">${ui.escapeHtml(t.clients.company_name)}</div>` : ''}
        </div>
        ${t.due_date ? `<span class="dlist-right ${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>` : ''}
      </a>`).join('');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`; }
}

// â”€â”€ URGENT TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUrgentTasks() {
  const el = document.getElementById('urgent-tasks');
  try {
    const tasks = await sb.db.select('tasks', {
      columns: 'id,title,priority,due_date,assigned_to,clients(company_name),profiles(full_name)',
      filter: `priority=eq.urgent&status=in.(open,in_progress)`,
      order: 'due_date.asc.nullslast', limit: 6
    });
    if (!tasks?.length) { el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna task urgente ğŸ‰</div>'; return; }
    el.innerHTML = tasks.map(t => `
      <a href="/tasks.html" class="dlist-row">
        <div class="dlist-dot" style="background:#dc2626"></div>
        <div class="dlist-main">
          <div class="dlist-title">${ui.escapeHtml(t.title)}</div>
          <div class="dlist-sub">${t.clients ? ui.escapeHtml(t.clients.company_name) : ''}</div>
        </div>
        ${t.due_date ? `<span class="dlist-right ${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>` : ''}
      </a>`).join('');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`; }
}

// â”€â”€ TASK CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTaskCharts() {
  try {
    const tasks = await sb.db.select('tasks', { columns: 'priority,status', filter: 'status=in.(open,in_progress,done)' });
    const byPri = {urgent:0,high:0,normal:0,low:0};
    const bySt  = {open:0,in_progress:0,done:0};
    (tasks||[]).forEach(t => { if(byPri[t.priority]!==undefined) byPri[t.priority]++; if(bySt[t.status]!==undefined) bySt[t.status]++; });
    bar('chart-tasks-priority', ['Urgente','Alta','Normale','Bassa'], Object.values(byPri), ['#dc2626','#d97706','#0369a1','#6b7280']);
    bar('chart-tasks-status', ['Aperta','In corso','Completata'], Object.values(bySt), ['#0369a1','#d97706','#059669']);
  } catch(e) {}
}

// â”€â”€ PAYMENT ISSUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPaymentIssues() {
  const el = document.getElementById('payment-issues');
  try {
    const rows = await sb.db.select('clients_subscription_status', {
      filter: `current_month_status=in.(failed,no_tentativo,pending)&is_active=eq.true`
    });
    if (!rows?.length) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutto OK!</h3><p>Nessun problema di pagamento.</p></div>`; return; }
    el.innerHTML = rows.slice(0,8).map(r => `
      <a href="/payments.html" class="dlist-row">
        <div class="dlist-main">
          <div class="dlist-title">${ui.escapeHtml(r.company_name)}</div>
          <div class="dlist-sub">${r.payment_notes || 'â€”'}</div>
        </div>
        <div>${ui.statusBadge(r.current_month_status)}</div>
      </a>`).join('') + (rows.length>8?`<div style="padding:10px 20px;font-size:12px;color:var(--text-muted)">+ altri ${rows.length-8}</div>`:'');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`; }
}

// â”€â”€ MISSING STATEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMissingStatements() {
  const el = document.getElementById('missing-statements');
  try {
    const rows = await sb.db.select('clients_missing_bank_statements');
    if (!rows?.length) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutti a posto!</h3></div>`; return; }
    el.innerHTML = rows.slice(0,8).map(r => `
      <a href="/statements.html" class="dlist-row">
        <div class="dlist-dot" style="background:#dc2626"></div>
        <div class="dlist-main"><div class="dlist-title">${ui.escapeHtml(r.company_name)}</div></div>
        <div style="font-size:11px;color:var(--text-muted)">${(r.bank_accounts||[]).join(', ')||'â€”'}</div>
      </a>`).join('') + (rows.length>8?`<div style="padding:10px 20px;font-size:12px;color:var(--text-muted)">+ altri ${rows.length-8}</div>`:'');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`; }
}

// â”€â”€ VAT DEADLINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVatDeadlines() {
  const el = document.getElementById('vat-deadlines');
  try {
    const rows = await sb.db.select('vat_register', { columns: 'return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)' });
    const today = new Date(), in30 = new Date(today.getTime()+30*86400000);
    const list = [];
    (rows||[]).forEach(r => {
      [1,2,3,4].forEach(i => {
        const d = r[`return_deadline_${i}`];
        if (d && new Date(d) >= today && new Date(d) <= in30) list.push({ company: r.clients?.company_name, date: d });
      });
    });
    if (!list.length) { el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna scadenza VAT nei prossimi 30 giorni âœ“</div>'; return; }
    list.sort((a,b)=>a.date.localeCompare(b.date));
    el.innerHTML = list.map(r => `
      <a href="/vat.html" class="dlist-row">
        <div class="dlist-main"><div class="dlist-title">${ui.escapeHtml(r.company)}</div></div>
        <span class="dlist-right ${ui.deadlineClass(r.date)}">${ui.formatDate(r.date)}</span>
      </a>`).join('');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`; }
}

// â”€â”€ UPCOMING ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUpcomingAlerts() {
  const el = document.getElementById('upcoming-alerts');
  try {
    const today = new Date(), in14 = new Date(today); in14.setDate(today.getDate()+14);
    const t0 = today.toISOString().split('T')[0], t14 = in14.toISOString().split('T')[0];
    const vatData = await sb.db.select('vat_register', { columns: 'return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)' });
    const tlData  = await sb.db.select('clients', { columns: 'company_name,trade_license_date', filter: `is_active=eq.true&trade_license_date=gte.${t0}&trade_license_date=lte.${t14}` });
    const ctData  = await sb.db.select('clients', { columns: 'company_name,corporate_tax_expiry', filter: `is_active=eq.true&corporate_tax_expiry=gte.${t0}&corporate_tax_expiry=lte.${t14}` });
    const alerts = [];
    (vatData||[]).forEach(vr => [1,2,3,4].forEach(i => { const d=vr[`return_deadline_${i}`]; if(d&&d>=t0&&d<=t14) alerts.push({date:d,label:'â—‡ VAT Return',client:vr.clients?.company_name,color:'#0369a1'}); }));
    (tlData||[]).forEach(c => alerts.push({date:c.trade_license_date,label:'ğŸ“„ Trade License',client:c.company_name,color:'#d97706'}));
    (ctData||[]).forEach(c => alerts.push({date:c.corporate_tax_expiry,label:'â—ˆ Corp. Tax',client:c.company_name,color:'#7c3aed'}));
    alerts.sort((a,b)=>a.date.localeCompare(b.date));
    if (!alerts.length) { el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna scadenza nei prossimi 14 giorni âœ“</div>'; return; }
    el.innerHTML = alerts.map(a => `
      <div class="dlist-row">
        <div class="dlist-dot" style="background:${a.color}"></div>
        <div class="dlist-main">
          <div class="dlist-title" style="color:${a.color}">${a.label}</div>
          <div class="dlist-sub">${ui.escapeHtml(a.client||'')}</div>
        </div>
        <span class="dlist-right ${ui.deadlineClass(a.date)}">${ui.formatDate(a.date)}</span>
      </div>`).join('');
  } catch(e) { el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`; }
}

// â”€â”€ REVENUE (admin only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRevenue() {
  try {
    const payments = await sb.db.select('subscription_payments', { columns: 'amount,status,client_id', filter: `year=eq.${year}&month=eq.${month}&status=eq.ok` });
    const missing = (payments||[]).filter(p=>!p.amount).map(p=>p.client_id);
    let costs = {};
    if (missing.length) { const cl = await sb.db.select('clients',{columns:'id,service_cost',filter:`id=in.(${missing.join(',')})`}); (cl||[]).forEach(c=>costs[c.id]=c.service_cost); }
    const total = (payments||[]).reduce((s,p)=>s+(parseFloat(p.amount)||parseFloat(costs[p.client_id])||0),0);
    const el=document.getElementById('kpi-revenue'), sub=document.getElementById('kpi-revenue-sub');
    if(el){ el.textContent=total>0?ui.formatAED(total):'â€”'; if(sub) sub.textContent=(payments||[]).length+' pagamenti ok'; }
  } catch(e) {}
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadKPIs();
tabLoaded['overview'] = true;
loadTab('overview');
</script>
</body>
</html>
