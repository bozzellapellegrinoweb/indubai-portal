<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€” InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
</head>
<body>
<div class="app-layout">
  <!-- Sidebar injected by app.js -->
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">Dashboard</div>
        <div class="topbar-subtitle" id="date-label"></div>
      </div>
      <button class="btn btn-accent btn-sm" onclick="location.href='/clients.html?action=new'">+ Nuovo Cliente</button>
    </div>

    <div class="page-content">
      <!-- KPIs -->
      <div class="kpi-grid" id="kpi-grid">
        <div class="kpi-card"><div class="spinner"></div></div>
      </div>

      <!-- Two columns -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">

        <!-- Estratti mancanti -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">âš  Estratti Mancanti</div>
              <div class="card-subtitle">Mese corrente</div>
            </div>
          </div>
          <div id="missing-statements" class="loading-overlay"><div class="spinner"></div></div>
        </div>

        <!-- Pagamenti problematici -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">âš¡ Abbonamenti da Verificare</div>
              <div class="card-subtitle">Mese corrente</div>
            </div>
          </div>
          <div id="payment-issues" class="loading-overlay"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- VAT scadenze -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ğŸ“… Scadenze VAT â€” Prossimi 30 giorni</div>
          </div>
          <a href="/vat.html" class="btn btn-ghost btn-sm">Vedi tutti â†’</a>
        </div>
        <div id="vat-deadlines" class="loading-overlay"><div class="spinner"></div></div>
      </div>

      <!-- Scadenze aggregate + alerts -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:0">
        <!-- Task aperte assegnate a me -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">âœ“ Le mie Task</div>
              <div class="card-subtitle">Aperte e in corso</div>
            </div>
            <a href="/tasks.html?filter=mine" class="btn btn-ghost btn-sm">Vedi tutte â†’</a>
          </div>
          <div id="my-tasks" class="loading-overlay"><div class="spinner"></div></div>
        </div>

        <!-- Scadenze prossime aggregate (VAT + CT + Trade License) -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">â° Alert Scadenze</div>
              <div class="card-subtitle">Prossimi 14 giorni</div>
            </div>
          </div>
          <div id="upcoming-alerts" class="loading-overlay"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
const { year, month } = ui.currentYearMonth();

document.getElementById('date-label').textContent =
  `${ui.MONTHS_FULL[month - 1]} ${year}`;

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadKPIs() {
  try {
    const kpis = await sb.db.getDashboardKPIs();
    document.getElementById('kpi-grid').innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">Clienti Attivi</div>
        <div class="kpi-value">${kpis.total_active_clients ?? 'â€”'}</div>
        <div class="kpi-sub">${kpis.clients_in_bilancio ?? 0} in bilancio</div>
        <div class="kpi-icon">ğŸ‘¥</div>
      </div>
      <div class="kpi-card danger">
        <div class="kpi-label">Estratti Mancanti</div>
        <div class="kpi-value">${kpis.bank_statements_missing ?? 'â€”'}</div>
        <div class="kpi-sub">Mese corrente</div>
        <div class="kpi-icon">ğŸ“„</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Abbonamenti âš </div>
        <div class="kpi-value">${kpis.subscriptions_issue ?? 'â€”'}</div>
        <div class="kpi-sub">Da verificare</div>
        <div class="kpi-icon">ğŸ’³</div>
      </div>
      <div class="kpi-card info">
        <div class="kpi-label">VAT in Scadenza</div>
        <div class="kpi-value">${kpis.vat_deadlines_next_30_days ?? 'â€”'}</div>
        <div class="kpi-sub">Prossimi 30 giorni</div>
        <div class="kpi-icon">ğŸ“‹</div>
      </div>
    `;
  } catch(e) {
    document.getElementById('kpi-grid').innerHTML = `<div class="alert alert-danger">Errore caricamento KPIs: ${e.message}</div>`;
  }
}

// â”€â”€ Estratti mancanti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMissingStatements() {
  try {
    const rows = await sb.db.select('clients_missing_bank_statements');
    const el = document.getElementById('missing-statements');
    if (!rows?.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutti a posto!</h3><p>Nessun estratto mancante.</p></div>`;
      return;
    }
    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead><tr><th>Cliente</th><th>Conti</th><th></th></tr></thead>
          <tbody>
            ${rows.slice(0, 8).map(r => `
              <tr>
                <td class="td-company">${ui.escapeHtml(r.company_name)}</td>
                <td>${(r.bank_accounts || []).join(', ') || 'â€”'}</td>

              </tr>`).join('')}
          </tbody>
        </table>
        ${rows.length > 8 ? `<div style="padding:12px 16px;font-size:12px;color:var(--text-muted)">+ altri ${rows.length - 8} clienti</div>` : ''}
      </div>`;
  } catch(e) {
    document.getElementById('missing-statements').innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;
  }
}

// â”€â”€ Pagamenti problematici â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPaymentIssues() {
  try {
    const rows = await sb.db.select('clients_subscription_status', {
      filter: `current_month_status=in.(failed,no_tentativo,pending)&is_active=eq.true`
    });
    const el = document.getElementById('payment-issues');
    if (!rows?.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutto OK!</h3><p>Nessun problema di pagamento.</p></div>`;
      return;
    }
    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead><tr><th>Cliente</th><th>Status</th><th>Note</th></tr></thead>
          <tbody>
            ${rows.slice(0, 8).map(r => `
              <tr>
                <td class="td-company">${ui.escapeHtml(r.company_name)}</td>
                <td>${ui.statusBadge(r.current_month_status)}</td>
                <td style="font-size:12px;color:var(--text-muted)">${ui.escapeHtml(r.payment_notes) || 'â€”'}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        ${rows.length > 8 ? `<div style="padding:12px 16px;font-size:12px;color:var(--text-muted)">+ altri ${rows.length - 8} clienti</div>` : ''}
      </div>`;
  } catch(e) {
    document.getElementById('payment-issues').innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;
  }
}

// â”€â”€ VAT scadenze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVatDeadlines() {
  try {
    const rows = await sb.db.select('vat_register', {
      columns: 'client_id,accounting_partner,return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)',
    });
    const today = new Date();
    const in30 = new Date(today.getTime() + 30 * 86400000);
    const deadlines = [];

    (rows || []).forEach(r => {
      [1, 2, 3, 4].forEach(i => {
        const d = r[`return_deadline_${i}`];
        if (d) {
          const dt = new Date(d);
          if (dt >= today && dt <= in30) {
            deadlines.push({ company: r.clients?.company_name, date: d, partner: r.accounting_partner });
          }
        }
      });
    });

    const el = document.getElementById('vat-deadlines');
    if (!deadlines.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><h3>Nessuna scadenza</h3><p>Nessun VAT return nei prossimi 30 giorni.</p></div>`;
      return;
    }

    deadlines.sort((a, b) => new Date(a.date) - new Date(b.date));

    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead><tr><th>Cliente</th><th>Scadenza VAT Return</th><th>Partner</th></tr></thead>
          <tbody>
            ${deadlines.map(r => `
              <tr>
                <td class="td-company">${ui.escapeHtml(r.company)}</td>
                <td><span class="${ui.deadlineClass(r.date)}">${ui.formatDate(r.date)}</span></td>
                <td>${ui.partnerLabel(r.partner)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  } catch(e) {
    document.getElementById('vat-deadlines').innerHTML = `<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;
  }
}

// Init
loadKPIs();
loadMissingStatements();
loadPaymentIssues();
loadVatDeadlines();

// â”€â”€ My Tasks widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyTasks() {
  const el = document.getElementById('my-tasks');
  try {
    const profile = sb.getCurrentProfile();
    if (!profile?.id) { el.innerHTML = ''; return; }
    const tasks = await sb.db.select('tasks', {
      columns: 'id,title,priority,due_date,category,status,clients(company_name)',
      filter: `assigned_to=eq.${profile.id}&status=in.(open,in_progress)`,
      order: 'due_date.asc.nullslast,created_at.desc',
      limit: 6
    });
    if (!tasks || !tasks.length) {
      el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna task assegnata ğŸ‰</div>';
      return;
    }
    const priColor = { urgent:'#dc2626', high:'#d97706', normal:'#0369a1', low:'#6b7a95' };
    el.innerHTML = `<div style="padding:0 4px">` + tasks.map(t => `
      <a href="/tasks.html" style="display:flex;align-items:center;gap:10px;padding:10px 16px;text-decoration:none;border-bottom:1px solid var(--border);transition:background .1s" onmouseenter="this.style.background='#f5f9ff'" onmouseleave="this.style.background='white'">
        <span style="width:8px;height:8px;border-radius:50%;background:${priColor[t.priority]||'#6b7a95'};flex-shrink:0"></span>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ui.escapeHtml(t.title)}</div>
          ${t.clients ? `<div style="font-size:11px;color:var(--text-muted)">${ui.escapeHtml(t.clients.company_name)}</div>` : ''}
        </div>
        ${t.due_date ? `<span style="font-size:11px;font-weight:600" class="${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>` : ''}
      </a>`).join('') + '</div>';
  } catch(e) {
    el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`;
  }
}

// â”€â”€ Upcoming Alerts widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUpcomingAlerts() {
  const el = document.getElementById('upcoming-alerts');
  try {
    const today = new Date();
    const in14 = new Date(today); in14.setDate(today.getDate() + 14);
    const todayStr = today.toISOString().split('T')[0];
    const in14Str = in14.toISOString().split('T')[0];

    // VAT deadlines in next 14 days
    const vatData = await sb.db.select('vat_register', {
      columns: 'client_id,return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)',
      filter: 'clients.is_active=eq.true'
    });

    const alerts = [];
    (vatData || []).forEach(vr => {
      [vr.return_deadline_1, vr.return_deadline_2, vr.return_deadline_3, vr.return_deadline_4].forEach(d => {
        if (d && d >= todayStr && d <= in14Str) {
          alerts.push({ date: d, label: 'â—‡ VAT Return', client: vr.clients?.company_name, type: 'vat' });
        }
      });
    });

    // Trade license expiry in next 14 days
    const tlData = await sb.db.select('clients', {
      columns: 'company_name,trade_license_date',
      filter: `is_active=eq.true&trade_license_date=gte.${todayStr}&trade_license_date=lte.${in14Str}`
    });
    (tlData || []).forEach(c => {
      alerts.push({ date: c.trade_license_date, label: 'ğŸ“„ Trade License', client: c.company_name, type: 'license' });
    });

    // Corporate tax expiry in next 14 days
    const ctData = await sb.db.select('clients', {
      columns: 'company_name,corporate_tax_expiry',
      filter: `is_active=eq.true&corporate_tax_expiry=gte.${todayStr}&corporate_tax_expiry=lte.${in14Str}`
    });
    (ctData || []).forEach(c => {
      alerts.push({ date: c.corporate_tax_expiry, label: 'â—ˆ Corp. Tax', client: c.company_name, type: 'ct' });
    });

    alerts.sort((a,b) => a.date.localeCompare(b.date));

    if (!alerts.length) {
      el.innerHTML = '<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna scadenza nei prossimi 14 giorni âœ“</div>';
      return;
    }

    const typeColor = { vat:'#0369a1', license:'#d97706', ct:'#7c3aed' };
    el.innerHTML = alerts.map(a => `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 20px;border-bottom:1px solid var(--border)">
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:700;color:${typeColor[a.type]||'#1a3a5c'}">${a.label}</div>
          <div style="font-size:12px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ui.escapeHtml(a.client||'')}</div>
        </div>
        <span style="font-size:12px;font-weight:700;flex-shrink:0" class="${ui.deadlineClass(a.date)}">${ui.formatDate(a.date)}</span>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<div class="alert alert-danger" style="margin:12px">${e.message}</div>`;
  }
}

loadMyTasks();
loadUpcomingAlerts();
loadRevenue();

async function loadRevenue() {
  try {
    const { year, month } = ui.currentYearMonth();
    // Sum all successful payments this month
    const payments = await sb.db.select('subscription_payments', {
      columns: 'amount,status',
      filter: `year=eq.${year}&month=eq.${month}&status=eq.ok`
    });
    // Also get clients with service_cost as fallback
    const okPayments = payments || [];
    const total = okPayments.reduce((s, p) => s + (parseFloat(p.amount)||0), 0);
    
    // Also count from service_cost for clients with ok status
    const sub = await sb.db.select('subscription_payments', {
      columns: 'amount,client_id,status,clients(service_cost)',
      filter: `year=eq.${year}&month=eq.${month}&status=eq.ok`
    });
    const totalFromSub = (sub||[]).reduce((s,p) => {
      const amt = parseFloat(p.amount) || parseFloat(p.clients?.service_cost) || 0;
      return s + amt;
    }, 0);
    
    const el = document.getElementById('kpi-revenue');
    const sub2 = document.getElementById('kpi-revenue-sub');
    if (el) {
      el.textContent = totalFromSub > 0 ? 'AED ' + totalFromSub.toLocaleString('it-IT') : 'â€”';
      if (sub2) sub2.textContent = `${okPayments.length} pagamenti ok`;
    }
  } catch(e) { console.error('Revenue:', e); }
}
</script>
</body>
</html>
