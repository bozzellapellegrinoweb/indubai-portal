<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€” InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .kpi-strip { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:14px; margin-bottom:24px; }
    .kpi-card { background:white; border:1.5px solid var(--border); border-radius:14px; padding:18px 20px; position:relative; overflow:hidden; transition:box-shadow .15s,transform .15s; cursor:default; }
    .kpi-card:hover { box-shadow:0 6px 24px rgba(26,58,92,.1); transform:translateY(-2px); }
    .kpi-card.c-accent { background:linear-gradient(135deg,#1a3a5c,#2563a8); border-color:transparent; }
    .kpi-card.c-warn   { background:linear-gradient(135deg,#92400e,#d97706); border-color:transparent; }
    .kpi-card.c-danger { background:linear-gradient(135deg,#7f1d1d,#dc2626); border-color:transparent; }
    .kpi-card.c-teal   { background:linear-gradient(135deg,#164e63,#0891b2); border-color:transparent; }
    .kpi-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-bottom:6px; }
    .kpi-value { font-size:30px; font-weight:900; color:var(--text); line-height:1; margin-bottom:4px; }
    .kpi-sub   { font-size:11px; color:var(--text-muted); }
    .kpi-icon  { position:absolute; right:14px; top:14px; font-size:22px; opacity:.18; }
    .kpi-card[class*="c-"] .kpi-label { color:rgba(255,255,255,.65); }
    .kpi-card[class*="c-"] .kpi-value { color:white; }
    .kpi-card[class*="c-"] .kpi-sub   { color:rgba(255,255,255,.55); }
    .kpi-card[class*="c-"] .kpi-icon  { opacity:.25; }

    .dash-tabs { display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap; }
    .dtab { padding:7px 16px; border-radius:20px; font-size:13px; font-weight:600; cursor:pointer; border:1.5px solid var(--border); background:white; color:var(--text-muted); transition:all .15s; }
    .dtab:hover { border-color:var(--primary); color:var(--primary); }
    .dtab.on { background:var(--primary); border-color:var(--primary); color:white; }
    .dpanel { display:none; }
    .dpanel.on { display:block; }

    .chl { display:flex; align-items:center; justify-content:space-between; padding:14px 20px 12px; border-bottom:1px solid var(--border); }
    .chl-t { font-size:14px; font-weight:700; color:var(--text); }
    .chl-s { font-size:11px; color:var(--text-muted); margin-top:2px; }
    .go-btn { display:inline-flex; align-items:center; gap:5px; padding:6px 14px; border-radius:8px; font-size:12px; font-weight:700; background:#e8f0fe; color:var(--primary); text-decoration:none; border:none; cursor:pointer; transition:all .15s; white-space:nowrap; flex-shrink:0; }
    .go-btn:hover { background:var(--primary); color:white; }

    .d2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }

    .drow { display:flex; align-items:center; gap:12px; padding:10px 20px; border-bottom:1px solid var(--border); transition:background .1s; cursor:pointer; text-decoration:none; }
    .drow:last-child { border-bottom:none; }
    .drow:hover { background:#f5f9ff; }
    .drow-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .drow-main { flex:1; min-width:0; }
    .drow-title { font-size:13px; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .drow-sub   { font-size:11px; color:var(--text-muted); }
    .drow-right { font-size:11px; font-weight:700; flex-shrink:0; }

    .stat-bar { margin:10px 0; }
    .stat-bar-hd { display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px; font-weight:600; }
    .stat-track { height:7px; background:var(--border); border-radius:4px; overflow:hidden; }
    .stat-fill  { height:100%; border-radius:4px; transition:width .7s ease; }

    .num3 { display:grid; grid-template-columns:repeat(3,1fr); gap:1px; background:var(--border); border-radius:10px; overflow:hidden; margin-bottom:16px; }
    .num3-cell { background:white; padding:14px; text-align:center; }
    .num3-val { font-size:22px; font-weight:900; color:var(--text); }
    .num3-lbl { font-size:11px; color:var(--text-muted); margin-top:2px; }

    .chart-wrap { padding:16px 20px 20px; }
    .chart-wrap canvas { max-height:210px; }
    .clegend { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .cleg { display:flex; align-items:center; gap:6px; font-size:12px; }
    .cleg-dot { width:10px; height:10px; border-radius:3px; flex-shrink:0; }

    @media(max-width:900px) { .d2 { grid-template-columns:1fr; } }
    @media(max-width:600px) { .kpi-strip { grid-template-columns:repeat(2,1fr); gap:10px; } }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div>
        <div class="topbar-title">Dashboard</div>
        <div class="topbar-subtitle" id="date-label"></div>
      </div>
      <a href="/clients.html?action=new" class="btn btn-accent btn-sm">+ Nuovo Cliente</a>
    </div>

    <div class="page-content">
      <div class="kpi-strip" id="kpi-grid"><div class="kpi-card"><div class="spinner"></div></div></div>

      <div class="dash-tabs">
        <div class="dtab on"  data-tab="overview">â—ˆ Panoramica</div>
        <div class="dtab" data-tab="tasks">âœ“ Task</div>
        <div class="dtab" data-tab="payments">ğŸ’³ Pagamenti</div>
        <div class="dtab" data-tab="deadlines">â° Scadenze</div>
        <div class="dtab" data-tab="clients">ğŸ‘¥ Clienti</div>
      </div>

      <!-- PANORAMICA -->
      <div class="dpanel on" id="panel-overview">
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ‘¥ Clienti per Tipo</div><div class="chl-s">Distribuzione attivi</div></div><a href="/clients.html" class="go-btn">Clienti â†’</a></div>
            <div class="chart-wrap"><canvas id="ch-ctype"></canvas><div class="clegend" id="lg-ctype"></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ’³ Abbonamenti Mese</div><div class="chl-s" id="pay-month-lbl"></div></div><a href="/payments.html" class="go-btn">Pagamenti â†’</a></div>
            <div class="chart-wrap"><canvas id="ch-pay"></canvas><div class="clegend" id="lg-pay"></div></div>
          </div>
        </div>
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ“‹ Estratti Conto</div><div class="chl-s">Copertura mese corrente</div></div><a href="/statements.html" class="go-btn">Estratti â†’</a></div>
            <div id="ov-statements" style="padding:16px 20px"><div class="spinner"></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">âœ¦ Onboarding</div><div class="chl-s">Stato completamento</div></div><a href="/onboarding.html" class="go-btn">Onboarding â†’</a></div>
            <div id="ov-onboarding" style="padding:16px 20px"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- TASK -->
      <div class="dpanel" id="panel-tasks">
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">âœ“ Le mie Task</div><div class="chl-s">Aperte e in corso</div></div><a href="/tasks.html" class="go-btn">Vedi tutte â†’</a></div>
            <div id="my-tasks"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ”¥ Task Urgenti</div><div class="chl-s">PrioritÃ  urgente aperte</div></div><a href="/tasks.html" class="go-btn">Gestisci â†’</a></div>
            <div id="urgent-tasks"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
        </div>
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ“Š Per PrioritÃ </div></div></div>
            <div class="chart-wrap"><canvas id="ch-tpri"></canvas></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ“Š Per Stato</div></div></div>
            <div class="chart-wrap"><canvas id="ch-tstat"></canvas></div>
          </div>
        </div>
      </div>

      <!-- PAGAMENTI -->
      <div class="dpanel" id="panel-payments">
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">âš¡ Da Verificare</div><div class="chl-s">Problemi mese corrente</div></div><a href="/payments.html" class="go-btn">Pagamenti â†’</a></div>
            <div id="pay-issues"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ“Š Status Mese</div></div><a href="/payments.html" class="go-btn">Gestisci â†’</a></div>
            <div class="chart-wrap"><canvas id="ch-pstat"></canvas><div class="clegend" id="lg-pstat"></div></div>
          </div>
        </div>
      </div>

      <!-- SCADENZE -->
      <div class="dpanel" id="panel-deadlines">
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">â° Alert Prossimi 14gg</div><div class="chl-s">VAT, Trade License, Corp Tax</div></div></div>
            <div id="alerts14"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ“… VAT Return â€” 30gg</div></div><a href="/vat.html" class="go-btn">VAT Register â†’</a></div>
            <div id="vat30"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>

      <!-- CLIENTI -->
      <div class="dpanel" id="panel-clients">
        <div class="d2">
          <div class="card">
            <div class="chl"><div><div class="chl-t">âš  Estratti Mancanti</div><div class="chl-s">Mese corrente</div></div><a href="/statements.html" class="go-btn">Estratti â†’</a></div>
            <div id="missing-st"><div style="padding:30px;text-align:center"><div class="spinner"></div></div></div>
          </div>
          <div class="card">
            <div class="chl"><div><div class="chl-t">ğŸ‘¥ Per Zona Aziendale</div></div><a href="/clients.html" class="go-btn">Clienti â†’</a></div>
            <div class="chart-wrap"><canvas id="ch-czone"></canvas><div class="clegend" id="lg-czone"></div></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
// â”€â”€ setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { year, month } = ui.currentYearMonth();
document.getElementById('date-label').textContent = `${ui.MONTHS_FULL[month-1]} ${year}`;
document.getElementById('pay-month-lbl').textContent = `${ui.MONTHS[month-1]} ${year}`;
const adminUser = sb.getCurrentProfile()?.role === 'admin';

// â”€â”€ tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loaded = { overview: false };
document.querySelectorAll('.dtab').forEach(tab => {
  tab.addEventListener('click', () => {
    const name = tab.dataset.tab;
    document.querySelectorAll('.dtab').forEach(t => t.classList.toggle('on', t===tab));
    document.querySelectorAll('.dpanel').forEach(p => p.classList.remove('on'));
    document.getElementById('panel-'+name).classList.add('on');
    if (!loaded[name]) { loaded[name]=true; loadTab(name); }
  });
});

function loadTab(t) {
  if (t==='overview')  { loadCtypeChart(); loadPayChart(); loadStatementsOv(); loadOnboardingOv(); }
  if (t==='tasks')     { loadMyTasks(); loadUrgentTasks(); loadTaskCharts(); }
  if (t==='payments')  { loadPayIssues(); loadPayStatChart(); }
  if (t==='deadlines') { loadAlerts14(); loadVat30(); }
  if (t==='clients')   { loadMissingSt(); loadCzoneChart(); }
}

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadKPIs() {
  const el = document.getElementById('kpi-grid');
  try {
    const kpis = await sb.db.getDashboardKPIs();
    let h = `
      <div class="kpi-card"><div class="kpi-label">Clienti Attivi</div><div class="kpi-value">${kpis.total_active_clients??'â€”'}</div><div class="kpi-sub">${kpis.clients_in_bilancio??0} in bilancio</div><div class="kpi-icon">ğŸ‘¥</div></div>
      <div class="kpi-card c-danger"><div class="kpi-label">Estratti Mancanti</div><div class="kpi-value">${kpis.bank_statements_missing??'â€”'}</div><div class="kpi-sub">Mese corrente</div><div class="kpi-icon">ğŸ“„</div></div>
      <div class="kpi-card c-warn"><div class="kpi-label">Abbonamenti âš </div><div class="kpi-value">${kpis.subscriptions_issue??'â€”'}</div><div class="kpi-sub">Da verificare</div><div class="kpi-icon">ğŸ’³</div></div>
      <div class="kpi-card c-teal"><div class="kpi-label">VAT in Scadenza</div><div class="kpi-value">${kpis.vat_deadlines_next_30_days??'â€”'}</div><div class="kpi-sub">Prossimi 30 giorni</div><div class="kpi-icon">ğŸ“‹</div></div>`;
    if (adminUser) h += `<div class="kpi-card c-accent"><div class="kpi-label">Incassato Mese</div><div class="kpi-value" id="kpi-rev">â€”</div><div class="kpi-sub" id="kpi-rev-sub">Caricamento...</div><div class="kpi-icon">ğŸ’°</div></div>`;
    el.innerHTML = h;
    if (adminUser) loadRevenue();
  } catch(e) {
    el.innerHTML = `<div class="alert alert-danger">Errore KPIs: ${e.message}</div>`;
  }
}

// â”€â”€ chart helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const P = ['#1a3a5c','#2563a8','#c9a84c','#0891b2','#7c3aed','#059669','#dc2626','#d97706','#6b7280'];
function donut(id, labels, vals, colors) {
  const c = document.getElementById(id); if(!c) return;
  new Chart(c, { type:'doughnut', data:{ labels, datasets:[{ data:vals, backgroundColor:colors||P, borderWidth:2, borderColor:'white', hoverOffset:6 }] }, options:{ cutout:'62%', plugins:{ legend:{display:false} }, animation:{duration:600} } });
}
function legend(id, labels, vals, colors) {
  const el=document.getElementById(id); if(!el) return;
  const tot=vals.reduce((a,b)=>a+b,0);
  el.innerHTML=labels.map((l,i)=>`<div class="cleg"><div class="cleg-dot" style="background:${(colors||P)[i]}"></div><b>${vals[i]}</b><span style="color:var(--text-muted)">${l}</span><span style="color:var(--text-muted);font-size:10px">${tot?Math.round(vals[i]/tot*100)+'%':''}</span></div>`).join('');
}
function barChart(id, labels, vals, colors) {
  const c=document.getElementById(id); if(!c) return;
  new Chart(c, { type:'bar', data:{ labels, datasets:[{ data:vals, backgroundColor:colors||P, borderRadius:6, borderSkipped:false }] }, options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false},ticks:{font:{size:11}}}, y:{grid:{color:'#f0f0f0'},ticks:{font:{size:11},stepSize:1},beginAtZero:true} }, animation:{duration:500} } });
}

// â”€â”€ OVERVIEW charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCtypeChart() {
  const wrap = document.querySelector('#panel-overview .d2:first-child .card:first-child .chart-wrap');
  try {
    const rows = await sb.db.select('clients',{columns:'company_type',filter:'is_active=eq.true'});
    const cnt={}; (rows||[]).forEach(r=>{const t=r.company_type||'N/D';cnt[t]=(cnt[t]||0)+1;});
    const l=Object.keys(cnt),v=Object.values(cnt);
    if(!l.length){if(wrap)wrap.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px">Nessun dato</div>';return;}
    donut('ch-ctype',l,v); legend('lg-ctype',l,v);
  } catch(e){if(wrap)wrap.innerHTML=`<div class="alert alert-danger" style="margin:8px;font-size:12px">${e.message}</div>`;}
}
async function loadPayChart() {
  const wrap = document.querySelector('#panel-overview .d2:first-child .card:last-child .chart-wrap');
  try {
    const rows = await sb.db.select('subscription_payments',{columns:'status',filter:`year=eq.${year}&month=eq.${month}`});
    const m={ok:0,failed:0,pending:0,no_tentativo:0};
    (rows||[]).forEach(r=>{if(m[r.status]!==undefined)m[r.status]++;else m.pending++;});
    const l=['OK','Fallito','Pending','Non tentato'],v=[m.ok,m.failed,m.pending,m.no_tentativo],colors=['#059669','#dc2626','#d97706','#6b7280'];
    donut('ch-pay',l,v,colors); legend('lg-pay',l,v,colors);
  } catch(e){if(wrap)wrap.innerHTML=`<div class="alert alert-danger" style="margin:8px;font-size:12px">${e.message}</div>`;}
}
async function loadStatementsOv() {
  const el=document.getElementById('ov-statements');
  try {
    const all   = await sb.db.select('clients',{columns:'id',filter:'is_active=eq.true'});
    const stmts = await sb.db.select('bank_statements',{columns:'client_id',filter:`year=eq.${year}&month=eq.${month}`});
    const tot=all?.length||0, done=stmts?.length||0, miss=tot-done, pct=tot?Math.round(done/tot*100):0;
    const col=pct>80?'#059669':pct>50?'#d97706':'#dc2626';
    el.innerHTML=`<div class="num3"><div class="num3-cell"><div class="num3-val" style="color:#059669">${done}</div><div class="num3-lbl">Presenti</div></div><div class="num3-cell"><div class="num3-val" style="color:#dc2626">${miss}</div><div class="num3-lbl">Mancanti</div></div><div class="num3-cell"><div class="num3-val">${pct}%</div><div class="num3-lbl">Copertura</div></div></div><div class="stat-bar"><div class="stat-bar-hd"><span>Copertura mese</span><span>${pct}%</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%;background:${col}"></div></div></div>`;
  } catch(e){ el.innerHTML=`<div class="alert alert-danger" style="margin:8px">${e.message}</div>`; }
}
async function loadOnboardingOv() {
  const el=document.getElementById('ov-onboarding');
  try {
    const rows = await sb.db.select('onboarding_checklist',{columns:'completed_steps,total_steps,client_id,clients(is_active,company_name)'});
    const active=(rows||[]).filter(r=>r.clients?.is_active);
    const done=active.filter(r=>r.completed_steps>=r.total_steps&&r.total_steps>0).length;
    const inp=active.filter(r=>r.completed_steps>0&&r.completed_steps<r.total_steps).length;
    const nst=active.filter(r=>!r.completed_steps).length;
    const tot=active.length, pct=tot?Math.round(done/tot*100):0;
    const col=pct>80?'#059669':pct>40?'#d97706':'#0891b2';
    el.innerHTML=`<div class="num3"><div class="num3-cell"><div class="num3-val" style="color:#059669">${done}</div><div class="num3-lbl">Completati</div></div><div class="num3-cell"><div class="num3-val" style="color:#d97706">${inp}</div><div class="num3-lbl">In corso</div></div><div class="num3-cell"><div class="num3-val" style="color:#6b7280">${nst}</div><div class="num3-lbl">Non avviati</div></div></div><div class="stat-bar"><div class="stat-bar-hd"><span>Completamento</span><span>${pct}%</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%;background:${col}"></div></div></div>`;
  } catch(e){ el.innerHTML=`<div class="alert alert-danger" style="margin:8px">${e.message}</div>`; }
}

// â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyTasks() {
  const el=document.getElementById('my-tasks');
  try {
    const p=sb.getCurrentProfile(); if(!p?.id){el.innerHTML='';return;}
    const tasks=await sb.db.select('tasks',{columns:'id,title,priority,due_date,clients(company_name)',filter:`assigned_to=eq.${p.id}&status=in.(open,in_progress)`,order:'due_date.asc.nullslast',limit:6});
    if(!tasks?.length){el.innerHTML='<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna task assegnata ğŸ‰</div>';return;}
    const pc={urgent:'#dc2626',high:'#d97706',normal:'#0369a1',low:'#6b7280'};
    el.innerHTML=tasks.map(t=>`<a href="/tasks.html" class="drow"><div class="drow-dot" style="background:${pc[t.priority]||'#6b7280'}"></div><div class="drow-main"><div class="drow-title">${ui.escapeHtml(t.title)}</div>${t.clients?`<div class="drow-sub">${ui.escapeHtml(t.clients.company_name)}</div>`:''}</div>${t.due_date?`<span class="drow-right ${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>`:''}</a>`).join('');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:12px">${e.message}</div>`;}
}
async function loadUrgentTasks() {
  const el=document.getElementById('urgent-tasks');
  try {
    const tasks=await sb.db.select('tasks',{columns:'id,title,due_date,clients(company_name)',filter:`priority=eq.urgent&status=in.(open,in_progress)`,order:'due_date.asc.nullslast',limit:6});
    if(!tasks?.length){el.innerHTML='<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna task urgente ğŸ‰</div>';return;}
    el.innerHTML=tasks.map(t=>`<a href="/tasks.html" class="drow"><div class="drow-dot" style="background:#dc2626"></div><div class="drow-main"><div class="drow-title">${ui.escapeHtml(t.title)}</div>${t.clients?`<div class="drow-sub">${ui.escapeHtml(t.clients.company_name)}</div>`:''}</div>${t.due_date?`<span class="drow-right ${ui.deadlineClass(t.due_date)}">${ui.formatDate(t.due_date)}</span>`:''}</a>`).join('');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:12px">${e.message}</div>`;}
}
async function loadTaskCharts() {
  try {
    const tasks=await sb.db.select('tasks',{columns:'priority,status',filter:'status=in.(open,in_progress,done)'});
    const bp={urgent:0,high:0,normal:0,low:0},bs={open:0,in_progress:0,done:0};
    (tasks||[]).forEach(t=>{if(bp[t.priority]!==undefined)bp[t.priority]++;if(bs[t.status]!==undefined)bs[t.status]++;});
    barChart('ch-tpri',['Urgente','Alta','Normale','Bassa'],Object.values(bp),['#dc2626','#d97706','#0369a1','#6b7280']);
    barChart('ch-tstat',['Aperta','In corso','Completata'],Object.values(bs),['#0369a1','#d97706','#059669']);
  } catch(e){ document.getElementById('ch-tpri')?.closest('.chart-wrap')?.insertAdjacentHTML('beforeend',`<div style="font-size:12px;color:var(--danger)">${e.message}</div>`); }
}

// â”€â”€ PAYMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPayIssues() {
  const el=document.getElementById('pay-issues');
  try {
    const rows=await sb.db.select('subscription_payments',{columns:'client_id,status,payment_notes,clients(company_name)',filter:`year=eq.${year}&month=eq.${month}&status=in.(failed,no_tentativo,pending)`});
    if(!rows?.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutto OK!</h3><p>Nessun problema.</p></div>`;return;}
    el.innerHTML=rows.slice(0,8).map(r=>`<a href="/payments.html" class="drow"><div class="drow-main"><div class="drow-title">${ui.escapeHtml(r.clients?.company_name||r.client_id)}</div><div class="drow-sub">${r.payment_notes||'â€”'}</div></div><div>${ui.statusBadge(r.status)}</div></a>`).join('') + (rows.length>8?`<div style="padding:10px 20px;font-size:12px;color:var(--text-muted)">+ altri ${rows.length-8}</div>`:'');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;}
}
async function loadPayStatChart() {
  try {
    const rows=await sb.db.select('subscription_payments',{columns:'status',filter:`year=eq.${year}&month=eq.${month}`});
    const m={ok:0,failed:0,pending:0,no_tentativo:0};
    (rows||[]).forEach(r=>{if(m[r.status]!==undefined)m[r.status]++;});
    const l=['OK','Fallito','Pending','Non tentato'],v=[m.ok,m.failed,m.pending,m.no_tentativo],c=['#059669','#dc2626','#d97706','#6b7280'];
    donut('ch-pstat',l,v,c); legend('lg-pstat',l,v,c);
  } catch(e){ document.getElementById('ch-pstat')?.closest('.chart-wrap')?.insertAdjacentHTML('beforeend',`<div class="alert alert-danger" style="margin:8px;font-size:12px">${e.message}</div>`); }
}

// â”€â”€ DEADLINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAlerts14() {
  const el=document.getElementById('alerts14');
  try {
    const t0=new Date().toISOString().split('T')[0], t14=new Date(Date.now()+14*86400000).toISOString().split('T')[0];
    const vat=await sb.db.select('vat_register',{columns:'return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)'});
    const tl =await sb.db.select('clients',{columns:'company_name,trade_license_date',filter:`is_active=eq.true&trade_license_date=gte.${t0}&trade_license_date=lte.${t14}`});
    const ct =await sb.db.select('clients',{columns:'company_name,corporate_tax_expiry',filter:`is_active=eq.true&corporate_tax_expiry=gte.${t0}&corporate_tax_expiry=lte.${t14}`});
    const alerts=[];
    (vat||[]).forEach(r=>[1,2,3,4].forEach(i=>{const d=r[`return_deadline_${i}`];if(d&&d>=t0&&d<=t14)alerts.push({date:d,label:'â—‡ VAT Return',client:r.clients?.company_name,color:'#0369a1'});}));
    (tl||[]).forEach(c=>alerts.push({date:c.trade_license_date,label:'ğŸ“„ Trade License',client:c.company_name,color:'#d97706'}));
    (ct||[]).forEach(c=>alerts.push({date:c.corporate_tax_expiry,label:'â—ˆ Corp. Tax',client:c.company_name,color:'#7c3aed'}));
    alerts.sort((a,b)=>a.date.localeCompare(b.date));
    if(!alerts.length){el.innerHTML='<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna scadenza nei prossimi 14 giorni âœ“</div>';return;}
    el.innerHTML=alerts.map(a=>`<div class="drow"><div class="drow-dot" style="background:${a.color}"></div><div class="drow-main"><div class="drow-title" style="color:${a.color}">${a.label}</div><div class="drow-sub">${ui.escapeHtml(a.client||'')}</div></div><span class="drow-right ${ui.deadlineClass(a.date)}">${ui.formatDate(a.date)}</span></div>`).join('');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:12px">${e.message}</div>`;}
}
async function loadVat30() {
  const el=document.getElementById('vat30');
  try {
    const t0=new Date().toISOString().split('T')[0], t30=new Date(Date.now()+30*86400000).toISOString().split('T')[0];
    const rows=await sb.db.select('vat_register',{columns:'return_deadline_1,return_deadline_2,return_deadline_3,return_deadline_4,clients(company_name)'});
    const list=[];
    (rows||[]).forEach(r=>[1,2,3,4].forEach(i=>{const d=r[`return_deadline_${i}`];if(d&&d>=t0&&d<=t30)list.push({date:d,company:r.clients?.company_name});}));
    list.sort((a,b)=>a.date.localeCompare(b.date));
    if(!list.length){el.innerHTML='<div style="padding:16px 20px;font-size:13px;color:var(--text-muted)">Nessuna scadenza VAT nei prossimi 30 giorni âœ“</div>';return;}
    el.innerHTML=list.map(r=>`<a href="/vat.html" class="drow"><div class="drow-main"><div class="drow-title">${ui.escapeHtml(r.company)}</div></div><span class="drow-right ${ui.deadlineClass(r.date)}">${ui.formatDate(r.date)}</span></a>`).join('');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;}
}

// â”€â”€ CLIENTS tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMissingSt() {
  const el=document.getElementById('missing-st');
  try {
    const all=await sb.db.select('clients',{columns:'id,company_name',filter:'is_active=eq.true'});
    const done=await sb.db.select('bank_statements',{columns:'client_id',filter:`year=eq.${year}&month=eq.${month}`});
    const doneIds=new Set((done||[]).map(s=>s.client_id));
    const missing=(all||[]).filter(c=>!doneIds.has(c.id));
    if(!missing.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Tutti a posto!</h3></div>`;return;}
    el.innerHTML=missing.slice(0,8).map(c=>`<a href="/statements.html" class="drow"><div class="drow-dot" style="background:#dc2626"></div><div class="drow-main"><div class="drow-title">${ui.escapeHtml(c.company_name)}</div></div></a>`).join('') + (missing.length>8?`<div style="padding:10px 20px;font-size:12px;color:var(--text-muted)">+ altri ${missing.length-8}</div>`:'');
  } catch(e){el.innerHTML=`<div class="alert alert-danger" style="margin:16px">${e.message}</div>`;}
}
async function loadCzoneChart() {
  try {
    const rows=await sb.db.select('clients',{columns:'business_location',filter:'is_active=eq.true'});
    const cnt={}; (rows||[]).forEach(r=>{const z=r.business_location||'N/D';cnt[z]=(cnt[z]||0)+1;});
    const l=Object.keys(cnt),v=Object.values(cnt);
    donut('ch-czone',l,v); legend('lg-czone',l,v);
  } catch(e){ document.getElementById('ch-czone')?.closest('.chart-wrap')?.insertAdjacentHTML('beforeend',`<div class="alert alert-danger" style="margin:8px;font-size:12px">${e.message}</div>`); }
}

// â”€â”€ REVENUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRevenue() {
  try {
    const payments=await sb.db.select('subscription_payments',{columns:'amount,client_id',filter:`year=eq.${year}&month=eq.${month}&status=eq.ok`});
    const missing=(payments||[]).filter(p=>!p.amount).map(p=>p.client_id);
    let costs={};
    if(missing.length){const cl=await sb.db.select('clients',{columns:'id,service_cost',filter:`id=in.(${missing.join(',')})`});(cl||[]).forEach(c=>costs[c.id]=c.service_cost);}
    const total=(payments||[]).reduce((s,p)=>s+(parseFloat(p.amount)||parseFloat(costs[p.client_id])||0),0);
    const el=document.getElementById('kpi-rev'),sub=document.getElementById('kpi-rev-sub');
    if(el){el.textContent=total>0?ui.formatAED(total):'â€”';if(sub)sub.textContent=(payments||[]).length+' pagamenti ok';}
  } catch(e){}
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadKPIs();
loadTab('overview');
</script>
</body>
</html>
