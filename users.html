<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utenti ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .user-card { background:white; border:1.5px solid var(--border); border-radius:12px; padding:18px 24px; display:flex; align-items:center; gap:16px; margin-bottom:10px; transition:all .15s; }
    .user-card:hover { border-color:var(--primary); box-shadow:0 2px 8px rgba(26,58,92,.08); }
    .u-av { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:800; color:white; flex-shrink:0; }
    .role-badge { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
    .rb-admin { background:#1a3a5c; color:white; }
    .rb-mini_admin { background:#c9a84c; color:#1a3a5c; }
    .rb-senior { background:#dbeafe; color:#1d4ed8; }
    .rb-junior { background:#f3f4f6; color:#6b7280; }
    .rb-staff { background:#f3f4f6; color:#9ca3af; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-title">Gestione Utenti</div>
      <div class="topbar-actions">
        <button class="btn btn-accent" onclick="openNew()">+ Nuovo Utente</button>
      </div>
    </div>
    <div class="page-content">
      <div style="max-width:680px">
        <div class="card" style="margin-bottom:20px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:14px;font-weight:700">üîê Cambia la mia password</div>
            <div style="font-size:12px;color:var(--text-muted)">Aggiorna la password di accesso</div>
          </div>
          <button class="btn btn-ghost" onclick="openChangePwd()">Cambia Password</button>
        </div>
        <div id="users-list"><div class="loading-overlay"><div class="spinner"></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- New/Edit User Modal -->
<div class="modal-overlay" id="modal-user" style="display:none">
  <div class="modal" style="max-width:460px">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Nuovo Utente</div>
      <button class="btn btn-ghost btn-sm" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nome Completo *</label>
        <input type="text" class="form-control" id="u-name" placeholder="Es. Mario Rossi">
      </div>
      <div class="form-group" id="email-group">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" id="u-email" placeholder="mario@indubai.it">
      </div>
      <div class="form-group" id="pwd-group">
        <label class="form-label">Password *</label>
        <input type="password" class="form-control" id="u-pwd" placeholder="Min 8 caratteri">
      </div>
      <div class="form-group">
        <label class="form-label">Ruolo</label>
        <select class="form-control" id="u-role">
          <option value="junior">Contabilit√† Junior</option>
          <option value="senior">Contabilit√† Senior</option>
          <option value="mini_admin">Mini Admin</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group" id="newpwd-group" style="display:none">
        <label class="form-label">Nuova Password (lascia vuoto per non cambiare)</label>
        <input type="password" class="form-control" id="u-newpwd" placeholder="Nuova password...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Annulla</button>
      <button class="btn btn-accent" id="btn-save" onclick="saveUser()">Crea Utente</button>
    </div>
  </div>
</div>

<!-- Change password modal -->
<div class="modal-overlay" id="modal-pwd" style="display:none">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <div class="modal-title">üîê Cambia Password</div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-pwd').style.display='none'">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nuova Password *</label>
        <input type="password" class="form-control" id="new-pwd" placeholder="Min 6 caratteri">
      </div>
      <div class="form-group">
        <label class="form-label">Conferma *</label>
        <input type="password" class="form-control" id="confirm-pwd">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-pwd').style.display='none'">Annulla</button>
      <button class="btn btn-accent" id="btn-pwd" onclick="changePassword()">Salva Password</button>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let editingId = null;
const ROLE_LABELS = {admin:'Admin', mini_admin:'Mini Admin', senior:'Contabilit√† Senior', junior:'Contabilit√† Junior', staff:'Staff'};
const ROLE_COLORS = {admin:'#1a3a5c', mini_admin:'#c9a84c', senior:'#2563a8', junior:'#6b7280', staff:'#9ca3af'};

async function init() {
  await sb.requireAuth();
  if (sb.getCurrentProfile()?.role !== 'admin') {
    document.querySelector('.page-content').innerHTML = '<div class="alert alert-danger" style="max-width:500px">Solo gli amministratori possono accedere.</div>';
    return;
  }
  loadUsers();
}

async function loadUsers() {
  try {
    const profiles = await sb.db.select('profiles', { columns: 'id,full_name,role,created_at', order: 'created_at.asc' }) || [];
    const myId = sb.getCurrentProfile()?.id;
    document.getElementById('users-list').innerHTML = profiles.map(p => `
      <div class="user-card">
        <div class="u-av" style="background:${ROLE_COLORS[p.role]||'#9ca3af'}">${(p.full_name||'?').substring(0,2).toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700">${ui.escapeHtml(p.full_name)} ${p.id===myId?'<span style="font-size:11px;color:var(--text-muted)">(tu)</span>':''}</div>
          <div style="font-size:12px;color:var(--text-muted)">Creato ${ui.formatDate(p.created_at)}</div>
        </div>
        <span class="role-badge rb-${p.role}">${ROLE_LABELS[p.role]||p.role}</span>
        <button class="btn btn-ghost btn-sm" onclick="openEdit('${p.id}','${ui.escapeHtml(p.full_name)}','${p.role}')">‚úé Modifica</button>
        ${p.id !== myId ? `<button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="deleteUser('${p.id}','${ui.escapeHtml(p.full_name)}')">üóë</button>` : ''}
      </div>`).join('');
  } catch(e) {
    document.getElementById('users-list').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function openNew() {
  editingId = null;
  document.getElementById('modal-title').textContent = '+ Nuovo Utente';
  document.getElementById('u-name').value = '';
  document.getElementById('u-email').value = '';
  document.getElementById('u-pwd').value = '';
  document.getElementById('u-role').value = 'junior';
  document.getElementById('email-group').style.display = 'block';
  document.getElementById('pwd-group').style.display = 'block';
  document.getElementById('newpwd-group').style.display = 'none';
  document.getElementById('btn-save').textContent = 'Crea Utente';
  document.getElementById('modal-user').style.display = 'flex';
}

function openEdit(id, name, role) {
  editingId = id;
  document.getElementById('modal-title').textContent = '‚úé Modifica Utente';
  document.getElementById('u-name').value = name;
  document.getElementById('u-role').value = role;
  document.getElementById('email-group').style.display = 'none';
  document.getElementById('pwd-group').style.display = 'none';
  document.getElementById('newpwd-group').style.display = 'block';
  document.getElementById('u-newpwd').value = '';
  document.getElementById('btn-save').textContent = 'Salva';
  document.getElementById('modal-user').style.display = 'flex';
}

function closeModal() { document.getElementById('modal-user').style.display = 'none'; }

async function saveUser() {
  const btn = document.getElementById('btn-save');
  btn.disabled = true; btn.textContent = '...';
  try {
    if (editingId) {
      // Update name + role
      await sb.db.update('profiles', `id=eq.${editingId}`, {
        full_name: document.getElementById('u-name').value.trim(),
        role: document.getElementById('u-role').value
      });
      // Change password if provided
      const newPwd = document.getElementById('u-newpwd').value;
      if (newPwd) {
        if (newPwd.length < 6) throw new Error('Password minimo 6 caratteri');
        const r = await fetch('/api/update-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sb.getSession()?.access_token },
          body: JSON.stringify({ userId: editingId, password: newPwd })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'Errore cambio password');
      }
      ui.showToast('Utente aggiornato ‚úì', 'success');
    } else {
      const name = document.getElementById('u-name').value.trim();
      const email = document.getElementById('u-email').value.trim();
      const pwd = document.getElementById('u-pwd').value;
      const role = document.getElementById('u-role').value;
      if (!name || !email || !pwd) throw new Error('Compila tutti i campi');
      if (pwd.length < 8) throw new Error('Password minimo 8 caratteri');

      const r = await fetch('/api/create-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sb.getSession()?.access_token },
        body: JSON.stringify({ email, password: pwd, full_name: name, role })
      });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'Errore creazione utente');
      ui.showToast(`Utente ${name} creato ‚úì`, 'success');
    }
    closeModal();
    await loadUsers();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = editingId ? 'Salva' : 'Crea Utente'; }
}

async function deleteUser(id, name) {
  if (!confirm(`Eliminare "${name}"?`)) return;
  try {
    const r = await fetch('/api/delete-user', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sb.getSession()?.access_token },
      body: JSON.stringify({ userId: id })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Errore eliminazione');
    ui.showToast('Utente eliminato', 'success');
    await loadUsers();
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
}

function openChangePwd() {
  document.getElementById('new-pwd').value = '';
  document.getElementById('confirm-pwd').value = '';
  document.getElementById('modal-pwd').style.display = 'flex';
}

async function changePassword() {
  const pwd = document.getElementById('new-pwd').value;
  const conf = document.getElementById('confirm-pwd').value;
  if (!pwd) { ui.showToast('Inserisci la nuova password', 'error'); return; }
  if (pwd !== conf) { ui.showToast('Le password non coincidono', 'error'); return; }
  if (pwd.length < 6) { ui.showToast('Minimo 6 caratteri', 'error'); return; }
  const btn = document.getElementById('btn-pwd');
  btn.disabled = true; btn.textContent = '...';
  try {
    const userId = sb.getCurrentUser()?.id;
    const r = await fetch('/api/update-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sb.getSession()?.access_token },
      body: JSON.stringify({ userId, password: pwd })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Errore');
    document.getElementById('modal-pwd').style.display = 'none';
    ui.showToast('Password cambiata ‚úì ‚Äî effettua il login di nuovo', 'success');
    setTimeout(() => sb.signOut(), 2000);
  } catch(e) { ui.showToast('Errore: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = 'Salva Password'; }
}

init();
</script>
</body>
</html>
