<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utenti ‚Äî InDubai Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/config.js"></script>
  <style>
    .user-card { background: white; border: 1.5px solid var(--border); border-radius: 12px; padding: 20px 24px; display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
    .u-avatar { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; color: white; flex-shrink: 0; }
    .u-name { font-size: 15px; font-weight: 700; color: var(--text-primary); }
    .u-email { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .role-badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .rb-admin { background: #1a3a5c; color: white; }
    .rb-mini_admin { background: #c9a84c; color: #1a3a5c; }
    .rb-senior { background: #dbeafe; color: #1d4ed8; }
    .rb-junior { background: #f3f4f6; color: #6b7280; }
    .rb-staff { background: #f3f4f6; color: #6b7280; }
    .sql-box { background: #1e293b; color: #e2e8f0; border-radius: 10px; padding: 16px; font-family: monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-all; margin: 12px 0; }
    .step-badge { background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; flex-shrink: 0; }
  </style>
</head>
<body>
<div class="app-layout">
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-title">Gestione Utenti</div>
      <div class="topbar-actions">
        <button class="btn btn-accent" onclick="openNewUser()">+ Nuovo Utente</button>
      </div>
    </div>
    <div class="page-content">
      <div style="max-width:720px">

        <!-- Change my password -->
        <div class="card" style="margin-bottom:20px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:14px;font-weight:700">üîê La mia password</div>
            <div style="font-size:12px;color:var(--text-muted)">Cambia la tua password di accesso</div>
          </div>
          <button class="btn btn-ghost" onclick="document.getElementById('modal-pwd').style.display='flex'">Cambia Password</button>
        </div>

        <div id="users-list"><div class="loading-overlay"><div class="spinner"></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- New User Modal - SQL approach -->
<div class="modal-overlay" id="modal-user" style="display:none">
  <div class="modal" style="max-width:580px">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">+ Nuovo Utente</div>
      <button class="btn btn-ghost btn-sm" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body">
      <div id="form-step">
        <div class="form-group">
          <label class="form-label">Nome Completo *</label>
          <input type="text" class="form-control" id="u-name" placeholder="Es. Mario Rossi">
        </div>
        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" class="form-control" id="u-email" placeholder="mario@indubai.it">
        </div>
        <div class="form-group">
          <label class="form-label">Password *</label>
          <input type="password" class="form-control" id="u-password" placeholder="Min 8 caratteri">
        </div>
        <div class="form-group">
          <label class="form-label">Ruolo</label>
          <select class="form-control" id="u-role">
            <option value="junior">Contabilit√† Junior</option>
            <option value="senior">Contabilit√† Senior</option>
            <option value="mini_admin">Mini Admin</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div id="sql-step" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:12px 14px;background:#f0fdf4;border-radius:8px;border:1px solid #86efac">
          <span style="font-size:18px">‚úÖ</span>
          <div style="font-size:13px;color:#166534;font-weight:600">SQL generato ‚Äî copialo ed eseguilo nel SQL Editor di Supabase</div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px">
          <span class="step-badge">1</span>
          <div style="flex:1;font-size:13px;color:var(--text-secondary)">Copia questo SQL ed eseguilo nel <a href="https://supabase.com/dashboard/project/gvdoqcgkzbziqufahhxh/sql/new" target="_blank" style="color:var(--primary);font-weight:600">SQL Editor ‚Üí</a></div>
        </div>
        <div class="sql-box" id="sql-output"></div>
        <button class="btn btn-accent" style="width:100%" onclick="copySQL()">üìã Copia SQL</button>
        <div style="margin-top:12px;padding:10px 14px;background:#fef9ec;border-radius:8px;font-size:12px;color:#92400e;border:1px solid #fcd34d">
          <strong>‚ö† Dopo aver eseguito il SQL:</strong> torna qui e clicca "Fatto, ricarica utenti" per aggiornare la lista.
        </div>
      </div>
    </div>
    <div class="modal-footer" id="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Annulla</button>
      <button class="btn btn-accent" id="btn-next" onclick="generateSQL()">Genera SQL ‚Üí</button>
    </div>
  </div>
</div>

<!-- Edit role modal -->
<div class="modal-overlay" id="modal-edit" style="display:none">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <div class="modal-title">‚úé Modifica Ruolo</div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-edit').style.display='none'">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="font-size:14px;font-weight:600;margin-bottom:16px" id="edit-name-label"></div>
      <div class="form-group">
        <label class="form-label">Ruolo</label>
        <select class="form-control" id="edit-role">
          <option value="junior">Contabilit√† Junior</option>
          <option value="senior">Contabilit√† Senior</option>
          <option value="mini_admin">Mini Admin</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-edit').style.display='none'">Annulla</button>
      <button class="btn btn-accent" onclick="saveRole()">Salva</button>
    </div>
  </div>
</div>

<!-- Change password modal -->
<div class="modal-overlay" id="modal-pwd" style="display:none">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">üîê Cambia Password</div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-pwd').style.display='none'">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="pwd-form-step">
        <div class="form-group">
          <label class="form-label">Nuova Password *</label>
          <input type="password" class="form-control" id="new-pwd" placeholder="Min 6 caratteri">
        </div>
        <div class="form-group">
          <label class="form-label">Conferma *</label>
          <input type="password" class="form-control" id="confirm-pwd">
        </div>
      </div>
      <div id="pwd-sql-step" style="display:none">
        <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary)">Esegui questo SQL nel <a href="https://supabase.com/dashboard/project/gvdoqcgkzbziqufahhxh/sql/new" target="_blank" style="color:var(--primary);font-weight:600">SQL Editor ‚Üí</a> poi fai logout e login con la nuova password.</div>
        <div class="sql-box" id="pwd-sql-output"></div>
        <button class="btn btn-accent" style="width:100%;margin-top:8px" onclick="copyPwdSQL()">üìã Copia SQL</button>
      </div>
    </div>
    <div class="modal-footer" id="pwd-modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-pwd').style.display='none'">Annulla</button>
      <button class="btn btn-accent" id="btn-gen-pwd" onclick="generatePwdSQL()">Genera SQL ‚Üí</button>
    </div>
  </div>
</div>

<script src="/js/supabase.js"></script>
<script src="/js/app.js"></script>
<script>
let editingProfileId = null;
const roleLabels = {admin:'Admin',mini_admin:'Mini Admin',senior:'Contabilit√† Senior',junior:'Contabilit√† Junior',staff:'Staff'};
const roleColors = {admin:'#1a3a5c',mini_admin:'#c9a84c',senior:'#2563a8',junior:'#6b7280',staff:'#9ca3af'};

async function init() {
  await sb.requireAuth();
  const profile = sb.getCurrentProfile();
  if (profile?.role !== 'admin') {
    document.querySelector('.page-content').innerHTML = '<div class="alert alert-danger" style="max-width:500px">Solo gli amministratori possono gestire gli utenti.</div>';
    return;
  }
  await loadUsers();
}

async function loadUsers() {
  try {
    const profiles = await sb.db.select('profiles', {columns:'id,full_name,role,created_at', order:'created_at.asc'}) || [];
    const myId = sb.getCurrentProfile()?.id;
    document.getElementById('users-list').innerHTML = profiles.map(p => `
      <div class="user-card">
        <div class="u-avatar" style="background:${roleColors[p.role]||'#6b7a95'}">${(p.full_name||'?').substring(0,2).toUpperCase()}</div>
        <div style="flex:1">
          <div class="u-name">${ui.escapeHtml(p.full_name)} ${p.id===myId?'<span style="font-size:11px;color:var(--text-muted)">(tu)</span>':''}</div>
          <div class="u-email">${ui.formatDate(p.created_at)}</div>
        </div>
        <span class="role-badge rb-${p.role}">${roleLabels[p.role]||p.role}</span>
        <button class="btn btn-ghost btn-sm" onclick="openEditRole('${p.id}','${ui.escapeHtml(p.full_name)}','${p.role}')">‚úé</button>
        ${p.id !== myId ? `<button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5" onclick="confirmDelete('${p.id}','${ui.escapeHtml(p.full_name)}')">üóë</button>` : ''}
      </div>`).join('') +
      `<div style="text-align:center;margin-top:16px">
        <button class="btn btn-ghost btn-sm" onclick="loadUsers()">‚Üª Ricarica lista</button>
      </div>`;
  } catch(e) {
    document.getElementById('users-list').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
  }
}

function openNewUser() {
  document.getElementById('form-step').style.display = 'block';
  document.getElementById('sql-step').style.display = 'none';
  document.getElementById('btn-next').style.display = '';
  document.getElementById('btn-next').textContent = 'Genera SQL ‚Üí';
  document.getElementById('u-name').value = '';
  document.getElementById('u-email').value = '';
  document.getElementById('u-password').value = '';
  document.getElementById('modal-user').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal-user').style.display = 'none';
}

function generateSQL() {
  const name = document.getElementById('u-name').value.trim();
  const email = document.getElementById('u-email').value.trim();
  const pwd = document.getElementById('u-password').value;
  const role = document.getElementById('u-role').value;

  if (!name || !email || !pwd) { ui.showToast('Compila tutti i campi','error'); return; }
  if (pwd.length < 8) { ui.showToast('Password minimo 8 caratteri','error'); return; }

  const newId = 'bbbbbbbb-' + Math.random().toString(36).substring(2,6) + '-0000-0000-' + Date.now().toString(16).padStart(12,'0');

  const sql = `-- Crea utente: ${name}
INSERT INTO auth.users (
  instance_id, id, aud, role, email,
  encrypted_password, email_confirmed_at,
  raw_app_meta_data, raw_user_meta_data,
  created_at, updated_at,
  confirmation_token, recovery_token,
  email_change_token_new, email_change
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  '${newId}',
  'authenticated', 'authenticated',
  '${email}',
  crypt('${pwd}', gen_salt('bf')),
  now(),
  '{"provider":"email","providers":["email"]}'::jsonb,
  '{"full_name":"${name}"}'::jsonb,
  now(), now(), '', '', '', ''
);

-- Imposta ruolo corretto (il trigger crea 'staff' di default)
UPDATE profiles SET role = '${role}', full_name = '${name}'
WHERE id = '${newId}';`;

  document.getElementById('sql-output').textContent = sql;
  document.getElementById('form-step').style.display = 'none';
  document.getElementById('sql-step').style.display = 'block';
  document.getElementById('btn-next').textContent = '‚úì Fatto, ricarica utenti';
  document.getElementById('btn-next').onclick = () => { closeModal(); loadUsers(); };
}

function copySQL() {
  const sql = document.getElementById('sql-output').textContent;
  navigator.clipboard.writeText(sql).then(() => ui.showToast('SQL copiato!','success'));
}

function openEditRole(id, name, currentRole) {
  editingProfileId = id;
  document.getElementById('edit-name-label').textContent = 'üë§ ' + name;
  document.getElementById('edit-role').value = currentRole;
  document.getElementById('modal-edit').style.display = 'flex';
}

async function saveRole() {
  try {
    const role = document.getElementById('edit-role').value;
    await sb.db.update('profiles', `id=eq.${editingProfileId}`, {role});
    document.getElementById('modal-edit').style.display = 'none';
    ui.showToast('Ruolo aggiornato ‚úì','success');
    await loadUsers();
  } catch(e) { ui.showToast('Errore: '+e.message,'error'); }
}

async function confirmDelete(id, name) {
  if (!confirm(`Eliminare "${name}"? Questa azione √® irreversibile.`)) return;
  // Generate SQL to delete - can't do it from frontend easily
  const sql = `-- Elimina utente ${name}\nDELETE FROM auth.users WHERE id = '${id}';`;
  const win = window.open('https://supabase.com/dashboard/project/gvdoqcgkzbziqufahhxh/sql/new', '_blank');
  await navigator.clipboard.writeText(sql);
  ui.showToast('SQL copiato! Incollalo nel SQL Editor appena aperto','success');
}

// Password change via SQL
function generatePwdSQL() {
  const pwd = document.getElementById('new-pwd').value;
  const confirm = document.getElementById('confirm-pwd').value;
  if (!pwd) { ui.showToast('Inserisci la nuova password','error'); return; }
  if (pwd !== confirm) { ui.showToast('Le password non coincidono','error'); return; }
  if (pwd.length < 6) { ui.showToast('Minimo 6 caratteri','error'); return; }

  const userId = sb.getCurrentUser()?.id;
  const sql = `-- Cambia password utente corrente\nUPDATE auth.users\nSET encrypted_password = crypt('${pwd}', gen_salt('bf'))\nWHERE id = '${userId}';`;

  document.getElementById('pwd-sql-output').textContent = sql;
  document.getElementById('pwd-form-step').style.display = 'none';
  document.getElementById('pwd-sql-step').style.display = 'block';
  document.getElementById('btn-gen-pwd').style.display = 'none';
}

function copyPwdSQL() {
  navigator.clipboard.writeText(document.getElementById('pwd-sql-output').textContent)
    .then(() => ui.showToast('SQL copiato!','success'));
}

init();
</script>
</body>
</html>
