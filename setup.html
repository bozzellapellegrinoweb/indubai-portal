<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InDubai Portal — Setup DB</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,sans-serif;background:#1a3a5c;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{background:white;border-radius:16px;padding:40px;max-width:680px;width:100%}
    h1{font-size:24px;font-weight:800;color:#1a3a5c;margin-bottom:4px}
    .sub{color:#c9a84c;font-weight:700;font-size:13px;margin-bottom:28px}
    .section{border:1px solid #dde3ed;border-radius:10px;margin-bottom:16px;overflow:hidden}
    .section-header{background:#f0f4f8;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .section-num{width:28px;height:28px;border-radius:50%;background:#1a3a5c;color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
    .section-num.done{background:#16a34a}
    .section-title{font-size:14px;font-weight:700;flex:1}
    .section-status{font-size:12px;color:#6b7a95}
    .section-body{padding:16px 18px;border-top:1px solid #dde3ed}
    .step-desc{font-size:13px;color:#6b7a95;margin-bottom:12px;line-height:1.6}
    .link-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;text-decoration:none;background:#1a3a5c;color:white;margin-right:8px;margin-bottom:8px}
    .link-btn.secondary{background:#f0f4f8;color:#1a3a5c;border:1px solid #dde3ed}
    .link-btn:hover{opacity:0.85}
    .confirm-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid #16a34a;background:#dcfce7;color:#16a34a;margin-top:8px}
    .confirm-btn:hover{background:#16a34a;color:white}
    .auto-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;background:#c9a84c;color:#1a3a5c;margin-top:4px}
    .auto-btn:hover{background:#f0d080}
    .auto-btn:disabled{opacity:0.5;cursor:not-allowed}
    .result{margin-top:10px;padding:10px 14px;border-radius:8px;font-size:13px;display:none}
    .result.ok{background:#dcfce7;color:#16a34a}
    .result.err{background:#fee2e2;color:#dc2626}
    .creds{background:#f0f4f8;border-radius:10px;padding:20px;margin-top:20px;display:none}
    .creds h3{font-size:14px;font-weight:700;color:#1a3a5c;margin-bottom:12px}
    .cred{display:flex;gap:10px;margin-bottom:8px}
    .ck{color:#6b7a95;font-size:12px;width:90px}.cv{font-weight:700;font-family:monospace;font-size:12px}
    .btn-final{display:inline-flex;padding:12px 28px;border-radius:10px;font-size:14px;font-weight:700;text-decoration:none;background:#16a34a;color:white;margin-top:16px}
    code{background:#f0f4f8;padding:2px 6px;border-radius:4px;font-size:12px;font-family:monospace}
  </style>
</head>
<body>
<div class="card">
  <h1>InDubai Portal</h1>
  <div class="sub">⚙ Setup Database — esegui una sola volta</div>

  <!-- STEP 1: Schema -->
  <div class="section">
    <div class="section-header">
      <div class="section-num" id="n1">1</div>
      <div class="section-title">Esegui Schema SQL (tabelle, trigger, views)</div>
      <div class="section-status" id="st1">Da fare</div>
    </div>
    <div class="section-body">
      <div class="step-desc">
        Apri il SQL Editor di Supabase, copia il contenuto di <code>schema.sql</code> e clicca Run.
      </div>
      <a href="https://supabase.com/dashboard/project/gvdoqcgkzbziqufahhxh/sql/new" target="_blank" class="link-btn">→ Apri SQL Editor</a>
      <a href="https://raw.githubusercontent.com/bozzellapellegrinoweb/indubai-portal/main/supabase/schema.sql" target="_blank" class="link-btn secondary">↓ schema.sql (raw)</a>
      <br>
      <button class="confirm-btn" onclick="confirmStep(1)">✓ Ho eseguito schema.sql</button>
    </div>
  </div>

  <!-- STEP 2: Seed -->
  <div class="section">
    <div class="section-header">
      <div class="section-num" id="n2">2</div>
      <div class="section-title">Esegui Seed SQL (97 clienti + dati 2026)</div>
      <div class="section-status" id="st2">Da fare</div>
    </div>
    <div class="section-body">
      <div class="step-desc">
        Stesso SQL Editor — nuova query. Copia <code>seed_data.sql</code> e clicca Run.<br>
        <strong>Attenzione:</strong> il file è 113KB, potrebbe impiegare 10-20 secondi.
      </div>
      <a href="https://supabase.com/dashboard/project/gvdoqcgkzbziqufahhxh/sql/new" target="_blank" class="link-btn">→ Apri SQL Editor</a>
      <a href="https://raw.githubusercontent.com/bozzellapellegrinoweb/indubai-portal/main/supabase/seed_data.sql" target="_blank" class="link-btn secondary">↓ seed_data.sql (raw)</a>
      <br>
      <button class="confirm-btn" onclick="confirmStep(2)">✓ Ho eseguito seed_data.sql</button>
    </div>
  </div>

  <!-- STEP 3: Users (auto) -->
  <div class="section">
    <div class="section-header">
      <div class="section-num" id="n3">3</div>
      <div class="section-title">Crea utenti admin (automatico)</div>
      <div class="section-status" id="st3">Da fare</div>
    </div>
    <div class="section-body">
      <div class="step-desc">
        Crea automaticamente <strong>pellegrino@indubai.it</strong> e <strong>giuseppe@indubai.it</strong> come admin.
        Clicca il pulsante quando i passi 1 e 2 sono completati.
      </div>
      <button class="auto-btn" id="btn-users" onclick="createUsers()">⚡ Crea Utenti Automaticamente</button>
      <div class="result" id="res3"></div>
    </div>
  </div>

  <div class="creds" id="creds">
    <h3>✅ Setup completato! Credenziali di accesso:</h3>
    <div class="cred"><span class="ck">URL:</span><span class="cv">indubai-portal.vercel.app</span></div>
    <div class="cred"><span class="ck">Pellegrino:</span><span class="cv">pellegrino@indubai.it</span></div>
    <div class="cred"><span class="ck">Giuseppe:</span><span class="cv">giuseppe@indubai.it</span></div>
    <div class="cred"><span class="ck">Password:</span><span class="cv">InDubai2026!</span></div>
    <a href="/login.html" class="btn-final">→ Vai al Portale</a>
  </div>
</div>

<script>
const SK = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2ZG9xY2dremJ6aXF1ZmFoaHhoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MjAzMjA1MSwiZXhwIjoyMDg3NjA4MDUxfQ.oEzS7iIAiRW3pYjL-TwXtY4ZOwKwh4L8JZZ6Ztq6RgQ';
const URL = 'https://gvdoqcgkzbziqufahhxh.supabase.co';

let done = {1: false, 2: false, 3: false};

function confirmStep(n) {
  done[n] = true;
  document.getElementById('n'+n).textContent = '✓';
  document.getElementById('n'+n).style.background = '#16a34a';
  document.getElementById('st'+n).textContent = '✅ Fatto';
  document.getElementById('st'+n).style.color = '#16a34a';
  checkAll();
}

function checkAll() {
  if (done[1] && done[2] && done[3]) {
    document.getElementById('creds').style.display = 'block';
    document.getElementById('creds').scrollIntoView({behavior:'smooth'});
  }
}

async function createUsers() {
  const btn = document.getElementById('btn-users');
  const res = document.getElementById('res3');
  btn.disabled = true;
  btn.textContent = '⟳ Creazione in corso...';
  res.style.display = 'none';

  const users = [
    {email: 'pellegrino@indubai.it', name: 'Pellegrino Bozzella'},
    {email: 'giuseppe@indubai.it', name: 'Giuseppe'},
  ];

  try {
    for (const u of users) {
      const r = await fetch(URL + '/auth/v1/admin/users', {
        method: 'POST',
        headers: {
          'apikey': SK,
          'Authorization': 'Bearer ' + SK,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: u.email,
          password: 'InDubai2026!',
          email_confirm: true,
          user_metadata: {full_name: u.name, role: 'admin'}
        })
      });
      const d = await r.json();
      if (d.id) {
        // Update profile role
        await fetch(URL + '/rest/v1/profiles?id=eq.' + d.id, {
          method: 'PATCH',
          headers: {
            'apikey': SK, 'Authorization': 'Bearer ' + SK,
            'Content-Type': 'application/json', 'Prefer': 'return=minimal'
          },
          body: JSON.stringify({role: 'admin', full_name: u.name})
        });
      }
      // If already exists (422) that's fine
    }

    res.className = 'result ok';
    res.textContent = '✅ pellegrino@indubai.it e giuseppe@indubai.it creati con password InDubai2026!';
    res.style.display = 'block';
    btn.textContent = '✓ Utenti creati';
    confirmStep(3);

  } catch(e) {
    res.className = 'result err';
    res.textContent = '❌ Errore: ' + e.message;
    res.style.display = 'block';
    btn.disabled = false;
    btn.textContent = '↺ Riprova';
  }
}
</script>
</body>
</html>
